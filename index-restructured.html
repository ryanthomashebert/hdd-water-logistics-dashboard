<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MBTC Mission Control - HDD Water Logistics | Planning to Operations Platform</title>

  <!-- Google Fonts - Editorial/Industrial Typography -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Work+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            display: ['Bebas Neue', 'system-ui', 'sans-serif'],
            sans: ['Work Sans', 'system-ui', 'sans-serif'],
            mono: ['IBM Plex Mono', 'monospace']
          },
          colors: {
            /* WHC Brand Colors - Primary */
            whc: {
              navy: '#1e3a5f',        // Primary brand navy
              'navy-dark': '#152d47', // Darker navy for depth
              'navy-light': '#2d4f7c', // Lighter navy for accents
              'navy-pale': '#4a6b96',  // Pale navy for backgrounds
              'navy-muted': '#6b8bb3', // Muted navy for inactive states
              crimson: '#d94545',      // Primary brand red
              'crimson-dark': '#b83939', // Darker crimson
              'crimson-light': '#e05d5d', // Lighter crimson
              'crimson-pale': '#f08080', // Pale crimson/coral
              'crimson-muted': '#c97575' // Muted crimson
            },
            /* Derived Functional Colors */
            primary: {
              DEFAULT: '#1e3a5f',  // Navy for primary actions
              light: '#2d4f7c',    // Light navy
              dark: '#152d47',     // Dark navy
              bg: '#e8eef5'        // Navy-tinted background
            },
            accent: {
              DEFAULT: '#d94545',  // Crimson for emphasis
              light: '#e05d5d',    // Light crimson
              dark: '#b83939',     // Dark crimson
              bg: '#fce8e8'        // Crimson-tinted background
            },
            /* Status Colors - Navy/Crimson Tinted */
            success: {
              DEFAULT: '#3d7068',  // Navy-tinted teal (not bright green)
              light: '#5a9d92',    // Light success
              bg: '#e6f3f1'        // Success background
            },
            warning: {
              DEFAULT: '#c97575',  // Muted crimson (not bright orange)
              light: '#e09090',    // Light warning
              bg: '#fdf0f0'        // Warning background
            },
            error: {
              DEFAULT: '#b83939',  // Dark crimson
              light: '#d94545',    // Crimson
              bg: '#fce8e8'        // Error background
            },
            info: {
              DEFAULT: '#4a6b96',  // Pale navy
              light: '#6b8bb3',    // Muted navy
              bg: '#e8eef5'        // Info background
            },
            /* Light Theme Backgrounds */
            bg: {
              cream: '#f5f3ef',
              white: '#ffffff',
              light: '#faf9f7',
              muted: '#eae8e4',
              'navy-tint': '#e8eef5',     // Navy-tinted bg
              'crimson-tint': '#fce8e8'   // Crimson-tinted bg
            },
            /* Text Colors */
            text: {
              black: '#1a1a1a',
              dark: '#2d2d2d',
              medium: '#5a5a5a',
              light: '#8a8a8a',
              navy: '#1e3a5f',      // Navy text
              crimson: '#d94545'    // Crimson text
            },
            /* Borders */
            border: {
              black: '#1a1a1a',
              light: '#d4d4d4',
              navy: '#2d4f7c',      // Navy borders
              crimson: '#d94545'    // Crimson borders
            }
          },
          borderRadius: {
            'card': '16px',
            'btn': '8px',
            'panel': '16px'
          },
          boxShadow: {
            'card': '4px 4px 0 #1a1a1a',
            'card-hover': '6px 6px 0 #1a1a1a',
            'panel': '0 2px 8px rgba(0, 0, 0, 0.1)'
          }
        }
      }
    }
  </script>

  <!-- React -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Recharts dependencies -->
  <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
  <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>

  <!-- Route Data - MUST load before Babel script -->
  <script src="route-data.js"></script>
  <script>
    // Verify route data loaded
    if (typeof MULTI_SOURCE_ROUTES !== 'undefined') {
      console.log('✓ Route data loaded successfully');
      console.log('  Sources:', Object.keys(MULTI_SOURCE_ROUTES));
      console.log('  Sample routes for source1:', Object.keys(MULTI_SOURCE_ROUTES.source1?.routes || {}));
      window.MULTI_SOURCE_ROUTES = MULTI_SOURCE_ROUTES;
    } else {
      console.error('✗ MULTI_SOURCE_ROUTES not loaded! Check route-data.js file.');
    }
  </script>

  <!-- Babel for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    /* ================================================================
       GRUNGY INDUSTRIAL THEME
       Editorial Magazine Style with WHC+ONEOK Brand Colors
       ================================================================ */

    :root {
      /* OPTION 2: BALANCED DUO PALETTE */
      /* Core 7 Colors */
      --color-1-deep-navy: #1e3a5f;      /* Primary headers, main brand */
      --color-2-ocean-blue: #3d5a7f;     /* Interactive elements, links, tabs */
      --color-3-crimson: #d94545;        /* Active states, emphasis */
      --color-4-soft-crimson: #c97575;   /* Warnings, secondary alerts */
      --color-5-blue-gray: #546e7a;      /* Body text, neutral elements */
      --color-6-silver: #b0bec5;         /* Disabled states, subtle borders */
      --color-7-pearl: #eceff1;          /* Canvas background, light surfaces */

      /* WHC Brand Colors - Mapped to Palette */
      --whc-navy: #1e3a5f;               /* Color 1 */
      --whc-navy-dark: #1e3a5f;          /* Color 1 */
      --whc-navy-light: #3d5a7f;         /* Color 2 */
      --whc-navy-pale: #3d5a7f;          /* Color 2 */
      --whc-navy-muted: #546e7a;         /* Color 5 */
      --whc-crimson: #d94545;            /* Color 3 */
      --whc-crimson-dark: #d94545;       /* Color 3 */
      --whc-crimson-light: #c97575;      /* Color 4 */
      --whc-crimson-pale: #c97575;       /* Color 4 */
      --whc-crimson-muted: #c97575;      /* Color 4 */

      /* Functional Colors - Mapped to Palette */
      --primary: #1e3a5f;                /* Color 1: Deep Navy */
      --primary-light: #3d5a7f;          /* Color 2: Ocean Blue */
      --primary-dark: #1e3a5f;           /* Color 1: Deep Navy */
      --primary-bg: #eceff1;             /* Color 7: Pearl */

      --accent: #d94545;                 /* Color 3: Crimson */
      --accent-light: #c97575;           /* Color 4: Soft Crimson */
      --accent-dark: #d94545;            /* Color 3: Crimson */
      --accent-bg: #eceff1;              /* Color 7: Pearl */

      /* Status Colors - Mapped to Palette */
      --success: #3d5a7f;                /* Color 2: Ocean Blue */
      --success-light: #546e7a;          /* Color 5: Blue Gray */
      --success-bg: #eceff1;             /* Color 7: Pearl */

      --warning: #c97575;                /* Color 4: Soft Crimson */
      --warning-light: #c97575;          /* Color 4: Soft Crimson */
      --warning-bg: #eceff1;             /* Color 7: Pearl */

      --error: #d94545;                  /* Color 3: Crimson */
      --error-light: #c97575;            /* Color 4: Soft Crimson */
      --error-bg: #eceff1;               /* Color 7: Pearl */

      --info: #3d5a7f;                   /* Color 2: Ocean Blue */
      --info-light: #546e7a;             /* Color 5: Blue Gray */
      --info-bg: #eceff1;                /* Color 7: Pearl */

      /* Legacy aliases for compatibility */
      --whc-red: #d94545;                /* Color 3 */
      --secondary-accent: #d94545;       /* Color 3 */
      --header-dark: #1e3a5f;            /* Color 1 */
      --navy-dark: #1e3a5f;              /* Color 1 */
      --primary-accent: #3d5a7f;         /* Color 2 */
      --accent-blue: #3d5a7f;            /* Color 2 */
      --cyber-cyan: #3d5a7f;             /* Color 2 */
      --oneok-blue: #3d5a7f;             /* Color 2 */
      --oneok-cyan: #3d5a7f;             /* Color 2 */
      --oneok-black: #546e7a;            /* Color 5 */

      /* Light Theme Backgrounds */
      --bg-cream: #eceff1;               /* Color 7: Pearl */
      --bg-white: #ffffff;
      --bg-light: #eceff1;               /* Color 7: Pearl */
      --bg-muted: #b0bec5;               /* Color 6: Silver */
      --bg-navy-tint: #eceff1;           /* Color 7: Pearl */
      --bg-crimson-tint: #eceff1;        /* Color 7: Pearl */

      /* Text Colors */
      --text-black: #546e7a;             /* Color 5: Blue Gray */
      --text-dark: #546e7a;              /* Color 5: Blue Gray */
      --text-medium: #546e7a;            /* Color 5: Blue Gray */
      --text-light: #b0bec5;             /* Color 6: Silver */
      --text-navy: #1e3a5f;              /* Color 1: Deep Navy */
      --text-crimson: #d94545;           /* Color 3: Crimson */

      /* Status Colors - Legacy (mapped to Palette) */
      --status-green: #3d5a7f;           /* Color 2: Ocean Blue */
      --status-orange: #c97575;          /* Color 4: Soft Crimson */
      --status-red: #d94545;             /* Color 3: Crimson */

      /* Borders */
      --border-black: #546e7a;           /* Color 5: Blue Gray */
      --border-light: #b0bec5;           /* Color 6: Silver */
      --border-subtle: #b0bec5;          /* Color 6: Silver */
      --border-navy: #1e3a5f;            /* Color 1: Deep Navy */
      --border-crimson: #d94545;         /* Color 3: Crimson */

      /* Card Properties */
      --card-radius: 16px;
      --panel-radius: 16px;
      --btn-radius: 8px;
    }

    * {
      font-family: 'Work Sans', system-ui, sans-serif;
      box-sizing: border-box;
    }

    body {
      background: var(--bg-cream);
      color: var(--text-black);
      margin: 0;
      padding: 0;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow-x: hidden;
    }

    /* Subtle dot pattern background */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: radial-gradient(var(--border-light) 1px, transparent 1px);
      background-size: 20px 20px;
      pointer-events: none;
      z-index: 0;
      opacity: 0.5;
    }

    /* Remove scan line effect */
    body::after {
      display: none;
    }

    /* ================================================================
       TYPOGRAPHY - Editorial Style
       ================================================================ */
    .section-title {
      font-family: 'Bebas Neue', system-ui, sans-serif;
      font-size: 1.5rem;
      font-weight: 400;
      color: var(--text-black);
      letter-spacing: 0.1em;
      text-transform: uppercase;
      line-height: 1.2;
    }

    .section-label {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.65rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: var(--text-medium);
    }

    .data-value {
      font-family: 'Bebas Neue', sans-serif;
      font-weight: 400;
      color: var(--text-black);
    }

    /* ================================================================
       FORM ELEMENTS - Grungy Style
       ================================================================ */
    .input-field {
      width: 100%;
      padding: 12px 16px;
      font-size: 0.875rem;
      font-family: 'IBM Plex Mono', monospace;
      border: 2px solid var(--border-black);
      border-radius: var(--btn-radius);
      background: var(--bg-white);
      color: var(--text-black);
      transition: all 0.2s ease;
    }

    .input-field:focus {
      outline: none;
      border-color: var(--primary-accent);
      box-shadow: 4px 4px 0 var(--border-black);
      background: var(--bg-white);
    }

    .btn-primary {
      padding: 14px 28px;
      font-size: 0.9rem;
      font-family: 'Bebas Neue', sans-serif;
      font-weight: 400;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: #ffffff;
      background: var(--primary-accent);
      border: 2px solid var(--border-black);
      border-radius: var(--btn-radius);
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      box-shadow: 4px 4px 0 var(--border-black);
    }

    .btn-primary:hover:not(:disabled) {
      transform: translate(-2px, -2px);
      box-shadow: 6px 6px 0 var(--border-black);
    }

    .btn-primary:active:not(:disabled) {
      transform: translate(2px, 2px);
      box-shadow: 2px 2px 0 var(--border-black);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-secondary {
      padding: 12px 24px;
      font-size: 0.8rem;
      font-family: 'Work Sans', sans-serif;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-black);
      background: var(--bg-white);
      border: 2px solid var(--border-black);
      border-radius: var(--btn-radius);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-secondary:hover {
      background: var(--primary-accent);
      color: #ffffff;
      transform: translate(-2px, -2px);
      box-shadow: 4px 4px 0 var(--border-black);
    }

    /* ================================================================
       SIDEBAR - Editorial Style
       ================================================================ */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: 300px;
      overflow-y: auto;
      background: var(--bg-white);
      z-index: 70;
      border-right: 2px solid var(--border-black);
    }

    .sidebar-section {
      padding: 20px 20px;
      border-bottom: 2px solid var(--border-black);
      position: relative;
      background: var(--bg-white);
    }

    .sidebar-section h3 {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1rem;
      font-weight: 400;
      color: var(--primary-accent);
      text-transform: uppercase;
      margin-bottom: 16px;
      letter-spacing: 0.15em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .sidebar-section h3::before {
      content: '';
      width: 4px;
      height: 16px;
      background: var(--primary-accent);
      border-radius: 2px;
    }

    .branded-header {
      background: var(--header-dark);
      position: relative;
      padding: 24px 20px;
      border-bottom: 2px solid var(--border-black);
    }

    .branded-header::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--primary-accent);
    }

    .logo-container {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 20px;
    }

    /* ================================================================
       METRICS BAR - Editorial Style
       ================================================================ */
    .metrics-bar {
      position: fixed;
      top: 0;
      left: 300px;
      right: 0;
      background: var(--bg-white);
      z-index: 60;
      padding: 20px 24px 0;
      border-bottom: 2px solid var(--border-black);
    }

    .main-content {
      margin-left: 300px;
      padding-top: 200px;
      min-height: 100vh;
      background: var(--bg-cream);
      position: relative;
      z-index: 1;
    }

    .content-wrapper {
      background: var(--bg-white);
      margin: 0 20px 20px;
      padding: 24px;
      border-radius: var(--panel-radius);
      border: 2px solid var(--border-black);
      position: relative;
    }

    /* ================================================================
       GRUNGY CARDS - Editorial Style
       ================================================================ */
    .mc-card {
      background: var(--bg-white);
      border-radius: var(--card-radius);
      padding: 20px;
      border: 2px solid var(--border-black);
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }

    .mc-card:hover {
      transform: translate(-2px, -2px);
      box-shadow: 4px 4px 0 var(--border-black);
    }

    /* Primary Metric Card */
    .metric-card-primary {
      background: var(--bg-white);
      border-radius: var(--card-radius);
      padding: 20px 24px;
      border: 2px solid var(--border-black);
      position: relative;
      overflow: hidden;
      transition: all 0.2s ease;
    }

    .metric-card-primary::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--primary-accent), var(--cyber-cyan));
    }

    .metric-card-primary::after {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle, rgba(45, 156, 219, 0.1) 0%, transparent 70%);
      pointer-events: none;
    }

    .metric-card-primary:hover {
      box-shadow: 0 0 30px rgba(45, 156, 219, 0.2), 0 8px 32px rgba(45, 156, 219, 0.2);
      border-color: var(--primary-accent);
    }

    .metric-card-primary .metric-value {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary-accent);
      text-shadow: 0 0 20px rgba(45, 156, 219, 0.2);
      line-height: 1;
    }

    .metric-card-primary .metric-label {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.7rem;
      font-weight: 400;
      color: var(--text-light);
      text-transform: uppercase;
      letter-spacing: 0.15em;
      margin-bottom: 8px;
    }

    /* Status Cards - Green/Red variants */
    .metric-card-success {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.08) 0%, var(--bg-white) 100%);
      border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .metric-card-success::before {
      background: var(--status-green);
    }

    .metric-card-success .metric-value {
      color: var(--status-green);
      text-shadow: 0 0 20px rgba(34, 197, 94, 0.2);
    }

    .metric-card-danger {
      background: linear-gradient(135deg, rgba(255, 51, 102, 0.08) 0%, var(--bg-white) 100%);
      border: 1px solid rgba(255, 51, 102, 0.3);
    }

    .metric-card-danger::before {
      background: var(--status-red);
    }

    .metric-card-danger .metric-value {
      color: var(--status-red);
      text-shadow: 0 0 20px rgba(220, 38, 38, 0.2);
    }

    /* Warning Card - Orange */
    .metric-card-warning {
      background: linear-gradient(135deg, rgba(255, 107, 53, 0.08) 0%, var(--bg-white) 100%);
      border: 1px solid rgba(255, 107, 53, 0.3);
    }

    .metric-card-warning::before {
      background: var(--status-orange);
    }

    .metric-card-warning .metric-value {
      color: var(--status-orange);
      text-shadow: 0 0 20px rgba(245, 158, 11, 0.2);
    }

    /* Standard metric card */
    .metric-card-standard {
      background: var(--bg-white);
      border-radius: var(--card-radius);
      padding: 16px 20px;
      border: 1px solid var(--border-light);
      display: flex;
      align-items: center;
      gap: 16px;
      transition: all 0.3s ease;
    }

    .metric-card-standard:hover {
      border-color: rgba(45, 156, 219, 0.3);
      box-shadow: 0 0 20px rgba(45, 156, 219, 0.1);
    }

    .metric-icon {
      width: 48px;
      height: 48px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      position: relative;
    }

    .metric-icon::after {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 8px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.1);
    }

    .metric-icon-blue {
      background: linear-gradient(135deg, rgba(45, 156, 219, 0.2) 0%, rgba(45, 156, 219, 0.1) 100%);
      border: 1px solid rgba(45, 156, 219, 0.3);
      color: var(--primary-accent);
    }

    .metric-icon-green {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.2) 0%, rgba(34, 197, 94, 0.1) 100%);
      border: 1px solid rgba(34, 197, 94, 0.3);
      color: var(--status-green);
    }

    .metric-icon-red {
      background: linear-gradient(135deg, rgba(255, 51, 102, 0.2) 0%, rgba(255, 51, 102, 0.1) 100%);
      border: 1px solid rgba(255, 51, 102, 0.3);
      color: var(--status-red);
    }

    .metric-icon-orange {
      background: linear-gradient(135deg, rgba(255, 107, 53, 0.2) 0%, rgba(255, 107, 53, 0.1) 100%);
      border: 1px solid rgba(255, 107, 53, 0.3);
      color: var(--status-orange);
    }

    .metric-value-standard {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-black);
      line-height: 1.2;
    }

    .metric-label-standard {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.7rem;
      font-weight: 400;
      color: var(--text-light);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-top: 4px;
    }

    /* Progress bar - Terminal style */
    .progress-bar-mc {
      height: 4px;
      background: var(--bg-light);
      border-radius: 2px;
      overflow: hidden;
      margin-top: 12px;
      position: relative;
    }

    .progress-bar-mc::before {
      content: '';
      position: absolute;
      inset: 0;
      background: repeating-linear-gradient(
        90deg,
        transparent,
        transparent 3px,
        rgba(45, 156, 219, 0.1) 3px,
        rgba(45, 156, 219, 0.1) 6px
      );
    }

    .progress-bar-mc .fill {
      height: 100%;
      border-radius: 2px;
      transition: width 0.5s ease;
      position: relative;
    }

    .progress-bar-mc .fill-blue {
      background: linear-gradient(90deg, var(--color-2-ocean-blue) 0%, var(--primary-accent) 100%);
      box-shadow: 0 0 10px rgba(61, 90, 127, 0.2);
    }

    .progress-bar-mc .fill-green {
      background: linear-gradient(90deg, var(--color-2-ocean-blue) 0%, var(--status-green) 100%);
      box-shadow: 0 0 10px rgba(61, 90, 127, 0.2);
    }

    .progress-bar-mc .fill-red {
      background: linear-gradient(90deg, var(--color-3-crimson) 0%, var(--status-red) 100%);
      box-shadow: 0 0 10px rgba(217, 69, 69, 0.2);
    }

    /* ================================================================
       TAB NAVIGATION - Grungy Editorial Style
       ================================================================ */
    .tab-nav-mc {
      display: flex;
      gap: 0;
      padding: 0;
      background: var(--bg-white);
      border-radius: var(--btn-radius);
      margin-bottom: 20px;
      border: 2px solid var(--border-black);
      overflow: hidden;
    }

    .tab-btn-mc {
      padding: 14px 20px;
      font-family: 'Work Sans', sans-serif;
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-medium);
      background: transparent;
      border: none;
      border-right: 1px solid var(--border-light);
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }

    .tab-btn-mc:last-child {
      border-right: none;
    }

    .tab-btn-mc:hover {
      color: var(--text-black);
      background: var(--bg-light);
    }

    .tab-btn-mc.active {
      background: var(--primary-accent);
      color: white;
      border-right: 1px solid var(--primary-accent);
    }

    .tab-btn-mc.active::before {
      content: '●';
      position: absolute;
      left: 8px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.5rem;
      color: white;
      animation: pulse-led 2s ease-in-out infinite;
    }

    @keyframes pulse-led {
      0%, 100% { opacity: 1; box-shadow: 0 0 10px var(--primary-accent); }
      50% { opacity: 0.6; box-shadow: 0 0 5px var(--primary-accent); }
    }

    /* ================================================================
       STATUS BADGES & INDICATORS
       ================================================================ */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 14px;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.7rem;
      font-weight: 500;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      border-radius: 20px;
      border: 2px solid var(--border-black);
      box-shadow: 2px 2px 0 rgba(0, 0, 0, 0.2);
    }

    .status-badge::before {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .status-online {
      background: var(--status-green);
      color: white;
    }

    .status-online::before {
      background: white;
    }

    .status-warning {
      background: var(--status-orange);
      color: white;
    }

    .status-warning::before {
      background: white;
    }

    .status-error {
      background: rgba(255, 51, 102, 0.1);
      color: var(--status-red);
      border: 1px solid rgba(255, 51, 102, 0.3);
    }

    .status-error::before {
      background: var(--status-red);
      box-shadow: 0 0 10px var(--status-red);
    }

    .status-standby {
      background: rgba(45, 156, 219, 0.1);
      color: var(--primary-accent);
      border: 1px solid rgba(45, 156, 219, 0.3);
    }

    .status-standby::before {
      background: var(--primary-accent);
      box-shadow: 0 0 10px var(--primary-accent);
    }

    /* Live indicator with data stream effect */
    .live-indicator {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 8px 16px;
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, transparent 100%);
      border: 1px solid rgba(34, 197, 94, 0.3);
      border-radius: var(--btn-radius);
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.7rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--status-green);
    }

    .live-indicator::before {
      content: '';
      width: 8px;
      height: 8px;
      background: var(--status-green);
      border-radius: 50%;
      box-shadow: 0 0 10px var(--status-green), 0 0 20px rgba(34, 197, 94, 0.2);
      animation: pulse-live 1.5s ease-in-out infinite;
    }

    @keyframes pulse-live {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
    }

    /* ================================================================
       ANIMATIONS - Command Center Effects
       ================================================================ */
    @keyframes scanline {
      0% { transform: translateY(-100%); }
      100% { transform: translateY(100vh); }
    }

    @keyframes glow-pulse {
      0%, 100% { box-shadow: 0 0 20px rgba(45, 156, 219, 0.2); }
      50% { box-shadow: 0 0 40px rgba(45, 156, 219, 0.2); }
    }

    @keyframes data-stream {
      0% { background-position: 0% 50%; }
      100% { background-position: 100% 50%; }
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideInLeft {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes flickerIn {
      0% { opacity: 0; }
      10% { opacity: 0.5; }
      20% { opacity: 0.2; }
      30% { opacity: 0.8; }
      40% { opacity: 0.4; }
      50% { opacity: 1; }
      100% { opacity: 1; }
    }

    .animate-fade-up {
      animation: fadeInUp 0.5s ease-out;
    }

    .animate-slide-in {
      animation: slideInLeft 0.5s ease-out;
    }

    .animate-flicker {
      animation: flickerIn 0.8s ease-out;
    }

    .animate-glow-pulse {
      animation: glow-pulse 2s ease-in-out infinite;
    }

    /* Staggered delays */
    .stagger-1 { animation-delay: 0.05s; animation-fill-mode: both; }
    .stagger-2 { animation-delay: 0.1s; animation-fill-mode: both; }
    .stagger-3 { animation-delay: 0.15s; animation-fill-mode: both; }
    .stagger-4 { animation-delay: 0.2s; animation-fill-mode: both; }
    .stagger-5 { animation-delay: 0.25s; animation-fill-mode: both; }

    /* ================================================================
       SCROLLBAR - Terminal Style
       ================================================================ */
    .sidebar::-webkit-scrollbar {
      width: 4px;
    }

    .sidebar::-webkit-scrollbar-track {
      background: var(--bg-light);
    }

    .sidebar::-webkit-scrollbar-thumb {
      background: var(--border-light);
      border-radius: 2px;
    }

    .sidebar::-webkit-scrollbar-thumb:hover {
      background: var(--primary-accent);
    }

    .main-content::-webkit-scrollbar {
      width: 6px;
    }

    .main-content::-webkit-scrollbar-track {
      background: var(--bg-light);
    }

    .main-content::-webkit-scrollbar-thumb {
      background: var(--border-light);
      border-radius: 3px;
    }

    .main-content::-webkit-scrollbar-thumb:hover {
      background: rgba(45, 156, 219, 0.5);
    }

    /* ================================================================
       SIDEBAR COMPONENTS - Command Terminal Style
       ================================================================ */
    .sidebar-stat-card {
      background: var(--bg-light);
      border-radius: var(--card-radius);
      padding: 12px 16px;
      margin-bottom: 10px;
      transition: all 0.2s ease;
      border: 2px solid var(--border-black);
      position: relative;
      box-shadow: 2px 2px 0 rgba(0, 0, 0, 0.1);
    }

    .sidebar-stat-card::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 2px;
      background: var(--primary-accent);
      border-radius: 2px 0 0 2px;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .sidebar-stat-card:hover {
      border-color: var(--primary-accent);
      background: rgba(45, 156, 219, 0.05);
      box-shadow: 3px 3px 0 rgba(0, 0, 0, 0.15);
      transform: translate(-1px, -1px);
    }

    .sidebar-stat-card:hover::before {
      opacity: 1;
    }

    .sidebar-input {
      background: var(--bg-white);
      border: 2px solid var(--border-black);
      border-radius: var(--btn-radius);
      padding: 8px 12px;
      color: var(--text-dark);
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.875rem;
      font-weight: 600;
      width: 70px;
      text-align: right;
      transition: all 0.2s ease;
      box-shadow: 2px 2px 0 rgba(0, 0, 0, 0.1);
    }

    .sidebar-input:focus {
      outline: none;
      border-color: var(--primary-accent);
      box-shadow: 3px 3px 0 rgba(45, 156, 219, 0.2);
      transform: translate(-1px, -1px);
    }

    .sidebar-label {
      color: var(--text-medium);
      font-family: 'Work Sans', sans-serif;
      font-size: 0.8rem;
      font-weight: 500;
    }

    /* Calendar Widget - Terminal Style */
    .calendar-widget {
      background: var(--bg-light);
      border-radius: var(--card-radius);
      padding: 16px;
      border: 1px solid var(--border-light);
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .calendar-title {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.8rem;
      font-weight: 400;
      color: var(--text-dark);
      letter-spacing: 0.05em;
    }

    .calendar-nav {
      display: flex;
      gap: 6px;
    }

    .calendar-nav button {
      width: 24px;
      height: 24px;
      border-radius: var(--btn-radius);
      border: 1px solid var(--border-light);
      background: transparent;
      color: var(--text-light);
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'IBM Plex Mono', monospace;
    }

    .calendar-nav button:hover {
      border-color: var(--primary-accent);
      color: var(--primary-accent);
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
      text-align: center;
    }

    .calendar-day-header {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.6rem;
      font-weight: 400;
      color: var(--text-light);
      padding: 4px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .calendar-day {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.7rem;
      color: var(--text-medium);
      padding: 6px 4px;
      border-radius: var(--btn-radius);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .calendar-day:hover {
      background: rgba(45, 156, 219, 0.1);
      color: var(--primary-accent);
    }

    .calendar-day.today {
      background: var(--primary-accent);
      color: var(--bg-cream);
      font-weight: 600;
    }

    .calendar-day.active {
      background: var(--status-red);
      color: white;
    }

    .calendar-day.muted {
      color: var(--border-light);
    }

    /* Events List - Terminal Style */
    .event-item {
      display: flex;
      gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid var(--border-light);
    }

    .event-item:last-child {
      border-bottom: none;
    }

    .event-date-badge {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--status-orange) 0%, var(--color-4-soft-crimson) 100%);
      border-radius: var(--card-radius);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .event-date-badge .day {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.9rem;
      font-weight: 700;
      color: white;
      line-height: 1;
    }

    .event-date-badge .month {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.5rem;
      font-weight: 400;
      color: rgba(255, 255, 255, 0.8);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .event-info {
      flex: 1;
      min-width: 0;
    }

    .event-title {
      font-family: 'Work Sans', sans-serif;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .event-subtitle {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.65rem;
      color: var(--text-light);
      letter-spacing: 0.05em;
    }

    .event-time {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.7rem;
      color: var(--primary-accent);
      white-space: nowrap;
    }

    /* Glass/HUD effect for special panels */
    .hud-panel {
      background: rgba(18, 21, 31, 0.8);
      backdrop-filter: blur(10px);
      border: 1px solid var(--border-light);
      border-radius: var(--panel-radius);
      position: relative;
    }

    .hud-panel::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--primary-accent), transparent);
    }

    /* Hexagon decorative elements */
    .hex-corner {
      position: absolute;
      width: 20px;
      height: 20px;
      border: 1px solid var(--primary-accent);
      opacity: 0.3;
    }

    .hex-corner.top-left {
      top: -1px;
      left: -1px;
      border-right: none;
      border-bottom: none;
    }

    .hex-corner.top-right {
      top: -1px;
      right: -1px;
      border-left: none;
      border-bottom: none;
    }

    .hex-corner.bottom-left {
      bottom: -1px;
      left: -1px;
      border-right: none;
      border-top: none;
    }

    .hex-corner.bottom-right {
      bottom: -1px;
      right: -1px;
      border-left: none;
      border-top: none;
    }

    /* Data ticker effect */
    .data-ticker {
      overflow: hidden;
      background: var(--bg-light);
      border-top: 1px solid var(--border-light);
      border-bottom: 1px solid var(--border-light);
      padding: 8px 0;
    }

    .data-ticker-content {
      display: flex;
      animation: ticker-scroll 30s linear infinite;
      white-space: nowrap;
    }

    @keyframes ticker-scroll {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); }
    }

    .ticker-item {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.7rem;
      color: var(--text-light);
      padding: 0 20px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .ticker-item .value {
      color: var(--primary-accent);
    }

    /* Utility classes */
    .text-cyber { color: var(--primary-accent); }
    .text-green { color: var(--status-green); }
    .text-orange { color: var(--status-orange); }
    .text-red { color: var(--status-red); }

    .glow-blue { text-shadow: 0 0 10px rgba(45, 156, 219, 0.2); }
    .glow-green { text-shadow: 0 0 10px rgba(34, 197, 94, 0.2); }
    .glow-orange { text-shadow: 0 0 10px rgba(245, 158, 11, 0.2); }
    .glow-red { text-shadow: 0 0 10px rgba(220, 38, 38, 0.2); }

    /* Corner accents for cards */
    .corner-accent {
      position: relative;
    }

    .corner-accent::after {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 30px;
      height: 30px;
      background: linear-gradient(135deg, transparent 50%, rgba(45, 156, 219, 0.1) 50%);
      pointer-events: none;
    }

    /* ================================================================
       RANGE SLIDER STYLING - Grungy Industrial
       ================================================================ */

    /* Reset default appearance */
    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      background: transparent;
      outline: none;
      height: 20px;
      padding: 0;
      margin: 0;
    }

    /* Webkit (Chrome, Safari, Edge) - Track */
    input[type="range"]::-webkit-slider-track {
      height: 6px;
      border-radius: 3px;
      background: transparent;
      border: 1px solid var(--color-5-blue-gray);
      box-sizing: border-box;
    }

    /* Webkit - Thumb */
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #ffffff;
      border: 2px solid var(--color-5-blue-gray);
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      transition: all 0.2s ease;
      margin-top: -7px;
    }

    input[type="range"]::-webkit-slider-thumb:hover {
      background: var(--color-7-pearl);
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3);
      transform: scale(1.1);
    }

    /* Firefox - Track */
    input[type="range"]::-moz-range-track {
      height: 6px;
      border-radius: 3px;
      background: transparent;
      border: 1px solid var(--color-5-blue-gray);
      box-sizing: border-box;
    }

    /* Firefox - Thumb */
    input[type="range"]::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #ffffff;
      border: 2px solid var(--color-5-blue-gray);
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      transition: all 0.2s ease;
    }

    input[type="range"]::-moz-range-thumb:hover {
      background: var(--color-7-pearl);
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3);
      transform: scale(1.1);
    }

    /* Microsoft Edge/IE - Track */
    input[type="range"]::-ms-track {
      height: 6px;
      border-radius: 3px;
      background: transparent;
      border: 1px solid #1a1a1a;
      color: transparent;
      box-sizing: border-box;
    }

    /* Microsoft Edge/IE - Thumb */
    input[type="range"]::-ms-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #ffffff;
      border: 2px solid var(--color-5-blue-gray);
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    input[type="range"]::-ms-thumb:hover {
      background: var(--color-7-pearl);
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3);
    }
  </style>
</head>
<body style="font-family: 'Work Sans', system-ui, sans-serif; background: var(--color-7-pearl); margin: 0; padding: 0;">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback, useRef, useMemo } = React;
    const {
      ResponsiveContainer, ComposedChart, BarChart, Bar, Line, XAxis, YAxis,
      CartesianGrid, Tooltip, Legend, ReferenceLine, ReferenceArea, Cell
    } = Recharts;

    // ============================================================================
    // PEAK DEMAND FLEET CALCULATOR
    // ============================================================================

    // Helper: Get distance from source to HDD crossing
    const getDistanceForCalculation = (sourceId, hddCrossing) => {
      // Use route data from simulation-worker.js MULTI_SOURCE_ROUTES
      // These are approximate distances in nautical miles
      const distances = {
        source1: { HDD17: 15, HDD18: 18, HDD19: 20, HDD20: 16, HDD21: 22, HDD22: 25, HDD23: 19, HDD24: 28, HDD25: 21, HDD26: 30 },
        source2: { HDD17: 12, HDD18: 14, HDD19: 16, HDD20: 13, HDD21: 18, HDD22: 21, HDD23: 15, HDD24: 24, HDD25: 17, HDD26: 26 },
        source3: { HDD17: 18, HDD18: 21, HDD19: 23, HDD20: 19, HDD21: 25, HDD22: 28, HDD23: 22, HDD24: 31, HDD25: 24, HDD26: 33 }
      };
      return distances[sourceId]?.[hddCrossing] || 20; // Default 20nm
    };

    // ============================================================================
    // DEFAULT CONFIGURATION
    // ============================================================================
    // NOTE: calculatePeakDemandFleet() was REMOVED - it was redundant.
    // The Analytical Fleet Sizing (in worker) auto-runs on page load and
    // overwrites any initial values within 300ms. No point calculating twice.

    const defaultConfigConstants = {
      // Equipment specs
      TOTAL_LARGE_BARGES: 4,
      LARGE_BARGE_VOLUME: 300000,  // Unified: all large barges same capacity
      SMALL_BARGE_VOLUME: 80000,
      SMALL_BARGES_PER_TUG: 2,
      LARGE_BARGES_PER_TUG: 1,
      LARGE_BARGE_DAY_RATE: 750,
      SMALL_BARGE_DAY_RATE: 250,

      // Tug
      loadedSpeedSmall: 5,
      loadedSpeedLarge: 5,
      emptySpeed: 5,
      TUG_DAY_RATE: 4500,
      TUG_FUEL_IDLE_GPH: 10,
      TUG_FUEL_RUNNING_GPH: 45,

      // Operations
      switchoutTime: 0.5,
      hookupTime: 0.33,
      pumpRate: 1000,
      DRILLING_START_HOUR: 7,
      DRILLING_END_HOUR: 17,

      // Sources
      sourceConfig: {
        source1: { flowRate: 800, hoursPerDay: 24 },
        source2: { flowRate: 200, hoursPerDay: 24 },
        source3: { flowRate: 400, hoursPerDay: 24 }
      },

      // Rigs
      rigs: {
        Blue: { pilot: 7500, ream: 20000, swab: 17000, pull: 14000 },
        Green: { pilot: 7500, ream: 20000, swab: 17000, pull: 14000 },
        Red: { pilot: 7500, ream: 20000, swab: 17000, pull: 14000 }
      },

      // Costs
      FUEL_PRICE_PER_GAL: 3.00,
      DOWNTIME_HOURLY_RATE: 6591,
      TUG_MOB_COST: 4500,
      TUG_DEMOB_COST: 4500,
      BARGE_MOB_DEMOB_COST_DAYS: 2,

      // Water Acquisition Costs
      WATER_COST_SOURCE1: 0.02,
      WATER_COST_SOURCE2: 0.03,
      WATER_COST_SOURCE3: 0.03,

      // HDD Schedule (using durations in days)
      hddSchedule: [
        { rig: 'Blue', crossing: 'HDD17', startDate: '2026-05-14', rigUpDays: 5, pilotDays: 6, reamDays: 3, swabDays: 1, pullDays: 1, rigDownDays: 6, worksSundays: false },
        { rig: 'Green', crossing: 'HDD18', startDate: '2026-05-27', rigUpDays: 5, pilotDays: 11, reamDays: 11, swabDays: 1, pullDays: 1, rigDownDays: 6, worksSundays: false },
        { rig: 'Blue', crossing: 'HDD19', startDate: '2026-06-28', rigUpDays: 4, pilotDays: 7, reamDays: 5, swabDays: 1, pullDays: 1, rigDownDays: 6, worksSundays: false },
        { rig: 'Blue', crossing: 'HDD20', startDate: '2026-06-06', rigUpDays: 4, pilotDays: 6, reamDays: 3, swabDays: 1, pullDays: 2, rigDownDays: 5, worksSundays: false },
        { rig: 'Green', crossing: 'HDD21', startDate: '2026-07-02', rigUpDays: 4, pilotDays: 14, reamDays: 12, swabDays: 2, pullDays: 1, rigDownDays: 6, worksSundays: false },
        { rig: 'Blue', crossing: 'HDD22', startDate: '2026-07-23', rigUpDays: 4, pilotDays: 4, reamDays: 3, swabDays: 1, pullDays: 1, rigDownDays: 6, worksSundays: false },
        { rig: 'Red', crossing: 'HDD23', startDate: '2026-06-21', rigUpDays: 4, pilotDays: 9, reamDays: 7, swabDays: 2, pullDays: 1, rigDownDays: 6, worksSundays: false },
        { rig: 'Blue', crossing: 'HDD24', startDate: '2026-08-12', rigUpDays: 3, pilotDays: 4, reamDays: 2, swabDays: 1, pullDays: 2, rigDownDays: 5, worksSundays: false },
        { rig: 'Red', crossing: 'HDD25', startDate: '2026-07-21', rigUpDays: 3, pilotDays: 11, reamDays: 10, swabDays: 1, pullDays: 2, rigDownDays: 5, worksSundays: false },
        { rig: 'Red', crossing: 'HDD26', startDate: '2026-08-23', rigUpDays: 4, pilotDays: 5, reamDays: 3, swabDays: 1, pullDays: 2, rigDownDays: 5, worksSundays: false }
      ]
    };

    // Simple placeholder defaults - will be overwritten by Analytical Fleet Sizing
    // within 300ms of page load. No need to calculate here.
    const defaultConfig = {
      // Fleet (placeholder until Analytical Fleet Sizing completes)
      numSmallTugs: 4,
      numSmallTransportBarges: 8,
      numSmallStorageBarges: 6,
      numLargeTransport: 0,
      numLargeStorage: 1,

      // Equipment
      TOTAL_LARGE_BARGES: 4,
      LARGE_BARGE_VOLUME: 300000,  // Unified: all large barges same capacity
      SMALL_BARGE_VOLUME: 80000,
      SMALL_BARGES_PER_TUG: 2,
      LARGE_BARGES_PER_TUG: 1,
      LARGE_BARGE_DAY_RATE: 750,
      SMALL_BARGE_DAY_RATE: 250,

      // Tug
      loadedSpeedSmall: 5,
      loadedSpeedLarge: 5,
      emptySpeed: 5,
      TUG_DAY_RATE: 4500,
      TUG_FUEL_IDLE_GPH: 10,
      TUG_FUEL_RUNNING_GPH: 45,

      // Operations
      switchoutTime: 0.5,
      hookupTime: 0.33,
      pumpRate: 1000,
      DRILLING_START_HOUR: 7,
      DRILLING_END_HOUR: 17,

      // Sources
      sourceConfig: {
        source1: { flowRate: 800, hoursPerDay: 24 },
        source2: { flowRate: 200, hoursPerDay: 24 },
        source3: { flowRate: 400, hoursPerDay: 24 }
      },

      // Rigs
      rigs: {
        Blue: { pilot: 7500, ream: 20000, swab: 17000, pull: 14000 },
        Green: { pilot: 7500, ream: 20000, swab: 17000, pull: 14000 },
        Red: { pilot: 7500, ream: 20000, swab: 17000, pull: 14000 }
      },

      // Costs
      FUEL_PRICE_PER_GAL: 3.00,
      DOWNTIME_HOURLY_RATE: 6591,
      TUG_MOB_COST: 4500,
      TUG_DEMOB_COST: 4500,
      BARGE_MOB_DEMOB_COST_DAYS: 2,

      // Water Acquisition Costs
      WATER_COST_SOURCE1: 0.02,
      WATER_COST_SOURCE2: 0.03,
      WATER_COST_SOURCE3: 0.03,

      // HDD Schedule (using durations in days)
      hddSchedule: [
        { rig: 'Blue', crossing: 'HDD17', startDate: '2026-05-14', rigUpDays: 5, pilotDays: 6, reamDays: 3, swabDays: 1, pullDays: 1, rigDownDays: 6, worksSundays: false },
        { rig: 'Green', crossing: 'HDD18', startDate: '2026-05-27', rigUpDays: 5, pilotDays: 11, reamDays: 11, swabDays: 1, pullDays: 1, rigDownDays: 6, worksSundays: false },
        { rig: 'Blue', crossing: 'HDD19', startDate: '2026-06-28', rigUpDays: 4, pilotDays: 7, reamDays: 5, swabDays: 1, pullDays: 1, rigDownDays: 6, worksSundays: false },
        { rig: 'Blue', crossing: 'HDD20', startDate: '2026-06-06', rigUpDays: 4, pilotDays: 6, reamDays: 3, swabDays: 1, pullDays: 2, rigDownDays: 5, worksSundays: false },
        { rig: 'Green', crossing: 'HDD21', startDate: '2026-07-02', rigUpDays: 4, pilotDays: 14, reamDays: 12, swabDays: 2, pullDays: 1, rigDownDays: 6, worksSundays: false },
        { rig: 'Blue', crossing: 'HDD22', startDate: '2026-07-23', rigUpDays: 4, pilotDays: 4, reamDays: 3, swabDays: 1, pullDays: 1, rigDownDays: 6, worksSundays: false },
        { rig: 'Red', crossing: 'HDD23', startDate: '2026-06-21', rigUpDays: 4, pilotDays: 9, reamDays: 7, swabDays: 2, pullDays: 1, rigDownDays: 6, worksSundays: false },
        { rig: 'Blue', crossing: 'HDD24', startDate: '2026-08-12', rigUpDays: 3, pilotDays: 4, reamDays: 2, swabDays: 1, pullDays: 2, rigDownDays: 5, worksSundays: false },
        { rig: 'Red', crossing: 'HDD25', startDate: '2026-07-21', rigUpDays: 3, pilotDays: 11, reamDays: 10, swabDays: 1, pullDays: 2, rigDownDays: 5, worksSundays: false },
        { rig: 'Red', crossing: 'HDD26', startDate: '2026-08-23', rigUpDays: 4, pilotDays: 5, reamDays: 3, swabDays: 1, pullDays: 2, rigDownDays: 5, worksSundays: false }
      ]
    };

    // ============================================================================
    // CONSTANTS
    // ============================================================================
    // Brand-aligned chart colors
    const COLORS = {
      Blue: '#1e3a5f',      // WHC Navy
      Green: '#22c55e',     // Status Green
      Red: '#d94545',       // WHC Red
      demand: '#d94545',    // WHC Red
      injection: '#f59e0b', // Accent Orange
      storage: '#2d9cdb',   // ONEOK Blue
      capacity: '#F59E0B',
      critical: '#DC2626'
    };

    // ============================================================================
    // HELPER FUNCTIONS
    // ============================================================================
    function formatHourToAMPM(hour) {
      if (hour === 0) return '12 AM';
      if (hour === 12) return '12 PM';
      if (hour < 12) return `${hour} AM`;
      return `${hour - 12} PM`;
    }

    function formatCurrency(value) {
      return `$${Math.round(value).toLocaleString()}`;
    }

    function formatNumber(value) {
      return value.toLocaleString();
    }

    // Convert HDD schedule from durations to dates format for worker
    // FIX: Each phase END date is calculated as previous_end + (duration - 1)
    // This ensures N days of duration = N actual days shown on chart
    // Example: 5 days RigUp starting 05-14 = days 05-14,15,16,17,18 = end date 05-18
    function convertScheduleToDate(hddSchedule) {
      return hddSchedule.map(hdd => {
        const start = new Date(hdd.startDate);

        // Calculate each phase END date
        // rigUp END = start + (rigUpDays - 1) because start day counts as day 1
        const rigUpDate = new Date(start);
        rigUpDate.setDate(rigUpDate.getDate() + hdd.rigUpDays - 1);

        // pilot END = rigUp END + pilotDays (pilot starts day after rigUp ends)
        const pilotDate = new Date(rigUpDate);
        pilotDate.setDate(pilotDate.getDate() + hdd.pilotDays);

        const reamDate = new Date(pilotDate);
        reamDate.setDate(reamDate.getDate() + hdd.reamDays);

        const swabDate = new Date(reamDate);
        swabDate.setDate(swabDate.getDate() + hdd.swabDays);

        const pullDate = new Date(swabDate);
        pullDate.setDate(pullDate.getDate() + hdd.pullDays);

        const rigDownDate = new Date(pullDate);
        rigDownDate.setDate(rigDownDate.getDate() + hdd.rigDownDays);

        return {
          rig: hdd.rig,
          crossing: hdd.crossing,
          start: hdd.startDate,
          rigUp: rigUpDate.toISOString().split('T')[0],
          pilot: pilotDate.toISOString().split('T')[0],
          ream: reamDate.toISOString().split('T')[0],
          swab: swabDate.toISOString().split('T')[0],
          pull: pullDate.toISOString().split('T')[0],
          rigDown: rigDownDate.toISOString().split('T')[0],
          worksSundays: hdd.worksSundays
        };
      });
    }

    // ============================================================================
    // INPUT COMPONENTS
    // ============================================================================
    function NumberInput({ label, value, onChange, min, max, step = 1, unit = '', isCurrency = false, decimals = 0, withCommas = false }) {
      let displayValue = value;

      if (isCurrency) {
        displayValue = decimals > 0 ? `$${value.toFixed(decimals)}` : `$${Math.round(value).toLocaleString()}`;
      } else if (withCommas) {
        displayValue = value.toLocaleString();
      }

      return (
        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', gap: '8px', marginBottom: '6px' }}>
          <label style={{ fontSize: '0.75rem', fontWeight: '500', color: 'var(--color-5-blue-gray)', whiteSpace: 'nowrap' }}>
            {label} {unit && !isCurrency && <span style={{ color: 'var(--color-6-silver)' }}>({unit})</span>}
          </label>
          <input
            type={(isCurrency || withCommas) ? "text" : "number"}
            value={displayValue}
            onChange={(e) => {
              const val = (isCurrency || withCommas) ? e.target.value.replace(/[$,]/g, '') : e.target.value;
              onChange(parseFloat(val) || 0);
            }}
            min={min}
            max={max}
            step={step}
            className="input-field"
            style={{ width: '85px', padding: '4px 8px', fontSize: '0.8rem' }}
          />
        </div>
      );
    }

    function TimeInput({ label, value, onChange, min, max }) {
      const displayValue = formatHourToAMPM(value);

      return (
        <div className="mb-2 flex items-center justify-between gap-2">
          <label className="text-xs font-medium text-gray-700 flex-shrink-0">
            {label}
          </label>
          <input
            type="text"
            value={displayValue}
            onChange={(e) => {
              // Parse time from "7 AM" or "5 PM" format
              const match = e.target.value.match(/(\d+)\s*(AM|PM)?/i);
              if (match) {
                let hour = parseInt(match[1]);
                const isPM = match[2] && match[2].toUpperCase() === 'PM';
                if (isPM && hour !== 12) hour += 12;
                if (!isPM && hour === 12) hour = 0;
                if (hour >= min && hour <= max) {
                  onChange(hour);
                }
              }
            }}
            className="input-field"
            placeholder="7 AM"
            style={{ width: '90px' }}
          />
        </div>
      );
    }

    // ============================================================================
    // FIXED LEFT SIDEBAR
    // ============================================================================
    function LeftSidebar({ config, setConfig, runSimulation, isRunning, runAnalyticalFleetSizing, isAnalyzing, analyticalFleetResult, applyRecommendedFleet, runIterativeFleetFinder, isStale, result, progress }) {
      const updateConfig = (key, value) => {
        setConfig(prev => ({ ...prev, [key]: value }));
      };

      const updateSourceConfig = (sourceId, key, value) => {
        setConfig(prev => ({
          ...prev,
          sourceConfig: {
            ...prev.sourceConfig,
            [sourceId]: {
              ...prev.sourceConfig[sourceId],
              [key]: value
            }
          }
        }));
      };

      // Calendar widget component
      const CalendarWidget = () => {
        const [currentDate] = useState(new Date(2026, 1, 1)); // February 2026
        const daysOfWeek = ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'];
        const monthName = currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

        // Generate calendar days
        const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
        const getFirstDayOfMonth = (year, month) => new Date(year, month, 1).getDay();

        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const daysInMonth = getDaysInMonth(year, month);
        const firstDay = getFirstDayOfMonth(year, month);
        const daysInPrevMonth = getDaysInMonth(year, month - 1);

        const calendarDays = [];

        // Previous month days
        for (let i = firstDay - 1; i >= 0; i--) {
          calendarDays.push({ day: daysInPrevMonth - i, muted: true });
        }

        // Current month days
        for (let i = 1; i <= daysInMonth; i++) {
          calendarDays.push({ day: i, today: i === 1, active: i === 20 || i === 26 });
        }

        // Next month days
        const remaining = 42 - calendarDays.length;
        for (let i = 1; i <= remaining; i++) {
          calendarDays.push({ day: i, muted: true });
        }

        return (
          <div className="calendar-widget">
            <div className="calendar-header">
              <span className="calendar-title">{monthName}</span>
              <div className="calendar-nav">
                <button>‹</button>
                <button>›</button>
              </div>
            </div>
            <div className="calendar-grid">
              {daysOfWeek.map(day => (
                <div key={day} className="calendar-day-header">{day}</div>
              ))}
              {calendarDays.map((d, i) => (
                <div
                  key={i}
                  className={`calendar-day ${d.muted ? 'muted' : ''} ${d.today ? 'today' : ''} ${d.active ? 'active' : ''}`}
                >
                  {d.day}
                </div>
              ))}
            </div>
          </div>
        );
      };

      // Events list component
      const EventsList = ({ config }) => {
        const events = config.hddSchedule.slice(0, 4).map((hdd, idx) => {
          const date = new Date(hdd.startDate);
          return {
            day: date.getDate(),
            month: date.toLocaleDateString('en-US', { month: 'short' }),
            title: `${hdd.crossing} - ${hdd.rig} Rig`,
            subtitle: 'Pilot Phase Start',
            time: '7:00 AM'
          };
        });

        return (
          <div>
            {events.map((event, idx) => (
              <div key={idx} className="event-item">
                <div className="event-date-badge">
                  <span className="day">{event.day}</span>
                  <span className="month">{event.month}</span>
                </div>
                <div className="event-info">
                  <div className="event-title">{event.title}</div>
                  <div className="event-subtitle">{event.subtitle}</div>
                </div>
                <div className="event-time">{event.time}</div>
              </div>
            ))}
          </div>
        );
      };

      return (
        <div className="sidebar">
          {/* Logo Header */}
          <div className="branded-header" style={{ padding: '32px 20px', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
              <img
                src="SM-WHC%20Logo-core.png"
                alt="WHC Energy Services"
                style={{
                  height: '90px',
                  width: 'auto',
                  objectFit: 'contain',
                  maxWidth: '160px',
                  filter: 'grayscale(100%) brightness(1.4) contrast(0.85)',
                  opacity: 0.9
                }}
                onError={(e) => {
                  e.target.style.display = 'none';
                  console.error('WHC logo failed to load');
                }}
              />
              <div style={{ width: '2px', height: '100px', background: 'rgba(255,255,255,0.3)' }}></div>
              <img
                src="oneok-logo-png-transparent.png"
                alt="ONEOK"
                style={{
                  height: '135px',
                  width: 'auto',
                  objectFit: 'contain',
                  maxWidth: '240px',
                  filter: 'brightness(0) invert(1)'
                }}
              />
            </div>
          </div>

          {/* Fleet Configuration - W3Admin Premium Style */}
          <div className="sidebar-section">
            <h3>Fleet Configuration</h3>
            <div style={{ display: 'grid', gap: '10px' }}>
              <div className="sidebar-stat-card">
                <div className="flex items-center justify-between">
                  <span className="sidebar-label" style={{ display: 'flex', alignItems: 'center', gap: '8px', fontWeight: '600', color: 'var(--text-dark)' }}>
                    <span style={{
                      width: '32px',
                      height: '32px',
                      background: 'var(--primary-accent)',
                      borderRadius: '6px',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      fontSize: '0.65rem',
                      fontWeight: '700',
                      color: '#ffffff',
                      fontFamily: "'IBM Plex Mono', monospace",
                      letterSpacing: '0.5px',
                      border: '2px solid var(--border-black)'
                    }}>TUG</span>
                    Tugs
                  </span>
                  <input type="number" value={config.numSmallTugs} onChange={e => updateConfig('numSmallTugs', parseInt(e.target.value) || 0)} min={0} max={6} className="sidebar-input" />
                </div>
              </div>
              <div className="sidebar-stat-card">
                <div className="flex items-center justify-between">
                  <span className="sidebar-label" style={{ display: 'flex', alignItems: 'center', gap: '8px', fontWeight: '600', color: 'var(--text-dark)' }}>
                    <span style={{
                      width: '32px',
                      height: '32px',
                      background: 'var(--status-orange)',
                      borderRadius: '6px',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      fontSize: '0.55rem',
                      fontWeight: '700',
                      color: '#ffffff',
                      fontFamily: "'IBM Plex Mono', monospace",
                      border: '2px solid var(--border-black)'
                    }}>SB</span>
                    Small Transport
                  </span>
                  <input type="number" value={config.numSmallTransportBarges} onChange={e => updateConfig('numSmallTransportBarges', parseInt(e.target.value) || 0)} min={0} max={12} className="sidebar-input" />
                </div>
              </div>
              <div className="sidebar-stat-card">
                <div className="flex items-center justify-between">
                  <span className="sidebar-label" style={{ display: 'flex', alignItems: 'center', gap: '8px', fontWeight: '600', color: 'var(--text-dark)' }}>
                    <span style={{
                      width: '32px',
                      height: '32px',
                      background: 'var(--status-orange)',
                      borderRadius: '6px',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      fontSize: '0.55rem',
                      fontWeight: '700',
                      color: '#ffffff',
                      fontFamily: "'IBM Plex Mono', monospace",
                      border: '2px solid var(--border-black)'
                    }}>SS</span>
                    Small Storage
                  </span>
                  <input type="number" value={config.numSmallStorageBarges} onChange={e => updateConfig('numSmallStorageBarges', parseInt(e.target.value) || 0)} min={0} max={12} className="sidebar-input" />
                </div>
              </div>
              <div className="sidebar-stat-card">
                <div className="flex items-center justify-between">
                  <span className="sidebar-label" style={{ display: 'flex', alignItems: 'center', gap: '8px', fontWeight: '600', color: 'var(--text-dark)' }}>
                    <span style={{
                      width: '32px',
                      height: '32px',
                      background: 'var(--whc-red)',
                      borderRadius: '6px',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      fontSize: '0.55rem',
                      fontWeight: '700',
                      color: '#ffffff',
                      fontFamily: "'IBM Plex Mono', monospace",
                      border: '2px solid var(--border-black)'
                    }}>LB</span>
                    Large Transport
                  </span>
                  <input type="number" value={config.numLargeTransport} onChange={e => updateConfig('numLargeTransport', parseInt(e.target.value) || 0)} min={0} max={4} className="sidebar-input" />
                </div>
              </div>
              <div className="sidebar-stat-card">
                <div className="flex items-center justify-between">
                  <span className="sidebar-label" style={{ display: 'flex', alignItems: 'center', gap: '8px', fontWeight: '600', color: 'var(--text-dark)' }}>
                    <span style={{
                      width: '32px',
                      height: '32px',
                      background: 'var(--whc-red)',
                      borderRadius: '6px',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      fontSize: '0.55rem',
                      fontWeight: '700',
                      color: '#ffffff',
                      fontFamily: "'IBM Plex Mono', monospace",
                      border: '2px solid var(--border-black)'
                    }}>LS</span>
                    Large Storage
                  </span>
                  <input type="number" value={config.numLargeStorage} onChange={e => updateConfig('numLargeStorage', parseInt(e.target.value) || 0)} min={0} max={4} className="sidebar-input" />
                </div>
              </div>
            </div>

            {/* Action Buttons - Mission Control Style */}
            <div style={{ marginTop: '24px', display: 'flex', flexDirection: 'column', gap: '10px' }}>
              <button
                onClick={runSimulation}
                disabled={isRunning}
                className="btn-primary w-full"
                style={{
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  justifyContent: 'center',
                  gap: '8px',
                  padding: '14px 20px',
                  fontSize: '0.75rem',
                  background: isStale && result && !isRunning ?
                    'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)' :
                    undefined,
                  position: 'relative',
                  overflow: 'hidden'
                }}
              >
                {/* Progress bar at bottom of button */}
                {isRunning && progress && (
                  <div style={{
                    position: 'absolute',
                    bottom: 0,
                    left: 0,
                    height: '3px',
                    width: `${progress.percent}%`,
                    background: 'rgba(255,255,255,0.4)',
                    transition: 'width 0.3s ease'
                  }}></div>
                )}

                <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                  <span style={{ fontSize: '1rem' }}>
                    {isRunning ? '◌' : (isStale && result ? '⚠' : '▶')}
                  </span>
                  {isRunning ?
                    `Executing... ${progress ? progress.percent + '%' : ''}` :
                    (isStale && result ? 'Config Changed - Run Simulation' : 'Execute Simulation')
                  }
                </div>

                {isRunning && progress && (
                  <div style={{
                    fontSize: '0.6rem',
                    opacity: 0.8,
                    fontFamily: 'IBM Plex Mono, monospace',
                    textAlign: 'center'
                  }}>
                    {progress.currentConfig}
                  </div>
                )}
              </button>
            </div>
          </div>

          {/* Source Configuration */}
          <div className="sidebar-section">
            <h3>Water Sources</h3>
            {['source1', 'source2', 'source3'].map((sourceId, idx) => (
              <div key={sourceId} className="mb-3 pb-2 border-b border-gray-200 last:border-0">
                <div className="text-xs font-semibold text-gray-700 mb-1">Source {idx + 1}</div>
                <NumberInput label="Flow Rate" value={config.sourceConfig[sourceId].flowRate} onChange={v => updateSourceConfig(sourceId, 'flowRate', v)} unit="GPM" />
                <NumberInput label="Hours/Day" value={config.sourceConfig[sourceId].hoursPerDay} onChange={v => updateSourceConfig(sourceId, 'hoursPerDay', v)} unit="hrs" min={1} max={24} />
              </div>
            ))}
          </div>

          {/* Equipment Constants */}
          <div className="sidebar-section">
            <h3>Equipment Specs</h3>
            <NumberInput label="Large Barge Vol" value={config.LARGE_BARGE_VOLUME} onChange={v => updateConfig('LARGE_BARGE_VOLUME', v)} unit="gal" withCommas={true} />
            <NumberInput label="Small Barge Vol" value={config.SMALL_BARGE_VOLUME} onChange={v => updateConfig('SMALL_BARGE_VOLUME', v)} unit="gal" withCommas={true} />
          </div>

          {/* Operational Parameters */}
          <div className="sidebar-section">
            <h3>Operations</h3>
            <NumberInput label="Sm Barges Per Tug (Max)" value={config.SMALL_BARGES_PER_TUG} onChange={v => updateConfig('SMALL_BARGES_PER_TUG', v)} min={1} max={3} />
            <NumberInput label="Lg Barges Per Tug (Max)" value={config.LARGE_BARGES_PER_TUG} onChange={v => updateConfig('LARGE_BARGES_PER_TUG', v)} min={1} max={2} />
            <NumberInput label="Loaded Speed (Sm)" value={config.loadedSpeedSmall} onChange={v => updateConfig('loadedSpeedSmall', v)} unit="kts" step={0.5} />
            <NumberInput label="Loaded Speed (Lg)" value={config.loadedSpeedLarge} onChange={v => updateConfig('loadedSpeedLarge', v)} unit="kts" step={0.5} />
            <NumberInput label="Empty Speed" value={config.emptySpeed} onChange={v => updateConfig('emptySpeed', v)} unit="kts" step={0.5} />
            <NumberInput label="Switchout Time" value={config.switchoutTime} onChange={v => updateConfig('switchoutTime', v)} unit="hrs" step={0.1} />
            <NumberInput label="Hookup Time" value={config.hookupTime} onChange={v => updateConfig('hookupTime', v)} unit="hrs" step={0.01} />
            <NumberInput label="Pump Rate" value={config.pumpRate} onChange={v => updateConfig('pumpRate', v)} unit="GPM" withCommas={true} />
            <TimeInput label="Drilling Start" value={config.DRILLING_START_HOUR} onChange={v => updateConfig('DRILLING_START_HOUR', v)} min={0} max={23} />
            <TimeInput label="Drilling End" value={config.DRILLING_END_HOUR} onChange={v => updateConfig('DRILLING_END_HOUR', v)} min={1} max={24} />
          </div>
        </div>
      );
    }

    // ============================================================================
    // FIXED TOP METRICS BAR - Portfolio-Inspired Design
    // ============================================================================
    function MetricsBar({ result, config, isOptimized, activeTab, setActiveTab }) {
      const smBargeDays = result ? ((result.mobilizationSchedule?.summary?.totalSmallTransportBargeDays || 0) +
                          (result.mobilizationSchedule?.summary?.totalSmallStorageBargeDays || 0)) : 0;
      const lgBargeDays = result ? ((result.mobilizationSchedule?.summary?.totalLargeTransportBargeDays || 0) +
                          (result.mobilizationSchedule?.summary?.totalLargeStorageBargeDays || 0)) : 0;

      return (
        <div className="metrics-bar">
          {result ? (
            <>
              {/* Mission Control HUD Metric Cards - Grungy Editorial Style */}
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '16px', marginBottom: '16px' }}>
                {/* Reliability Card - Grungy Style */}
                <div className="group relative cursor-help" style={{
                  background: 'var(--bg-white)',
                  borderRadius: 'var(--card-radius)',
                  padding: '20px',
                  border: '2px solid var(--border-black)',
                  boxShadow: '4px 4px 0 var(--border-black)',
                  transition: 'all 0.2s ease'
                }}>
                  <div style={{
                    fontSize: '0.65rem',
                    fontWeight: '500',
                    fontFamily: 'IBM Plex Mono, monospace',
                    color: 'var(--text-medium)',
                    textTransform: 'uppercase',
                    letterSpacing: '0.15em',
                    marginBottom: '8px'
                  }}>RELIABILITY</div>
                  <div style={{
                    fontSize: '2rem',
                    fontWeight: '700',
                    color: result.ranDryCount > 0 ? 'var(--status-red)' : 'var(--status-green)',
                    fontFamily: 'Bebas Neue, sans-serif',
                    lineHeight: '1',
                    letterSpacing: '0.02em'
                  }}>{result.ranDryCount || 0}</div>
                  <div style={{
                    fontSize: '0.7rem',
                    fontFamily: 'Work Sans, sans-serif',
                    color: 'var(--text-light)',
                    marginTop: '4px'
                  }}>Ran Dry Events</div>
                  {/* Status dot */}
                  <div style={{
                    position: 'absolute',
                    top: '16px',
                    right: '16px',
                    width: '10px',
                    height: '10px',
                    background: result.ranDryCount > 0 ? 'var(--status-red)' : 'var(--status-green)',
                    borderRadius: '50%'
                  }}></div>
                </div>

                {/* Fleet Configuration Card - Grungy Style */}
                <div style={{
                  background: 'var(--bg-white)',
                  borderRadius: 'var(--card-radius)',
                  padding: '20px',
                  border: '2px solid var(--border-black)',
                  boxShadow: '4px 4px 0 var(--border-black)',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '16px'
                }}>
                  <div style={{
                    width: '48px',
                    height: '48px',
                    background: 'var(--primary-accent)',
                    borderRadius: '12px',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    fontSize: '1.5rem'
                  }}>⚓</div>
                  <div>
                    <div style={{ display: 'flex', gap: '6px', alignItems: 'baseline' }}>
                      <span style={{ fontSize: '1.75rem', fontWeight: '700', fontFamily: 'Bebas Neue, sans-serif', color: 'var(--primary-accent)' }}>{config.numSmallTugs}T</span>
                      <span style={{ color: 'var(--text-light)', fontSize: '1rem' }}>·</span>
                      <span style={{ fontSize: '1.75rem', fontWeight: '700', fontFamily: 'Bebas Neue, sans-serif', color: 'var(--text-dark)' }}>{config.numSmallTransportBarges + config.numSmallStorageBarges + config.numLargeTransport + config.numLargeStorage}B</span>
                    </div>
                    <div style={{ fontSize: '0.65rem', fontFamily: 'IBM Plex Mono, monospace', color: 'var(--text-medium)', textTransform: 'uppercase', letterSpacing: '0.1em' }}>ACTIVE FLEET</div>
                  </div>
                </div>

                {/* Water Volume Card - Grungy Style */}
                <div style={{
                  background: 'var(--bg-white)',
                  borderRadius: 'var(--card-radius)',
                  padding: '20px',
                  border: '2px solid var(--border-black)',
                  boxShadow: '4px 4px 0 var(--border-black)',
                  position: 'relative'
                }}>
                  <div style={{
                    fontSize: '0.65rem',
                    fontWeight: '500',
                    fontFamily: 'IBM Plex Mono, monospace',
                    color: 'var(--text-medium)',
                    textTransform: 'uppercase',
                    letterSpacing: '0.15em',
                    marginBottom: '8px'
                  }}>VOLUME</div>
                  <div style={{
                    fontSize: '2rem',
                    fontWeight: '700',
                    color: 'var(--primary-accent)',
                    fontFamily: 'Bebas Neue, sans-serif',
                    lineHeight: '1',
                    letterSpacing: '0.02em'
                  }}>{(result.totalDemand / 1000000).toFixed(1)}M</div>
                  <div style={{
                    fontSize: '0.7rem',
                    fontFamily: 'Work Sans, sans-serif',
                    color: 'var(--text-light)',
                    marginTop: '4px'
                  }}>gallons total</div>
                  <span style={{ position: 'absolute', top: '16px', right: '16px', fontSize: '1.5rem', opacity: 0.6 }}>💧</span>
                </div>

                {/* Status Card - Grungy Style */}
                <div style={{
                  background: result.success ? 'var(--status-green)' : 'var(--status-red)',
                  borderRadius: 'var(--card-radius)',
                  padding: '20px',
                  border: '2px solid var(--border-black)',
                  boxShadow: '4px 4px 0 var(--border-black)',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '16px'
                }}>
                  <div style={{
                    width: '48px',
                    height: '48px',
                    background: 'rgba(255,255,255,0.2)',
                    borderRadius: '12px',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    fontSize: '1.5rem',
                    color: 'white'
                  }}>{result.success ? '✓' : '✗'}</div>
                  <div>
                    <div style={{ fontSize: '1.5rem', fontWeight: '700', fontFamily: 'Bebas Neue, sans-serif', color: 'white', letterSpacing: '0.05em' }}>
                      {result.success ? 'SUCCESS' : 'FAILED'}
                    </div>
                    <div style={{ fontSize: '0.65rem', fontFamily: 'IBM Plex Mono, monospace', color: 'rgba(255,255,255,0.8)', textTransform: 'uppercase', letterSpacing: '0.1em' }}>SIMULATION STATUS</div>
                  </div>
                </div>
              </div>

              {/* Tab Navigation - Mission Control Terminal Style */}
              <div className="tab-nav-mc" style={{ display: 'inline-flex' }}>
                {[
                  { key: 'executive', label: 'Executive Summary', icon: '◆' },
                  { key: 'operations', label: 'Operations', icon: '◎' },
                  { key: 'analytics', label: 'Analytics', icon: '◈' },
                  { key: 'planning', label: 'Planning', icon: '◇' },
                  { key: 'financials', label: 'Financials', icon: '◉' },
                  { key: 'log', label: 'Log', icon: '◌' }
                ].map(tab => (
                  <button
                    key={tab.key}
                    onClick={() => setActiveTab(tab.key)}
                    className={`tab-btn-mc ${activeTab === tab.key ? 'active' : ''}`}
                    style={{
                      paddingLeft: activeTab === tab.key ? '26px' : '16px'
                    }}
                  >
                    {tab.label}
                  </button>
                ))}
              </div>

              {/* Optimized Badge */}
              {isOptimized && (
                <div className="status-badge status-online" style={{ marginLeft: '16px' }}>
                  Optimized
                </div>
              )}
            </>
          ) : (
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '16px', marginBottom: '16px' }}>
              {/* Placeholder Cards - Matching Post-Simulation Layout */}

              {/* Reliability Card Placeholder */}
              <div style={{
                background: 'var(--bg-white)',
                borderRadius: 'var(--card-radius)',
                padding: '20px',
                border: '2px solid var(--border-black)',
                boxShadow: '4px 4px 0 var(--border-black)',
                opacity: 0.6
              }}>
                <div style={{
                  fontSize: '0.65rem',
                  fontWeight: '500',
                  fontFamily: 'IBM Plex Mono, monospace',
                  color: 'var(--text-medium)',
                  textTransform: 'uppercase',
                  letterSpacing: '0.15em',
                  marginBottom: '8px'
                }}>RELIABILITY</div>
                <div style={{
                  fontSize: '2rem',
                  fontWeight: '700',
                  color: 'var(--text-light)',
                  fontFamily: 'Bebas Neue, sans-serif',
                  lineHeight: '1',
                  letterSpacing: '0.02em',
                  opacity: 0.3
                }}>--</div>
                <div style={{
                  fontSize: '0.7rem',
                  fontFamily: 'Work Sans, sans-serif',
                  color: 'var(--text-light)',
                  marginTop: '4px'
                }}>Ran Dry Events</div>
              </div>

              {/* Fleet Configuration Card Placeholder */}
              <div style={{
                background: 'var(--bg-white)',
                borderRadius: 'var(--card-radius)',
                padding: '20px',
                border: '2px solid var(--border-black)',
                boxShadow: '4px 4px 0 var(--border-black)',
                display: 'flex',
                alignItems: 'center',
                gap: '16px',
                opacity: 0.6
              }}>
                <div style={{
                  width: '48px',
                  height: '48px',
                  background: 'var(--bg-light)',
                  borderRadius: '12px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  fontSize: '1.5rem',
                  opacity: 0.4
                }}>⚓</div>
                <div>
                  <div style={{ display: 'flex', gap: '6px', alignItems: 'baseline' }}>
                    <span style={{ fontSize: '1.75rem', fontWeight: '700', fontFamily: 'Bebas Neue, sans-serif', color: 'var(--text-light)', opacity: 0.3 }}>--</span>
                  </div>
                  <div style={{ fontSize: '0.65rem', fontFamily: 'IBM Plex Mono, monospace', color: 'var(--text-medium)', textTransform: 'uppercase', letterSpacing: '0.1em' }}>ACTIVE FLEET</div>
                </div>
              </div>

              {/* Water Volume Card Placeholder */}
              <div style={{
                background: 'var(--bg-white)',
                borderRadius: 'var(--card-radius)',
                padding: '20px',
                border: '2px solid var(--border-black)',
                boxShadow: '4px 4px 0 var(--border-black)',
                position: 'relative',
                opacity: 0.6
              }}>
                <div style={{
                  fontSize: '0.65rem',
                  fontWeight: '500',
                  fontFamily: 'IBM Plex Mono, monospace',
                  color: 'var(--text-medium)',
                  textTransform: 'uppercase',
                  letterSpacing: '0.15em',
                  marginBottom: '8px'
                }}>VOLUME</div>
                <div style={{
                  fontSize: '2rem',
                  fontWeight: '700',
                  color: 'var(--text-light)',
                  fontFamily: 'Bebas Neue, sans-serif',
                  lineHeight: '1',
                  letterSpacing: '0.02em',
                  opacity: 0.3
                }}>--</div>
                <div style={{
                  fontSize: '0.7rem',
                  fontFamily: 'Work Sans, sans-serif',
                  color: 'var(--text-light)',
                  marginTop: '4px'
                }}>gallons total</div>
                <span style={{ position: 'absolute', top: '16px', right: '16px', fontSize: '1.5rem', opacity: 0.2 }}>💧</span>
              </div>

              {/* Status Card Placeholder */}
              <div style={{
                background: 'var(--bg-light)',
                borderRadius: 'var(--card-radius)',
                padding: '20px',
                border: '2px solid var(--border-black)',
                boxShadow: '4px 4px 0 var(--border-black)',
                display: 'flex',
                alignItems: 'center',
                gap: '16px',
                opacity: 0.6
              }}>
                <div style={{
                  width: '48px',
                  height: '48px',
                  background: 'rgba(45, 156, 219, 0.1)',
                  borderRadius: '12px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  fontSize: '1.5rem',
                  color: 'var(--primary-accent)',
                  opacity: 0.4
                }}>▶</div>
                <div>
                  <div style={{ fontSize: '1.5rem', fontWeight: '700', fontFamily: 'Bebas Neue, sans-serif', color: 'var(--text-light)', letterSpacing: '0.05em', opacity: 0.5 }}>
                    READY
                  </div>
                  <div style={{ fontSize: '0.65rem', fontFamily: 'IBM Plex Mono, monospace', color: 'var(--text-medium)', textTransform: 'uppercase', letterSpacing: '0.1em' }}>SIMULATION STATUS</div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // ============================================================================
    // CHART COMPONENTS (reuse from original)
    // ============================================================================
    function ProjectDailyDemandChart({ data, ranDryEvents = [] }) {
      if (!data || data.length === 0) return null;

      // Build set of dates with ran dry events for quick lookup
      const ranDryDates = new Set();
      if (ranDryEvents && ranDryEvents.length > 0) {
        ranDryEvents.forEach(event => {
          // Extract date from timestamp (format: "YYYY-MM-DD HH:MM:SS")
          // startTimestamp is the beginning of the ran dry event
          if (event.startTimestamp) {
            const fullDate = event.startTimestamp.split(' ')[0]; // Get YYYY-MM-DD
            const shortDate = fullDate.slice(5); // Get MM-DD
            ranDryDates.add(shortDate);
          }
          // Also check endTimestamp to capture multi-day events
          if (event.endTimestamp) {
            const fullDate = event.endTimestamp.split(' ')[0];
            const shortDate = fullDate.slice(5);
            ranDryDates.add(shortDate);
          }
        });
      }

      const chartData = data.map(d => {
        // Calculate total injection across all rigs
        const totalInjection = Math.round(
          ((d.rigInjected?.Blue || 0) + (d.rigInjected?.Green || 0) + (d.rigInjected?.Red || 0)) / 1000
        );

        return {
          date: d.date.slice(5),
          fullDate: d.date,
          Blue: Math.round((d.rigDemand?.Blue || 0) / 1000),
          Green: Math.round((d.rigDemand?.Green || 0) / 1000),
          Red: Math.round((d.rigDemand?.Red || 0) / 1000),
          totalInjection,
          hasRanDry: ranDryDates.has(d.date.slice(5))
        };
      });

      // Custom tick component for X-axis - highlight ran dry dates in bold red
      const CustomXAxisTick = ({ x, y, payload }) => {
        const dataPoint = chartData.find(d => d.date === payload.value);
        const hasRanDry = dataPoint?.hasRanDry || false;

        return (
          <g transform={`translate(${x},${y})`}>
            <text
              x={0}
              y={0}
              dy={16}
              textAnchor="middle"
              fill={hasRanDry ? '#dc2626' : '#6b7280'}
              fontSize={10}
              fontWeight={hasRanDry ? 'bold' : 'normal'}
              fontFamily="IBM Plex Mono, monospace"
            >
              {payload.value}
            </text>
          </g>
        );
      };

      // Custom Y-axis tick
      const CustomYAxisTick = ({ x, y, payload }) => {
        return (
          <g transform={`translate(${x},${y})`}>
            <text
              x={0}
              y={0}
              dx={-8}
              textAnchor="end"
              fill="#6b7280"
              fontSize={10}
              fontFamily="IBM Plex Mono, monospace"
            >
              {payload.value}
            </text>
          </g>
        );
      };

      // Custom tooltip with grungy styling
      const CustomTooltip = ({ active, payload, label }) => {
        if (!active || !payload || payload.length === 0) return null;

        return (
          <div style={{
            background: 'white',
            border: '2px solid var(--color-5-blue-gray)',
            borderRadius: '4px',
            boxShadow: '3px 3px 0 var(--color-5-blue-gray)',
            padding: '12px'
          }}>
            <div style={{
              fontFamily: 'IBM Plex Mono, monospace',
              fontSize: '11px',
              fontWeight: 'bold',
              marginBottom: '8px',
              color: 'var(--color-5-blue-gray)'
            }}>
              {label}
            </div>
            {payload.map((entry, index) => (
              <div key={index} style={{
                fontFamily: 'Work Sans, sans-serif',
                fontSize: '11px',
                color: entry.color,
                marginBottom: '4px'
              }}>
                {entry.name}: {entry.value}K gal
              </div>
            ))}
          </div>
        );
      };

      // Custom legend for proper symbol rendering
      const renderLegend = (props) => {
        const { payload } = props;
        return (
          <div style={{ display: 'flex', justifyContent: 'center', gap: '20px', marginTop: '16px' }}>
            {payload.map((entry, index) => {
              const isInjection = entry.value === "Total Injection";
              return (
                <div key={`legend-${index}`} style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                  {isInjection ? (
                    <svg width="14" height="14" style={{ marginRight: '2px' }}>
                      <circle cx="7" cy="7" r="4" fill="#ffffff" stroke="#D97706" strokeWidth="2" />
                    </svg>
                  ) : (
                    <svg width="14" height="14" style={{ marginRight: '2px' }}>
                      <rect width="14" height="14" fill={entry.color} stroke="var(--color-5-blue-gray)" strokeWidth="1" />
                    </svg>
                  )}
                  <span style={{
                    color: 'var(--color-5-blue-gray)',
                    fontSize: '12px',
                    fontFamily: 'Work Sans, sans-serif'
                  }}>
                    {entry.value}
                  </span>
                </div>
              );
            })}
          </div>
        );
      };

      return (
        <div>
          <h3 style={{
            fontFamily: 'Bebas Neue, sans-serif',
            fontSize: '1.25rem',
            letterSpacing: '0.05em',
            textTransform: 'uppercase',
            marginBottom: '16px',
            color: 'var(--color-5-blue-gray)'
          }}>
            Project Daily Water Demand
            <span style={{
              fontSize: '0.75rem',
              color: 'var(--color-6-silver)',
              fontWeight: '400',
              marginLeft: '8px',
              fontFamily: 'IBM Plex Mono, monospace',
              textTransform: 'none',
              letterSpacing: 'normal'
            }}>(K gal)</span>
          </h3>
          <ResponsiveContainer width="100%" height={300}>
            <ComposedChart data={chartData}>
              <CartesianGrid strokeDasharray="3 3" stroke="#1a1a1a" strokeOpacity={0.2} />
              <XAxis dataKey="date" tick={<CustomXAxisTick />} />
              <YAxis tick={<CustomYAxisTick />} />
              <Tooltip content={<CustomTooltip />} />
              <Legend content={renderLegend} />
              <Bar dataKey="Blue" stackId="a" fill={COLORS.Blue} name="Blue Rig Demand" />
              <Bar dataKey="Green" stackId="a" fill={COLORS.Green} name="Green Rig Demand" />
              <Bar dataKey="Red" stackId="a" fill={COLORS.Red} name="Red Rig Demand" />
              <Line
                type="monotone"
                dataKey="totalInjection"
                stroke="var(--color-4-soft-crimson)"
                strokeWidth={0}
                dot={{ fill: '#ffffff', stroke: 'var(--color-4-soft-crimson)', strokeWidth: 2, r: 3 }}
                name="Total Injection"
              />
            </ComposedChart>
          </ResponsiveContainer>
        </div>
      );
    }

    // Chart wrapper styling component
    function ChartSection({ title, subtitle, children }) {
      return (
        <div>
          <h3 className="font-display" style={{ fontSize: '1.125rem', fontWeight: '600', marginBottom: '12px', color: 'var(--text-dark)' }}>
            {title}
            {subtitle && <span style={{ fontSize: '0.7rem', color: 'var(--text-light)', fontWeight: '400', marginLeft: '8px', fontFamily: 'DM Sans, sans-serif' }}>{subtitle}</span>}
          </h3>
          {children}
        </div>
      );
    }

    function RigFlowStorageChart({ data, rigName, storageCapacity }) {
      if (!data || data.length === 0) return null;

      const color = COLORS[rigName];
      const rigColorShades = {
        Blue: { demand: '#93C5FD', injected: '#3B82F6' },
        Green: { demand: '#86EFAC', injected: '#10B981' },
        Red: { demand: '#FCA5A5', injected: '#EF4444' }
      };

      const chartData = data.map(d => {
        const demand = Math.round((d.rigDemand?.[rigName] || 0) / 1000);
        const injected = Math.round((d.rigInjected?.[rigName] || 0) / 1000);
        const deficit = Math.round((d.rigDeficit?.[rigName] || 0) / 1000);

        return {
          date: d.date.slice(5),
          demand: -demand,
          injected: injected,
          storage: Math.round((d.storageLevel?.[rigName] || 0) / 1000),
          deficit: deficit
        };
      });

      const capacityK = Math.round(storageCapacity / 1000);
      const criticalK = capacityK * 0.2;
      const targetMax = capacityK * 1.2;
      let yAxisMax;
      if (targetMax <= 100) {
        yAxisMax = Math.ceil(targetMax / 10) * 10;
      } else if (targetMax <= 500) {
        yAxisMax = Math.ceil(targetMax / 50) * 50;
      } else {
        yAxisMax = Math.ceil(targetMax / 100) * 100;
      }

      return (
        <div className="bg-white rounded-lg shadow p-4 mb-4">
          <h3 className="font-semibold mb-4" style={{ color }}>{rigName} Rig - Flow & Storage (K gal)</h3>
          <ResponsiveContainer width="100%" height={250}>
            <ComposedChart data={chartData} barSize={20}>
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis dataKey="date" tick={{ fontSize: 10 }} />
              <YAxis domain={[-yAxisMax, yAxisMax]} />
              <Tooltip />
              <Legend />
              <ReferenceLine y={0} stroke="#999" strokeWidth={1} />
              <Bar dataKey="demand" fill={rigColorShades[rigName].demand} name="Demand" />
              <Bar dataKey="injected" fill={rigColorShades[rigName].injected} name="Injection" />
              <Line type="monotone" dataKey="deficit" stroke="#DC2626" strokeWidth={2} name="Deficit" dot={false} />
              <Line type="monotone" dataKey="storage" stroke={COLORS.storage} strokeWidth={2} name="Storage (7AM)" dot={false} />
              <ReferenceLine y={capacityK} stroke={COLORS.capacity} strokeDasharray="5 5" label="Capacity" />
              <ReferenceLine y={criticalK} stroke={COLORS.critical} strokeDasharray="3 3" label="Critical" />
            </ComposedChart>
          </ResponsiveContainer>
        </div>
      );
    }

    function TugsChart({ data, maxValue }) {
      if (!data || data.length === 0) return null;
      const chartData = data.map(d => ({
        date: d.date.slice(5),
        active: d.tugsActive || 0,
        onSite: d.tugsOnSite || 0,
        activeTugIds: d.activeTugIds || []
      }));

      // Custom tooltip showing asset IDs with grungy styling
      const CustomTooltip = ({ active, payload, label }) => {
        if (!active || !payload || payload.length === 0) return null;
        const data = payload[0]?.payload;

        return (
          <div style={{
            background: 'white',
            border: '2px solid var(--color-5-blue-gray)',
            borderRadius: '4px',
            boxShadow: '3px 3px 0 var(--color-5-blue-gray)',
            padding: '12px'
          }}>
            <div style={{
              fontFamily: 'IBM Plex Mono, monospace',
              fontSize: '11px',
              fontWeight: 'bold',
              marginBottom: '8px',
              color: 'var(--color-5-blue-gray)'
            }}>
              {label}
            </div>
            <div style={{
              fontFamily: 'Work Sans, sans-serif',
              fontSize: '11px',
              color: 'var(--color-1-deep-navy)',
              marginBottom: '4px'
            }}>
              Active: {data.active}
            </div>
            <div style={{
              fontFamily: 'Work Sans, sans-serif',
              fontSize: '11px',
              color: '#22c55e',
              marginBottom: '8px'
            }}>
              On-Site: {data.onSite}
            </div>
            {data.activeTugIds && data.activeTugIds.length > 0 && (
              <div style={{
                marginTop: '8px',
                paddingTop: '8px',
                borderTop: '1px solid #1a1a1a'
              }}>
                <div style={{
                  fontFamily: 'IBM Plex Mono, monospace',
                  fontSize: '10px',
                  fontWeight: 'bold',
                  color: '#1a1a1a',
                  marginBottom: '4px'
                }}>
                  Active Tugs:
                </div>
                <div style={{
                  fontFamily: 'IBM Plex Mono, monospace',
                  fontSize: '10px',
                  color: '#6b7280',
                  maxHeight: '100px',
                  overflowY: 'auto'
                }}>
                  {data.activeTugIds.map((id, idx) => (
                    <div key={idx}>{id}</div>
                  ))}
                </div>
              </div>
            )}
          </div>
        );
      };

      // Custom legend: rectangle for bars, line for lines
      const renderLegend = (props) => {
        const { payload } = props;
        return (
          <div style={{ display: 'flex', justifyContent: 'center', gap: '20px', marginTop: '16px' }}>
            {payload.map((entry, index) => {
              const isLine = entry.value === "On-Site";
              return (
                <div key={`legend-${index}`} style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                  {isLine ? (
                    <svg width="20" height="14" style={{ marginRight: '2px' }}>
                      <line x1="0" y1="7" x2="20" y2="7" stroke={entry.color} strokeWidth="2" />
                    </svg>
                  ) : (
                    <svg width="14" height="14" style={{ marginRight: '2px' }}>
                      <rect width="14" height="14" fill={entry.color} stroke="var(--color-5-blue-gray)" strokeWidth="1" />
                    </svg>
                  )}
                  <span style={{
                    color: 'var(--color-5-blue-gray)',
                    fontSize: '12px',
                    fontFamily: 'Work Sans, sans-serif'
                  }}>
                    {entry.value}
                  </span>
                </div>
              );
            })}
          </div>
        );
      };

      return (
        <div>
          <h3 style={{
            fontFamily: 'Bebas Neue, sans-serif',
            fontSize: '1.125rem',
            letterSpacing: '0.05em',
            textTransform: 'uppercase',
            marginBottom: '12px',
            color: '#1a1a1a'
          }}>
            Tugs Active vs On-Site
          </h3>
          <ResponsiveContainer width="100%" height={200}>
            <ComposedChart data={chartData}>
              <CartesianGrid strokeDasharray="3 3" stroke="#1a1a1a" strokeOpacity={0.2} />
              <XAxis dataKey="date" tick={{ fontSize: 10, fill: '#6b7280', fontFamily: 'IBM Plex Mono, monospace' }} />
              <YAxis domain={[0, maxValue || 'auto']} tick={{ fill: '#6b7280', fontSize: 10, fontFamily: 'IBM Plex Mono, monospace' }} />
              <Tooltip content={<CustomTooltip />} />
              <Legend content={renderLegend} />
              <Bar dataKey="active" fill="#1e3a5f" name="Active" opacity={0.8} />
              <Line type="stepAfter" dataKey="onSite" stroke="#22c55e" strokeWidth={2} name="On-Site" dot={false} />
            </ComposedChart>
          </ResponsiveContainer>
        </div>
      );
    }

    function BargesChart({ data, bargeType, maxValue }) {
      if (!data || data.length === 0) return null;
      const chartData = data.map(d => ({
        date: d.date.slice(5),
        active: bargeType === 'small' ? (d.smallBargesActive || 0) : (d.largeBargesActive || 0),
        onSite: bargeType === 'small' ? (d.smallBargesOnSite || 0) : (d.largeBargesOnSite || 0),
        activeBargeIds: bargeType === 'small' ? (d.activeSmallBargeIds || []) : (d.activeLargeBargeIds || [])
      }));

      const title = bargeType === 'small' ? 'Small Barges' : 'Large Barges';

      // Custom tooltip showing asset IDs with grungy styling
      const CustomTooltip = ({ active, payload, label }) => {
        if (!active || !payload || payload.length === 0) return null;
        const data = payload[0]?.payload;

        return (
          <div style={{
            background: 'white',
            border: '2px solid var(--color-5-blue-gray)',
            borderRadius: '4px',
            boxShadow: '3px 3px 0 var(--color-5-blue-gray)',
            padding: '12px'
          }}>
            <div style={{
              fontFamily: 'IBM Plex Mono, monospace',
              fontSize: '11px',
              fontWeight: 'bold',
              marginBottom: '8px',
              color: 'var(--color-5-blue-gray)'
            }}>
              {label}
            </div>
            <div style={{
              fontFamily: 'Work Sans, sans-serif',
              fontSize: '11px',
              color: bargeType === 'small' ? '#1e3a5f' : '#d94545',
              marginBottom: '4px',
              fontWeight: 'bold'
            }}>
              Active: {data.active}
            </div>
            <div style={{
              fontFamily: 'Work Sans, sans-serif',
              fontSize: '11px',
              color: '#f59e0b',
              marginBottom: '8px'
            }}>
              On-Site: {data.onSite}
            </div>
            {data.activeBargeIds && data.activeBargeIds.length > 0 && (
              <div style={{
                marginTop: '8px',
                paddingTop: '8px',
                borderTop: '1px solid #1a1a1a'
              }}>
                <div style={{
                  fontFamily: 'IBM Plex Mono, monospace',
                  fontSize: '10px',
                  fontWeight: 'bold',
                  color: '#1a1a1a',
                  marginBottom: '4px'
                }}>
                  Active Barges:
                </div>
                <div style={{
                  fontFamily: 'IBM Plex Mono, monospace',
                  fontSize: '10px',
                  color: '#6b7280',
                  maxHeight: '100px',
                  overflowY: 'auto'
                }}>
                  {data.activeBargeIds.map((id, idx) => (
                    <div key={idx}>{id}</div>
                  ))}
                </div>
              </div>
            )}
          </div>
        );
      };

      // Custom legend: rectangle for bars, line for lines
      const renderLegend = (props) => {
        const { payload } = props;
        return (
          <div style={{ display: 'flex', justifyContent: 'center', gap: '20px', marginTop: '16px' }}>
            {payload.map((entry, index) => {
              const isLine = entry.value === "On-Site";
              return (
                <div key={`legend-${index}`} style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                  {isLine ? (
                    <svg width="20" height="14" style={{ marginRight: '2px' }}>
                      <line x1="0" y1="7" x2="20" y2="7" stroke={entry.color} strokeWidth="2" />
                    </svg>
                  ) : (
                    <svg width="14" height="14" style={{ marginRight: '2px' }}>
                      <rect width="14" height="14" fill={entry.color} stroke="var(--color-5-blue-gray)" strokeWidth="1" />
                    </svg>
                  )}
                  <span style={{
                    color: 'var(--color-5-blue-gray)',
                    fontSize: '12px',
                    fontFamily: 'Work Sans, sans-serif'
                  }}>
                    {entry.value}
                  </span>
                </div>
              );
            })}
          </div>
        );
      };

      return (
        <div>
          <h3 style={{
            fontFamily: 'Bebas Neue, sans-serif',
            fontSize: '1rem',
            letterSpacing: '0.05em',
            textTransform: 'uppercase',
            marginBottom: '12px',
            color: '#1a1a1a'
          }}>
            {title}
            <span style={{
              fontSize: '0.65rem',
              color: '#6b7280',
              fontWeight: '400',
              marginLeft: '8px',
              fontFamily: 'IBM Plex Mono, monospace',
              textTransform: 'none',
              letterSpacing: 'normal'
            }}>Active vs On-Site</span>
          </h3>
          <ResponsiveContainer width="100%" height={180}>
            <ComposedChart data={chartData}>
              <CartesianGrid strokeDasharray="3 3" stroke="#1a1a1a" strokeOpacity={0.2} />
              <XAxis dataKey="date" tick={{ fontSize: 10, fill: '#6b7280', fontFamily: 'IBM Plex Mono, monospace' }} />
              <YAxis domain={[0, maxValue || 'auto']} tick={{ fill: '#6b7280', fontSize: 10, fontFamily: 'IBM Plex Mono, monospace' }} />
              <Tooltip content={<CustomTooltip />} />
              <Legend content={renderLegend} />
              <Bar dataKey="active" fill={bargeType === 'small' ? '#1e3a5f' : '#d94545'} name="Active" opacity={0.8} />
              <Line type="stepAfter" dataKey="onSite" stroke="#f59e0b" strokeWidth={2} name="On-Site" dot={false} />
            </ComposedChart>
          </ResponsiveContainer>
        </div>
      );
    }

    function SourceUtilizationChart({ data, sourceId, flowRate, hoursPerDay }) {
      if (!data || data.length === 0) return null;
      const chartData = data.map(d => {
        const fillHours = d.sourceUtilization?.[sourceId]?.fillHours || 0;
        const switchoutHours = d.sourceUtilization?.[sourceId]?.switchoutHours || 0;
        const totalUsed = fillHours + switchoutHours;

        return {
          date: d.date.slice(5),
          fillHours: parseFloat(fillHours.toFixed(2)),
          switchoutHours: parseFloat(switchoutHours.toFixed(2)),
          totalUsed: parseFloat(totalUsed.toFixed(2))
        };
      });

      const sourceNames = { source1: 'Source 1', source2: 'Source 2', source3: 'Source 3' };

      // Custom tooltip with grungy styling
      const CustomTooltip = ({ active, payload, label }) => {
        if (!active || !payload || payload.length === 0) return null;

        return (
          <div style={{
            background: 'white',
            border: '2px solid var(--color-5-blue-gray)',
            borderRadius: '4px',
            boxShadow: '3px 3px 0 var(--color-5-blue-gray)',
            padding: '12px'
          }}>
            <div style={{
              fontFamily: 'IBM Plex Mono, monospace',
              fontSize: '11px',
              fontWeight: 'bold',
              marginBottom: '8px',
              color: 'var(--color-5-blue-gray)'
            }}>
              {label}
            </div>
            {payload.map((entry, index) => (
              <div key={index} style={{
                fontFamily: 'Work Sans, sans-serif',
                fontSize: '11px',
                color: entry.color,
                marginBottom: '4px'
              }}>
                {entry.name}: {entry.value}h
              </div>
            ))}
          </div>
        );
      };

      // Custom legend
      const renderLegend = (props) => {
        const { payload } = props;
        return (
          <div style={{ display: 'flex', justifyContent: 'center', gap: '16px', marginTop: '12px' }}>
            {payload.map((entry, index) => (
              <div key={`legend-${index}`} style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                <svg width="14" height="14" style={{ marginRight: '2px' }}>
                  <rect width="14" height="14" fill={entry.color} stroke="#1a1a1a" strokeWidth="1" />
                </svg>
                <span style={{
                  color: '#1a1a1a',
                  fontSize: '11px',
                  fontFamily: 'Work Sans, sans-serif'
                }}>
                  {entry.value}
                </span>
              </div>
            ))}
          </div>
        );
      };

      return (
        <div>
          <h3 style={{
            fontFamily: 'Bebas Neue, sans-serif',
            fontSize: '1rem',
            letterSpacing: '0.05em',
            textTransform: 'uppercase',
            marginBottom: '8px',
            color: '#1a1a1a'
          }}>
            {sourceNames[sourceId]}
          </h3>
          <div style={{
            fontSize: '0.7rem',
            color: '#6b7280',
            marginBottom: '12px',
            fontFamily: 'IBM Plex Mono, monospace'
          }}>
            {flowRate} GPM, {hoursPerDay}h/day available
          </div>
          <ResponsiveContainer width="100%" height={120}>
            <BarChart data={chartData}>
              <CartesianGrid strokeDasharray="3 3" stroke="#1a1a1a" strokeOpacity={0.2} />
              <XAxis dataKey="date" tick={{ fontSize: 9, fill: '#6b7280', fontFamily: 'IBM Plex Mono, monospace' }} />
              <YAxis domain={[0, hoursPerDay]} tick={{ fill: '#6b7280', fontSize: 9, fontFamily: 'IBM Plex Mono, monospace' }} />
              <Tooltip content={<CustomTooltip />} />
              <Legend content={renderLegend} />
              <Bar dataKey="fillHours" stackId="a" fill="#2d4f7c" name="Fill" />
              <Bar dataKey="switchoutHours" stackId="a" fill="#c97575" name="Switchout" />
              <ReferenceLine y={hoursPerDay} stroke="#d94545" strokeDasharray="3 3" />
            </BarChart>
          </ResponsiveContainer>
        </div>
      );
    }

    // ============================================================================
    // TABS
    // ============================================================================

    // CHARTS TAB
    function ChartsTab({ result, config }) {
      if (!result) {
        return (
          <div style={{ textAlign: 'center', padding: '64px 0', color: 'var(--text-light)' }}>
            <div className="font-display" style={{ fontSize: '1.5rem', marginBottom: '8px', color: 'var(--text-medium)' }}>No Data Yet</div>
            <div style={{ fontSize: '0.875rem' }}>Run a simulation to see charts</div>
          </div>
        );
      }

      const storageCapacity = (Math.floor(config.numSmallStorageBarges / 3) * config.SMALL_BARGE_VOLUME) +
        (config.numLargeStorage > 0 ? config.LARGE_BARGE_VOLUME : 0);

      return (
        <div style={{ display: 'flex', flexDirection: 'column', gap: '24px' }}>
          {/* Section Header */}
          <div style={{ marginBottom: '8px' }}>
            <div className="section-label">VISUALIZATION</div>
            <div className="font-display" style={{ fontSize: '2rem', fontWeight: '400', letterSpacing: '-0.02em' }}>
              Project Charts
            </div>
            <p style={{ color: 'var(--text-light)', fontSize: '0.875rem', marginTop: '8px' }}>
              A collection of key operational metrics and visualizations.
            </p>
          </div>

          {/* Chart Cards with framed styling */}
          <div className="framed-card" style={{ padding: '24px' }}>
            <ProjectDailyDemandChart data={result.dailyResults} ranDryEvents={result.ranDryEvents} />
          </div>
          <div className="framed-card" style={{ padding: '24px' }}>
            <TugsChart data={result.dailyResults} maxValue={config.numSmallTugs + config.numLargeTransport + 2} />
          </div>
          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '24px' }}>
            <div className="framed-card" style={{ padding: '24px' }}>
              <BargesChart data={result.dailyResults} bargeType="small" maxValue={(config.numSmallTugs * config.SMALL_BARGES_PER_TUG) + config.numSmallStorageBarges + 5} />
            </div>
            <div className="framed-card framed-card-coral" style={{ padding: '24px' }}>
              <BargesChart data={result.dailyResults} bargeType="large" maxValue={config.numLargeTransport + config.numLargeStorage + 2} />
            </div>
          </div>

          {/* Source Utilization Section */}
          <div style={{ marginTop: '16px' }}>
            <div className="section-label">SOURCES</div>
            <div className="font-display" style={{ fontSize: '1.5rem', fontWeight: '400', marginBottom: '16px' }}>
              Utilization
            </div>
          </div>
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '20px' }}>
            <div className="framed-card" style={{ padding: '20px' }}>
              <SourceUtilizationChart data={result.dailyResults} sourceId="source1" flowRate={config.sourceConfig.source1.flowRate} hoursPerDay={config.sourceConfig.source1.hoursPerDay} />
            </div>
            <div className="framed-card framed-card-sage" style={{ padding: '20px' }}>
              <SourceUtilizationChart data={result.dailyResults} sourceId="source2" flowRate={config.sourceConfig.source2.flowRate} hoursPerDay={config.sourceConfig.source2.hoursPerDay} />
            </div>
            <div className="framed-card framed-card-coral" style={{ padding: '20px' }}>
              <SourceUtilizationChart data={result.dailyResults} sourceId="source3" flowRate={config.sourceConfig.source3.flowRate} hoursPerDay={config.sourceConfig.source3.hoursPerDay} />
            </div>
          </div>
        </div>
      );
    }

    // RIG INPUTS & SCHEDULE TAB
    function RigInputsTab({ config, setConfig }) {
      const updateRigConfig = (rigName, key, value) => {
        setConfig(prev => ({
          ...prev,
          rigs: {
            ...prev.rigs,
            [rigName]: {
              ...prev.rigs[rigName],
              [key]: value
            }
          }
        }));
      };

      const updateHDDSchedule = (index, key, value) => {
        setConfig(prev => {
          const newSchedule = [...prev.hddSchedule];
          newSchedule[index] = { ...newSchedule[index], [key]: value };
          return { ...prev, hddSchedule: newSchedule };
        });
      };

      return (
        <div className="space-y-6">
          {/* Rig Consumption Rates - Compact Table Layout */}
          <div className="bg-white rounded-lg shadow p-4">
            <h3 className="font-semibold text-sm mb-3 text-gray-600">Consumption Rates (gal/hr)</h3>
            <table className="w-full text-sm">
              <thead>
                <tr className="text-xs text-gray-500 border-b">
                  <th className="py-2 text-left font-medium w-20">Rig</th>
                  <th className="py-2 text-center font-medium">Pilot</th>
                  <th className="py-2 text-center font-medium">Ream</th>
                  <th className="py-2 text-center font-medium">Swab</th>
                  <th className="py-2 text-center font-medium">Pull</th>
                </tr>
              </thead>
              <tbody>
                {['Blue', 'Green', 'Red'].map(rigName => (
                  <tr key={rigName} className="border-b last:border-b-0">
                    <td className="py-2 font-medium" style={{ color: COLORS[rigName] }}>{rigName}</td>
                    <td className="py-1 px-1">
                      <input type="text" value={config.rigs[rigName].pilot.toLocaleString()} onChange={e => updateRigConfig(rigName, 'pilot', parseInt(e.target.value.replace(/,/g, '')) || 0)} className="input-field text-center w-full" style={{ fontSize: '0.875rem' }} />
                    </td>
                    <td className="py-1 px-1">
                      <input type="text" value={config.rigs[rigName].ream.toLocaleString()} onChange={e => updateRigConfig(rigName, 'ream', parseInt(e.target.value.replace(/,/g, '')) || 0)} className="input-field text-center w-full" style={{ fontSize: '0.875rem' }} />
                    </td>
                    <td className="py-1 px-1">
                      <input type="text" value={config.rigs[rigName].swab.toLocaleString()} onChange={e => updateRigConfig(rigName, 'swab', parseInt(e.target.value.replace(/,/g, '')) || 0)} className="input-field text-center w-full" style={{ fontSize: '0.875rem' }} />
                    </td>
                    <td className="py-1 px-1">
                      <input type="text" value={config.rigs[rigName].pull.toLocaleString()} onChange={e => updateRigConfig(rigName, 'pull', parseInt(e.target.value.replace(/,/g, '')) || 0)} className="input-field text-center w-full" style={{ fontSize: '0.875rem' }} />
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          {/* HDD Schedule */}
          <div className="bg-white rounded-lg shadow p-6">
            <h3 className="font-semibold text-lg mb-4">HDD Schedule (Duration-Based)</h3>
            <div className="overflow-x-auto">
              <table className="min-w-full text-sm">
                <thead>
                  <tr className="bg-gray-100">
                    <th className="px-2 py-1">Rig</th>
                    <th className="px-2 py-1">Crossing</th>
                    <th className="px-2 py-1">Start Date</th>
                    <th className="px-2 py-1">Rig Up (days)</th>
                    <th className="px-2 py-1">Pilot (days)</th>
                    <th className="px-2 py-1">Ream (days)</th>
                    <th className="px-2 py-1">Swab (days)</th>
                    <th className="px-2 py-1">Pull (days)</th>
                    <th className="px-2 py-1">Rig Down (days)</th>
                    <th className="px-2 py-1 bg-blue-50">Src1 (NM)</th>
                    <th className="px-2 py-1 bg-green-50">Src2 (NM)</th>
                    <th className="px-2 py-1 bg-purple-50">Src3 (NM)</th>
                  </tr>
                </thead>
                <tbody>
                  {config.hddSchedule.map((hdd, idx) => {
                    // Calculate distances from each source to this HDD
                    const getDistance = (sourceId, crossing) => {
                      if (typeof MULTI_SOURCE_ROUTES === 'undefined') return '--';
                      const route = MULTI_SOURCE_ROUTES[sourceId]?.routes?.[crossing];
                      if (!route) return '--';

                      // Calculate route distance using Haversine formula
                      let totalDistance = 0;
                      for (let i = 0; i < route.length - 1; i++) {
                        const [lon1, lat1] = route[i];
                        const [lon2, lat2] = route[i + 1];
                        const R = 3440.065; // Earth radius in nautical miles
                        const dLat = (lat2 - lat1) * Math.PI / 180;
                        const dLon = (lon2 - lon1) * Math.PI / 180;
                        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                                  Math.sin(dLon/2) * Math.sin(dLon/2);
                        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                        totalDistance += R * c;
                      }
                      return totalDistance.toFixed(1);
                    };

                    const dist1 = getDistance('source1', hdd.crossing);
                    const dist2 = getDistance('source2', hdd.crossing);
                    const dist3 = getDistance('source3', hdd.crossing);

                    return (
                      <tr key={idx} className="border-b">
                        <td className="px-2 py-1" style={{ color: COLORS[hdd.rig] }}>{hdd.rig}</td>
                        <td className="px-2 py-1 font-mono">{hdd.crossing}</td>
                        <td className="px-1 py-1"><input type="date" value={hdd.startDate} onChange={e => updateHDDSchedule(idx, 'startDate', e.target.value)} className="text-xs border rounded px-1" /></td>
                        <td className="px-1 py-1"><input type="number" value={hdd.rigUpDays} onChange={e => updateHDDSchedule(idx, 'rigUpDays', parseInt(e.target.value) || 0)} min="0" className="text-xs border rounded px-1 w-16" /></td>
                        <td className="px-1 py-1"><input type="number" value={hdd.pilotDays} onChange={e => updateHDDSchedule(idx, 'pilotDays', parseInt(e.target.value) || 0)} min="0" className="text-xs border rounded px-1 w-16" /></td>
                        <td className="px-1 py-1"><input type="number" value={hdd.reamDays} onChange={e => updateHDDSchedule(idx, 'reamDays', parseInt(e.target.value) || 0)} min="0" className="text-xs border rounded px-1 w-16" /></td>
                        <td className="px-1 py-1"><input type="number" value={hdd.swabDays} onChange={e => updateHDDSchedule(idx, 'swabDays', parseInt(e.target.value) || 0)} min="0" className="text-xs border rounded px-1 w-16" /></td>
                        <td className="px-1 py-1"><input type="number" value={hdd.pullDays} onChange={e => updateHDDSchedule(idx, 'pullDays', parseInt(e.target.value) || 0)} min="0" className="text-xs border rounded px-1 w-16" /></td>
                        <td className="px-1 py-1"><input type="number" value={hdd.rigDownDays} onChange={e => updateHDDSchedule(idx, 'rigDownDays', parseInt(e.target.value) || 0)} min="0" className="text-xs border rounded px-1 w-16" /></td>
                        <td className="px-2 py-1 text-center bg-blue-50 text-gray-700">{dist1}</td>
                        <td className="px-2 py-1 text-center bg-green-50 text-gray-700">{dist2}</td>
                        <td className="px-2 py-1 text-center bg-purple-50 text-gray-700">{dist3}</td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      );
    }

    // COST MODEL TAB
    function CostModelTab({ result, optimizationResults, config, setConfig, runOptimization, isRunning }) {
      const updateConfig = (key, value) => {
        setConfig(prev => ({ ...prev, [key]: value }));
      };

      const formatCurrency = (val) => `$${Math.round(val).toLocaleString()}`;

      return (
        <div style={{ display: 'flex', flexDirection: 'column', gap: '32px' }}>
          {/* Section Header */}
          <div>
            <div className="section-label">FINANCIAL</div>
            <div className="font-display" style={{ fontSize: '2rem', fontWeight: '700', letterSpacing: '-0.02em' }}>
              Cost Model
            </div>
            <p style={{ color: 'var(--text-light)', fontSize: '0.875rem', marginTop: '8px' }}>
              Configure pricing parameters and optimize fleet composition.
            </p>
          </div>

          {/* Cost Parameters - Compact Grid */}
          <div className="framed-card" style={{ padding: '20px' }}>
            <h3 className="font-display" style={{ fontSize: '1rem', fontWeight: '600', marginBottom: '16px' }}>Cost Parameters</h3>
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: '8px 16px' }}>
              <NumberInput label="Fuel Price" value={config.FUEL_PRICE_PER_GAL} onChange={v => updateConfig('FUEL_PRICE_PER_GAL', v)} step={0.01} unit="/gal" isCurrency={true} decimals={2} />
              <NumberInput label="Downtime Rate" value={config.DOWNTIME_HOURLY_RATE} onChange={v => updateConfig('DOWNTIME_HOURLY_RATE', v)} unit="/hr" isCurrency={true} />
              <NumberInput label="Tug Day Rate" value={config.TUG_DAY_RATE} onChange={v => updateConfig('TUG_DAY_RATE', v)} isCurrency={true} />
              <NumberInput label="Lg Barge Day Rate" value={config.LARGE_BARGE_DAY_RATE} onChange={v => updateConfig('LARGE_BARGE_DAY_RATE', v)} isCurrency={true} />
              <NumberInput label="Sm Barge Day Rate" value={config.SMALL_BARGE_DAY_RATE} onChange={v => updateConfig('SMALL_BARGE_DAY_RATE', v)} isCurrency={true} />
              <NumberInput label="Tug Mob Cost" value={config.TUG_MOB_COST} onChange={v => updateConfig('TUG_MOB_COST', v)} isCurrency={true} />
              <NumberInput label="Tug Demob Cost" value={config.TUG_DEMOB_COST} onChange={v => updateConfig('TUG_DEMOB_COST', v)} isCurrency={true} />
              <NumberInput label="Barge Mob Days" value={config.BARGE_MOB_DEMOB_COST_DAYS} onChange={v => updateConfig('BARGE_MOB_DEMOB_COST_DAYS', v)} unit="days" />
              <NumberInput label="Fuel (Idle)" value={config.TUG_FUEL_IDLE_GPH} onChange={v => updateConfig('TUG_FUEL_IDLE_GPH', v)} unit="gal/hr" />
              <NumberInput label="Fuel (Running)" value={config.TUG_FUEL_RUNNING_GPH} onChange={v => updateConfig('TUG_FUEL_RUNNING_GPH', v)} unit="gal/hr" />
            </div>

            {/* Water Acquisition Costs */}
            <div style={{ marginTop: '16px', paddingTop: '16px', borderTop: '1px solid var(--border-subtle)' }}>
              <h4 style={{ fontSize: '0.8rem', fontWeight: '600', marginBottom: '12px', color: 'var(--text-medium)' }}>Water Acquisition Costs</h4>
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '8px 16px' }}>
                <NumberInput label="Source 1" value={config.WATER_COST_SOURCE1} onChange={v => updateConfig('WATER_COST_SOURCE1', v)} step={0.01} unit="/gal" isCurrency={true} decimals={4} />
                <NumberInput label="Source 2" value={config.WATER_COST_SOURCE2} onChange={v => updateConfig('WATER_COST_SOURCE2', v)} step={0.01} unit="/gal" isCurrency={true} decimals={4} />
                <NumberInput label="Source 3" value={config.WATER_COST_SOURCE3} onChange={v => updateConfig('WATER_COST_SOURCE3', v)} step={0.01} unit="/gal" isCurrency={true} decimals={4} />
              </div>
            </div>

            {/* Optimize Button */}
            <div style={{ marginTop: '32px', textAlign: 'center' }}>
              <button
                onClick={runOptimization}
                disabled={isRunning}
                className="btn-primary"
                style={{ padding: '14px 48px' }}
              >
                {isRunning ? 'Running...' : 'Optimize Fleet'}
              </button>
              <div style={{ fontSize: '0.7rem', color: 'var(--text-light)', marginTop: '12px' }}>
                Tests ~20 configurations around current fleet to find lower-cost options
              </div>
            </div>
          </div>

          {/* Current Simulation Cost Breakdown */}
          {result && (
            <div className="framed-card framed-card-coral" style={{ padding: '32px' }}>
              <h3 className="font-display" style={{ fontSize: '1.25rem', fontWeight: '600', marginBottom: '24px' }}>Current Simulation Costs</h3>

              {/* Cost Grid - Portfolio Style */}
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '16px', marginBottom: '24px' }}>
                {/* Daily Rentals */}
                <div style={{ padding: '20px', border: '1px solid var(--border-subtle)', textAlign: 'center' }}>
                  <div style={{ fontSize: '0.65rem', color: 'var(--text-light)', textTransform: 'uppercase', letterSpacing: '0.1em', marginBottom: '8px' }}>Tug Daily</div>
                  <div style={{ fontSize: '1.5rem', fontWeight: '700', fontFamily: "'Playfair Display', serif" }}>{formatCurrency(result.costs.tugRental)}</div>
                </div>
                <div style={{ padding: '20px', border: '1px solid var(--border-subtle)', textAlign: 'center' }}>
                  <div style={{ fontSize: '0.65rem', color: 'var(--text-light)', textTransform: 'uppercase', letterSpacing: '0.1em', marginBottom: '8px' }}>Small Barge Daily</div>
                  <div style={{ fontSize: '1.5rem', fontWeight: '700', fontFamily: "'Playfair Display', serif" }}>{formatCurrency(result.costs.smallBargeRental)}</div>
                </div>
                <div style={{ padding: '20px', border: '1px solid var(--border-subtle)', textAlign: 'center' }}>
                  <div style={{ fontSize: '0.65rem', color: 'var(--text-light)', textTransform: 'uppercase', letterSpacing: '0.1em', marginBottom: '8px' }}>Large Barge Daily</div>
                  <div style={{ fontSize: '1.5rem', fontWeight: '700', fontFamily: "'Playfair Display', serif" }}>{formatCurrency(result.costs.largeBargeRental)}</div>
                </div>
              </div>

              {/* Mob/Demob */}
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '16px', marginBottom: '24px' }}>
                <div style={{ padding: '16px', background: 'var(--surface-light)', textAlign: 'center' }}>
                  <div style={{ fontSize: '0.6rem', color: 'var(--text-light)', textTransform: 'uppercase', letterSpacing: '0.1em', marginBottom: '6px' }}>Tug Mob/Demob</div>
                  <div style={{ fontSize: '1.25rem', fontWeight: '600' }}>{formatCurrency(result.costs.mobDemobBreakdown?.tugs || 0)}</div>
                </div>
                <div style={{ padding: '16px', background: 'var(--surface-light)', textAlign: 'center' }}>
                  <div style={{ fontSize: '0.6rem', color: 'var(--text-light)', textTransform: 'uppercase', letterSpacing: '0.1em', marginBottom: '6px' }}>Sm Barge Mob/Demob</div>
                  <div style={{ fontSize: '1.25rem', fontWeight: '600' }}>{formatCurrency(result.costs.mobDemobBreakdown?.smallBarges || 0)}</div>
                </div>
                <div style={{ padding: '16px', background: 'var(--surface-light)', textAlign: 'center' }}>
                  <div style={{ fontSize: '0.6rem', color: 'var(--text-light)', textTransform: 'uppercase', letterSpacing: '0.1em', marginBottom: '6px' }}>Lg Barge Mob/Demob</div>
                  <div style={{ fontSize: '1.25rem', fontWeight: '600' }}>{formatCurrency(result.costs.mobDemobBreakdown?.largeBarges || 0)}</div>
                </div>
              </div>

              {/* Operational Costs */}
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '16px', marginBottom: '32px' }}>
                <div style={{ padding: '16px', borderLeft: '3px solid var(--accent-warm)', textAlign: 'center' }}>
                  <div style={{ fontSize: '0.6rem', color: 'var(--text-light)', textTransform: 'uppercase', letterSpacing: '0.1em', marginBottom: '6px' }}>Fuel</div>
                  <div style={{ fontSize: '1.25rem', fontWeight: '600', color: 'var(--accent-warm)' }}>{formatCurrency(result.costs.fuelTotal)}</div>
                </div>
                <div style={{ padding: '16px', borderLeft: '3px solid var(--accent-coral)', textAlign: 'center' }}>
                  <div style={{ fontSize: '0.6rem', color: 'var(--text-light)', textTransform: 'uppercase', letterSpacing: '0.1em', marginBottom: '6px' }}>Downtime</div>
                  <div style={{ fontSize: '1.25rem', fontWeight: '600', color: 'var(--accent-coral)' }}>{formatCurrency(result.costs.downtimeTotal)}</div>
                </div>
                <div style={{ padding: '16px', borderLeft: '3px solid var(--oneok-blue)', textAlign: 'center' }}>
                  <div style={{ fontSize: '0.6rem', color: 'var(--text-light)', textTransform: 'uppercase', letterSpacing: '0.1em', marginBottom: '6px' }}>Water Acquisition</div>
                  <div style={{ fontSize: '1.25rem', fontWeight: '600', color: 'var(--oneok-blue)' }}>{formatCurrency(result.costs.waterTotal || 0)}</div>
                </div>
              </div>

              {/* Total Cost - Featured Display */}
              <div style={{ position: 'relative', textAlign: 'center', padding: '40px 32px', background: 'var(--whc-navy)', color: 'white' }}>
                <div className="decorative-dots" style={{ top: '-20px', right: '-20px', opacity: '0.1' }}></div>
                <div style={{ fontSize: '0.7rem', fontWeight: '700', textTransform: 'uppercase', letterSpacing: '0.2em', marginBottom: '12px', opacity: '0.7' }}>Total Project Cost</div>
                <div className="font-display" style={{ fontSize: '3rem', fontWeight: '700', letterSpacing: '-0.02em' }}>{formatCurrency(result.costs.grandTotal)}</div>
                <div style={{ marginTop: '20px', paddingTop: '20px', borderTop: '1px solid rgba(255,255,255,0.2)', display: 'flex', justifyContent: 'center', gap: '32px', fontSize: '0.75rem' }}>
                  <div><span style={{ opacity: '0.7' }}>Equipment:</span> <strong>{formatCurrency(result.costs.equipmentTotal)}</strong></div>
                  <div><span style={{ opacity: '0.7' }}>Fuel:</span> <strong>{formatCurrency(result.costs.fuelTotal)}</strong></div>
                  <div><span style={{ opacity: '0.7' }}>Water:</span> <strong>{formatCurrency(result.costs.waterTotal)}</strong></div>
                </div>
              </div>
            </div>
          )}

          {/* Optimization Results */}
          {optimizationResults && optimizationResults.top15 && optimizationResults.top15.length > 0 && (
            <div className="framed-card" style={{ padding: '32px' }}>
              <h3 className="font-display" style={{ fontSize: '1.25rem', fontWeight: '600', marginBottom: '8px' }}>
                Optimization Results
              </h3>
              <p style={{ fontSize: '0.75rem', color: 'var(--text-light)', marginBottom: '24px' }}>
                {optimizationResults.successCount} successful / {optimizationResults.totalTested} tested
              </p>

              <h4 className="font-medium mb-2">Top 15 Configurations - Cost Breakdown by Asset Type</h4>
              <p className="text-xs text-gray-600 mb-3">
                <span className="inline-block bg-green-50 px-2 py-0.5 rounded mr-2">Green</span> = Recommended (zero ran dry)
                <span className="inline-block bg-blue-50 px-2 py-0.5 rounded mr-2 ml-3">Blue</span> = Acceptable (&lt; 8h downtime)
                <span className="inline-block bg-red-50 px-2 py-0.5 rounded ml-3">Red/Strikethrough</span> = Excessive downtime (&gt; 8h)
              </p>
              <div className="overflow-x-auto">
                <table className="min-w-full text-xs">
                  <thead>
                    <tr className="bg-gray-100">
                      <th className="px-2 py-2 text-center border-r-2 border-gray-300">Rank</th>
                      <th className="px-2 py-2 text-center">Tugs</th>
                      <th className="px-2 py-2 text-center">Sm Trans</th>
                      <th className="px-2 py-2 text-center">Sm Store</th>
                      <th className="px-2 py-2 text-center">Lg Trans</th>
                      <th className="px-2 py-2 text-center border-r-2 border-gray-300">Lg Store</th>
                      <th className="px-2 py-2 text-right">Tug Daily</th>
                      <th className="px-2 py-2 text-right">Sm Brg Daily</th>
                      <th className="px-2 py-2 text-right border-r-2 border-gray-300">Lg Brg Daily</th>
                      <th className="px-2 py-2 text-right">Tug Mob/Dmb</th>
                      <th className="px-2 py-2 text-right">Sm Brg Mob/Dmb</th>
                      <th className="px-2 py-2 text-right border-r-2 border-gray-300">Lg Brg Mob/Dmb</th>
                      <th className="px-2 py-2 text-right">Fuel</th>
                      <th className="px-2 py-2 text-right">Downtime</th>
                      <th className="px-2 py-2 text-right border-r-2 border-gray-300">Water</th>
                      <th className="px-2 py-2 text-right font-semibold bg-blue-50">Total Cost</th>
                    </tr>
                  </thead>
                  <tbody>
                    {optimizationResults.top15.map((r, idx) => {
                      // Show configs with zero ran dry OR < 8h downtime without strikethrough
                      const ACCEPTABLE_DOWNTIME_HOURS = 8;
                      const isAcceptable = r.ranDryCount === 0 || (r.downtimeHours !== undefined && r.downtimeHours < ACCEPTABLE_DOWNTIME_HOURS);
                      const hasExcessiveDowntime = !isAcceptable;
                      const strikeClass = hasExcessiveDowntime ? 'line-through text-gray-400' : '';
                      const isZeroRanDry = r.ranDryCount === 0;
                      return (
                        <tr key={idx} className={`border-b ${idx === 0 ? 'bg-green-50' : ''} ${hasExcessiveDowntime ? 'bg-red-50' : !isZeroRanDry ? 'bg-blue-50' : ''}`}>
                          <td className={`px-2 py-2 text-center font-medium border-r-2 border-gray-300 ${strikeClass}`}>{idx === 0 ? 'BEST' : idx + 1}</td>
                          <td className={`px-2 py-2 text-center ${strikeClass}`}>{r.config.numSmallTugs}</td>
                          <td className={`px-2 py-2 text-center ${strikeClass}`}>{r.config.numSmallTransportBarges}</td>
                          <td className={`px-2 py-2 text-center ${strikeClass}`}>{r.config.numSmallStorageBarges}</td>
                          <td className={`px-2 py-2 text-center ${strikeClass}`}>{r.config.numLargeTransport}</td>
                          <td className={`px-2 py-2 text-center border-r-2 border-gray-300 ${strikeClass}`}>{r.config.numLargeStorage}</td>
                          <td className={`px-2 py-2 text-right ${strikeClass}`}>{formatCurrency(r.costs.tugRental)}</td>
                          <td className={`px-2 py-2 text-right ${strikeClass}`}>{formatCurrency(r.costs.smallBargeRental)}</td>
                          <td className={`px-2 py-2 text-right border-r-2 border-gray-300 ${strikeClass}`}>{formatCurrency(r.costs.largeBargeRental)}</td>
                          <td className={`px-2 py-2 text-right ${strikeClass}`}>{formatCurrency(r.costs.mobDemobBreakdown.tugs)}</td>
                          <td className={`px-2 py-2 text-right ${strikeClass}`}>{formatCurrency(r.costs.mobDemobBreakdown.smallBarges)}</td>
                          <td className={`px-2 py-2 text-right border-r-2 border-gray-300 ${strikeClass}`}>{formatCurrency(r.costs.mobDemobBreakdown.largeBarges)}</td>
                          <td className={`px-2 py-2 text-right ${strikeClass}`}>{formatCurrency(r.costs.fuelTotal)}</td>
                          <td className={`px-2 py-2 text-right ${strikeClass}`}>{formatCurrency(r.costs.downtimeTotal)}</td>
                          <td className={`px-2 py-2 text-right border-r-2 border-gray-300 ${strikeClass}`}>{formatCurrency(r.costs.waterTotal || 0)}</td>
                          <td className={`px-2 py-2 text-right font-semibold bg-blue-50 ${strikeClass}`}>{formatCurrency(r.costs.grandTotal)}</td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            </div>
          )}

          {/* Cost-Per-Gallon Analysis */}
          {result && result.costPerGallonHistory && Object.keys(result.costPerGallonHistory).length > 0 && (
            <div className="bg-white rounded-lg shadow p-6">
              <h3 className="font-semibold text-lg mb-4">Cost Per Gallon Analysis - Delivered Water Cost by Source-Destination</h3>
              <p className="text-sm text-gray-600 mb-4">
                Shows true delivered cost including acquisition, queue time, fill time, transit time, and fuel. Lower cost = more economical route.
              </p>

              <div className="overflow-x-auto">
                <table className="min-w-full text-xs">
                  <thead>
                    <tr className="bg-gray-100">
                      <th className="px-3 py-2 text-left">Route</th>
                      <th className="px-3 py-2 text-right">Deliveries</th>
                      <th className="px-3 py-2 text-right">Avg Cost/Gal</th>
                      <th className="px-3 py-2 text-right">Min Cost/Gal</th>
                      <th className="px-3 py-2 text-right">Max Cost/Gal</th>
                      <th className="px-3 py-2 text-right">Avg Queue (hrs)</th>
                      <th className="px-3 py-2 text-right">Total Water (K gal)</th>
                    </tr>
                  </thead>
                  <tbody>
                    {Object.entries(result.costPerGallonHistory)
                      .sort(([a], [b]) => a.localeCompare(b))
                      .map(([route, journeys]) => {
                        const avgCost = journeys.reduce((sum, j) => sum + j.costPerGallon, 0) / journeys.length;
                        const minCost = Math.min(...journeys.map(j => j.costPerGallon));
                        const maxCost = Math.max(...journeys.map(j => j.costPerGallon));
                        const avgQueue = journeys.reduce((sum, j) => sum + j.queueTime, 0) / journeys.length;
                        const totalWater = journeys.reduce((sum, j) => sum + j.waterVolume, 0);

                        return (
                          <tr key={route} className="border-b hover:bg-gray-50">
                            <td className="px-3 py-2 font-medium">{route}</td>
                            <td className="px-3 py-2 text-right">{journeys.length}</td>
                            <td className="px-3 py-2 text-right">${avgCost.toFixed(4)}</td>
                            <td className="px-3 py-2 text-right text-green-600">${minCost.toFixed(4)}</td>
                            <td className="px-3 py-2 text-right text-red-600">${maxCost.toFixed(4)}</td>
                            <td className="px-3 py-2 text-right">{avgQueue.toFixed(1)}</td>
                            <td className="px-3 py-2 text-right">{Math.round(totalWater / 1000).toLocaleString()}</td>
                          </tr>
                        );
                      })}
                  </tbody>
                </table>
              </div>

              <div className="mt-4 text-xs text-gray-500">
                <strong>Note:</strong> Cost includes water acquisition ($/gal at source) + equipment daily rates during queue/fill/transit + fuel.
                Higher queue times indicate source congestion - simulator will prefer less congested sources when economical.
              </div>
            </div>
          )}
        </div>
      );
    }

    // RIG STORAGE TAB - Shows hourly water flow with injections (up) and withdrawals (down)
    function RigStorageTab({ result, config }) {
      // Date range state for each HDD (stored by crossing name)
      const [dateRanges, setDateRanges] = React.useState({});

      if (!result || !result.hddStorageTimeline) {
        return (
          <div className="text-center py-8 text-gray-500">
            Run a simulation to see HDD storage status
          </div>
        );
      }

      // Get all HDDs from config schedule to ensure none are missing
      const scheduledHDDs = config.hddSchedule || [];

      // Group timeline data by rig
      const groupedByRig = {
        Blue: result.hddStorageTimeline.filter(h => h.rig === 'Blue'),
        Green: result.hddStorageTimeline.filter(h => h.rig === 'Green'),
        Red: result.hddStorageTimeline.filter(h => h.rig === 'Red')
      };

      // Also group scheduled HDDs by rig to check for missing ones
      const scheduledByRig = {
        Blue: scheduledHDDs.filter(h => h.rig === 'Blue'),
        Green: scheduledHDDs.filter(h => h.rig === 'Green'),
        Red: scheduledHDDs.filter(h => h.rig === 'Red')
      };

      // Custom tooltip for the new chart format
      const CustomTooltip = ({ active, payload, label }) => {
        if (!active || !payload || payload.length === 0) return null;
        const data = payload[0]?.payload;
        if (!data) return null;

        return (
          <div className="bg-white border border-gray-300 rounded shadow-lg p-2 text-xs">
            <div className="font-semibold">{data.date} {data.hour}:00 - {data.stage}</div>
            <div className="text-blue-600">Storage: {(data.storageLevel / 1000).toFixed(1)}K gal</div>
            <div className="text-gray-500">Capacity: {(data.storageCapacity / 1000).toFixed(1)}K gal</div>
            {data.injectionGallons > 0 && (
              <div className="text-green-600">
                Injection: +{(data.injectionGallons / 1000).toFixed(1)}K gal
                {data.injectionBargeLabels?.length > 0 && (
                  <span className="ml-1 text-gray-500">({data.injectionBargeLabels.join(', ')})</span>
                )}
              </div>
            )}
            {data.withdrawalGallons > 0 && (
              <div className="text-red-600">Withdrawal: -{(data.withdrawalGallons / 1000).toFixed(1)}K gal</div>
            )}
            {data.storageBargeIds?.length > 0 && (
              <div className="text-purple-600 text-xs">Storage: {data.storageBargeIds.join(', ')}</div>
            )}
          </div>
        );
      };

      return (
        <div className="space-y-4">
          {/* SHARED LEGEND - Only rendered once at the top */}
          <div style={{
            background: 'white',
            borderRadius: '8px',
            padding: '16px',
            border: '2px solid #1a1a1a',
            boxShadow: '3px 3px 0 #1a1a1a'
          }}>
            <div style={{
              display: 'flex',
              flexWrap: 'wrap',
              alignItems: 'center',
              gap: '24px 32px',
              fontSize: '11px'
            }}>
              {/* Data Legend */}
              <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                <span style={{
                  fontFamily: 'IBM Plex Mono, monospace',
                  fontWeight: 'bold',
                  color: '#1a1a1a'
                }}>Data:</span>
                <span style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                  <span style={{
                    width: '12px',
                    height: '12px',
                    borderRadius: '2px',
                    backgroundColor: '#22c55e',
                    border: '1px solid #1a1a1a'
                  }}></span>
                  <span style={{ fontFamily: 'Work Sans, sans-serif' }}>Injection</span>
                </span>
                <span style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                  <span style={{
                    width: '12px',
                    height: '12px',
                    borderRadius: '2px',
                    backgroundColor: '#ef4444',
                    border: '1px solid #1a1a1a'
                  }}></span>
                  <span style={{ fontFamily: 'Work Sans, sans-serif' }}>Withdrawal</span>
                </span>
                <span style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                  <span style={{
                    width: '16px',
                    height: '2px',
                    borderTop: '2px dashed #8b5cf6'
                  }}></span>
                  <span style={{ fontFamily: 'Work Sans, sans-serif' }}>Capacity</span>
                </span>
                <span style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                  <span style={{
                    width: '20px',
                    height: '2px',
                    backgroundColor: '#1a1a1a'
                  }}></span>
                  <span style={{ fontFamily: 'Work Sans, sans-serif' }}>Storage Level</span>
                </span>
              </div>

              {/* Stage Legend */}
              <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                <span style={{
                  fontFamily: 'IBM Plex Mono, monospace',
                  fontWeight: 'bold',
                  color: '#1a1a1a',
                  borderLeft: '2px solid #1a1a1a',
                  paddingLeft: '16px'
                }}>Stages:</span>
                <span style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                  <span style={{
                    width: '10px',
                    height: '10px',
                    borderRadius: '2px',
                    backgroundColor: '#fbbf24',
                    border: '1px solid #1a1a1a'
                  }}></span>
                  <span style={{ fontFamily: 'Work Sans, sans-serif' }}>RigUp</span>
                </span>
                <span style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                  <span style={{
                    width: '10px',
                    height: '10px',
                    borderRadius: '2px',
                    backgroundColor: '#3b82f6',
                    border: '1px solid #1a1a1a'
                  }}></span>
                  <span style={{ fontFamily: 'Work Sans, sans-serif' }}>Pilot</span>
                </span>
                <span style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                  <span style={{
                    width: '10px',
                    height: '10px',
                    borderRadius: '2px',
                    backgroundColor: '#10b981',
                    border: '1px solid #1a1a1a'
                  }}></span>
                  <span style={{ fontFamily: 'Work Sans, sans-serif' }}>Ream</span>
                </span>
                <span style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                  <span style={{
                    width: '10px',
                    height: '10px',
                    borderRadius: '2px',
                    backgroundColor: '#f97316',
                    border: '1px solid #1a1a1a'
                  }}></span>
                  <span style={{ fontFamily: 'Work Sans, sans-serif' }}>Swab</span>
                </span>
                <span style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                  <span style={{
                    width: '10px',
                    height: '10px',
                    borderRadius: '2px',
                    backgroundColor: '#8b5cf6',
                    border: '1px solid #1a1a1a'
                  }}></span>
                  <span style={{ fontFamily: 'Work Sans, sans-serif' }}>Pull</span>
                </span>
                <span style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                  <span style={{
                    width: '10px',
                    height: '10px',
                    borderRadius: '2px',
                    backgroundColor: '#6b7280',
                    border: '1px solid #1a1a1a'
                  }}></span>
                  <span style={{ fontFamily: 'Work Sans, sans-serif' }}>RigDown</span>
                </span>
              </div>

              {/* Special indicators */}
              <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                <span style={{
                  fontFamily: 'IBM Plex Mono, monospace',
                  fontWeight: 'bold',
                  color: '#1a1a1a',
                  borderLeft: '2px solid #1a1a1a',
                  paddingLeft: '16px'
                }}>Special:</span>
                <span style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                  <span style={{
                    width: '10px',
                    height: '10px',
                    borderRadius: '2px',
                    border: '1px solid #1a1a1a',
                    background: 'repeating-linear-gradient(45deg, transparent, transparent 2px, rgba(0,0,0,0.3) 2px, rgba(0,0,0,0.3) 4px)'
                  }}></span>
                  <span style={{ fontFamily: 'Work Sans, sans-serif' }}>Sunday</span>
                </span>
                <span style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                  <span style={{
                    width: '10px',
                    height: '10px',
                    borderRadius: '2px',
                    backgroundColor: 'rgba(220, 38, 38, 0.5)',
                    border: '1px solid #1a1a1a'
                  }}></span>
                  <span style={{ fontFamily: 'Work Sans, sans-serif' }}>Ran Dry</span>
                </span>
              </div>
            </div>
            <div style={{
              fontSize: '10px',
              color: '#6b7280',
              marginTop: '8px',
              fontFamily: 'IBM Plex Mono, monospace'
            }}>
              Darker shading = night hours, Lighter = working hours (7AM-5PM)
            </div>
          </div>

          {/* Charts by Rig */}
          {['Blue', 'Green', 'Red'].map(rigName => {
            const rigHDDs = groupedByRig[rigName];
            const scheduledRigHDDs = scheduledByRig[rigName];

            // Check for missing HDDs (scheduled but no timeline data)
            const timelineCrossings = new Set(rigHDDs.map(h => h.crossing));
            const missingHDDs = scheduledRigHDDs.filter(h => !timelineCrossings.has(h.crossing));

            if (rigHDDs.length === 0 && missingHDDs.length === 0) return null;

            const color = COLORS[rigName];

            return (
              <div key={rigName} className="space-y-2">
                <h2 style={{
                  fontSize: '1.125rem',
                  fontFamily: 'Bebas Neue, sans-serif',
                  letterSpacing: '0.05em',
                  textTransform: 'uppercase',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px',
                  color
                }}>
                  <span style={{
                    width: '12px',
                    height: '12px',
                    borderRadius: '50%',
                    backgroundColor: color,
                    border: '2px solid #1a1a1a'
                  }}></span>
                  {rigName} Rig
                  <span style={{
                    fontSize: '0.75rem',
                    fontWeight: 'normal',
                    color: '#6b7280',
                    fontFamily: 'IBM Plex Mono, monospace',
                    textTransform: 'none',
                    letterSpacing: 'normal'
                  }}>({rigHDDs.length} crossings)</span>
                </h2>

                {/* Show missing HDDs warning */}
                {missingHDDs.length > 0 && (
                  <div className="text-xs text-amber-600 bg-amber-50 px-2 py-1 rounded">
                    ⚠️ Missing data for: {missingHDDs.map(h => h.crossing).join(', ')}
                  </div>
                )}

                {rigHDDs.map(hdd => {
                  if (!hdd || !hdd.hourlyData || hdd.hourlyData.length === 0) return null;

                  // Get unique dates from the data
                  const allDates = [...new Set(hdd.hourlyData.map(d => d.date))].sort();
                  const minDateIdx = 0;
                  const maxDateIdx = allDates.length - 1;

                  // Initialize date range for this HDD if not set (use indices)
                  const crossingKey = `${rigName}-${hdd.crossing}`;
                  if (!dateRanges[crossingKey]) {
                    setDateRanges(prev => ({
                      ...prev,
                      [crossingKey]: { startIdx: minDateIdx, endIdx: maxDateIdx }
                    }));
                  }

                  const currentRange = dateRanges[crossingKey] || { startIdx: minDateIdx, endIdx: maxDateIdx };

                  // Filter data based on date range (using indices)
                  const startDate = allDates[currentRange.startIdx];
                  const endDate = allDates[currentRange.endIdx];
                  const filteredData = hdd.hourlyData.filter(d =>
                    d.date >= startDate && d.date <= endDate
                  );

                  // Prepare chart data - convert withdrawal to negative for downward bars
                  const chartData = filteredData.map((d, index) => ({
                    ...d,
                    index, // Re-index after filtering
                    injectionK: d.injectionGallons / 1000,
                    withdrawalK: -(d.withdrawalGallons / 1000), // Negative for downward bars
                    storageLevelK: d.storageLevel / 1000,
                    storageCapacityK: d.storageCapacity / 1000
                  }));

                  // Calculate Y-axis domain (auto-scale based on data)
                  const maxInjection = Math.max(...chartData.map(d => d.injectionK || 0));
                  const maxWithdrawal = Math.max(...chartData.map(d => Math.abs(d.withdrawalK) || 0));
                  const maxCapacity = Math.max(...chartData.map(d => d.storageCapacityK || 0));
                  const maxStorage = Math.max(...chartData.map(d => d.storageLevelK || 0));
                  const yMax = Math.ceil(Math.max(maxInjection, maxCapacity, maxStorage) / 50) * 50 + 50;
                  const yMin = Math.floor(-maxWithdrawal / 20) * 20 - 20;

                  // Find capacity change points for labels (only first one or when barges actually change)
                  const capacityChangePoints = chartData.filter((d, i) => {
                    if (!d.capacityChanged) return false;
                    // Only show label if it's first or barges changed from previous
                    const prev = chartData.slice(0, i).reverse().find(p => p.capacityChanged);
                    if (!prev) return true;
                    return JSON.stringify(d.storageBargeIds) !== JSON.stringify(prev.storageBargeIds);
                  });

                  return (
                    <div key={hdd.crossing} className="bg-white rounded-lg shadow-sm border border-gray-100 p-3">
                      {/* Compact header with inline date range controls */}
                      <div className="flex items-center justify-between mb-1">
                        <h3 className="font-semibold text-sm" style={{ color }}>
                          {hdd.crossing}
                          <span className="ml-2 text-xs text-gray-400 font-normal">({hdd.start} → {hdd.rigDown})</span>
                        </h3>

                        {/* Compact date controls */}
                        <div className="flex items-center gap-2 text-xs">
                          <input
                            type="date"
                            value={startDate}
                            min={allDates[0]}
                            max={endDate}
                            onChange={(e) => {
                              const newStartIdx = allDates.indexOf(e.target.value);
                              if (newStartIdx !== -1) {
                                setDateRanges(prev => ({ ...prev, [crossingKey]: { ...prev[crossingKey], startIdx: newStartIdx } }));
                              }
                            }}
                            className="border border-gray-200 rounded px-1 py-0.5 text-xs w-28"
                          />
                          <span className="text-gray-400">to</span>
                          <input
                            type="date"
                            value={endDate}
                            min={startDate}
                            max={allDates[maxDateIdx]}
                            onChange={(e) => {
                              const newEndIdx = allDates.indexOf(e.target.value);
                              if (newEndIdx !== -1) {
                                setDateRanges(prev => ({ ...prev, [crossingKey]: { ...prev[crossingKey], endIdx: newEndIdx } }));
                              }
                            }}
                            className="border border-gray-200 rounded px-1 py-0.5 text-xs w-28"
                          />
                          <button
                            onClick={() => setDateRanges(prev => ({ ...prev, [crossingKey]: { startIdx: minDateIdx, endIdx: maxDateIdx } }))}
                            className="text-xs text-blue-500 hover:text-blue-700"
                          >
                            Reset
                          </button>
                          <span className="text-gray-400">|</span>
                          <span className="text-gray-500">{Math.max(1, currentRange.endIdx - currentRange.startIdx + 1)}d</span>
                        </div>
                      </div>

                      <ResponsiveContainer width="100%" height={220}>
                        <ComposedChart data={chartData} margin={{ top: 25, right: 20, left: 15, bottom: 35 }}>
                          <CartesianGrid strokeDasharray="3 3" />

                          {/* Shade background by stage with darker/lighter for work hours vs night */}
                          {(() => {
                            const stageColors = {
                              'RigUp': '#fbbf24',     // Amber - setup
                              'Pilot': '#3b82f6',     // Blue - pilot drilling
                              'Ream': '#10b981',      // Emerald green - reaming
                              'Swab': '#f97316',      // Orange - swabbing
                              'Pull': '#8b5cf6',      // Purple - pullback
                              'RigDown': '#6b7280',   // Gray - teardown
                              'Pre-Start': '#ffffff', // White
                              'Complete': '#ffffff'   // White
                            };

                            // Build hour-by-hour regions with different opacities
                            const hourRegions = [];
                            let currentStage = null;
                            let currentIsWorking = null;
                            let regionStart = 0;

                            chartData.forEach((d, i) => {
                              const isWorking = d.isWorkingHour;
                              if (d.stage !== currentStage || isWorking !== currentIsWorking) {
                                if (currentStage !== null && i > regionStart) {
                                  hourRegions.push({
                                    stage: currentStage,
                                    isWorking: currentIsWorking,
                                    startIdx: regionStart,
                                    endIdx: i - 1
                                  });
                                }
                                currentStage = d.stage;
                                currentIsWorking = isWorking;
                                regionStart = i;
                              }
                            });
                            // Close final region
                            if (currentStage !== null) {
                              hourRegions.push({
                                stage: currentStage,
                                isWorking: currentIsWorking,
                                startIdx: regionStart,
                                endIdx: chartData.length - 1
                              });
                            }

                            return hourRegions.map((region, idx) => (
                              <ReferenceArea
                                key={`stage-${idx}`}
                                x1={region.startIdx}
                                x2={region.endIdx}
                                fill={stageColors[region.stage] || '#ffffff'}
                                fillOpacity={region.isWorking ? 0.15 : 0.35}
                              />
                            ));
                          })()}

                          {/* Sunday hatch overlay - only if worksSundays is false */}
                          {!hdd.worksSundays && (() => {
                            // Find Sunday regions (groups of consecutive Sunday hours)
                            const sundayRegions = [];
                            let sundayStart = null;

                            chartData.forEach((d, i) => {
                              if (d.isSunday) {
                                if (sundayStart === null) sundayStart = i;
                              } else {
                                if (sundayStart !== null) {
                                  sundayRegions.push({ start: sundayStart, end: i - 1 });
                                  sundayStart = null;
                                }
                              }
                            });
                            // Close final Sunday region if chart ends on Sunday
                            if (sundayStart !== null) {
                              sundayRegions.push({ start: sundayStart, end: chartData.length - 1 });
                            }

                            return sundayRegions.map((region, idx) => (
                              <ReferenceArea
                                key={`sunday-${idx}`}
                                x1={region.start}
                                x2={region.end}
                                fill="#000000"
                                fillOpacity={0.35}
                                strokeDasharray="4 4"
                                stroke="#444444"
                                strokeOpacity={0.8}
                              />
                            ));
                          })()}

                          {/* Ran Dry overlay - highlight working hours on days with ran dry events */}
                          {result.ranDryEvents && (() => {
                            // Filter ran dry events for this HDD (by rig and crossing)
                            const hddRanDryEvents = result.ranDryEvents.filter(e =>
                              e.rig === rigName && e.hdd === hdd.crossing
                            );

                            if (hddRanDryEvents.length === 0) return null;

                            // Build set of dates with ran dry events
                            const ranDryDates = new Set();
                            hddRanDryEvents.forEach(event => {
                              // Parse start and end timestamps to get date range
                              const startDate = event.startTimestamp.split(' ')[0]; // "2026-06-15"
                              const endDate = event.endTimestamp.split(' ')[0];

                              // Add all dates in range
                              let currentDate = new Date(startDate);
                              const lastDate = new Date(endDate);
                              while (currentDate <= lastDate) {
                                ranDryDates.add(currentDate.toISOString().split('T')[0]);
                                currentDate.setDate(currentDate.getDate() + 1);
                              }
                            });

                            // Find working hour regions on ran dry dates
                            const ranDryRegions = [];
                            let regionStart = null;

                            chartData.forEach((d, i) => {
                              const isRanDryWorkingHour = ranDryDates.has(d.date) && d.isWorkingHour;
                              if (isRanDryWorkingHour) {
                                if (regionStart === null) regionStart = i;
                              } else {
                                if (regionStart !== null) {
                                  ranDryRegions.push({ start: regionStart, end: i - 1 });
                                  regionStart = null;
                                }
                              }
                            });
                            // Close final region
                            if (regionStart !== null) {
                              ranDryRegions.push({ start: regionStart, end: chartData.length - 1 });
                            }

                            return ranDryRegions.map((region, idx) => (
                              <ReferenceArea
                                key={`randry-${idx}`}
                                x1={region.start}
                                x2={region.end}
                                fill="#DC2626"
                                fillOpacity={0.5}
                                stroke="#B91C1C"
                                strokeWidth={2}
                                strokeOpacity={0.8}
                              />
                            ));
                          })()}

                          <XAxis
                            dataKey="index"
                            tick={{ fontSize: 7 }}
                            tickFormatter={(value) => {
                              // Show date at midnight (hour 0) only to avoid overcrowding
                              const entry = chartData[value];
                              if (!entry) return '';
                              if (parseInt(entry.hour) === 0) {
                                return entry.date.slice(5); // MM-DD format
                              }
                              return '';
                            }}
                            interval={23} // Show tick every 24 hours
                            angle={-45}
                            textAnchor="end"
                            height={35}
                          />
                          <YAxis
                            domain={[yMin, yMax]}
                            tickFormatter={(value) => `${value}K`}
                            tick={{ fontSize: 8 }}
                            width={35}
                          />
                          <Tooltip content={<CustomTooltip />} />

                          {/* Zero reference line */}
                          <ReferenceLine y={0} stroke="#9ca3af" strokeWidth={1} />

                          {/* Injection bars (positive, pointing up) */}
                          <Bar
                            dataKey="injectionK"
                            fill="#3d7068"
                            name="Injection"
                          />

                          {/* Withdrawal bars (negative, pointing down) */}
                          <Bar
                            dataKey="withdrawalK"
                            fill="#ef4444"
                            name="Withdrawal"
                          />

                          {/* Storage capacity dashed line */}
                          <Line
                            type="stepAfter"
                            dataKey="storageCapacityK"
                            stroke="#8b5cf6"
                            strokeWidth={2}
                            strokeDasharray="5 5"
                            dot={false}
                            name="Capacity"
                          />

                          {/* Storage level line */}
                          <Line
                            type="monotone"
                            dataKey="storageLevelK"
                            stroke={color}
                            strokeWidth={2}
                            dot={false}
                            name="Storage"
                          />

                          {/* Labels for capacity changes showing storage barge IDs */}
                          {capacityChangePoints.map((point, idx) => {
                            // Build label text - show transfer notes if available
                            let labelText;
                            if (point.transferNote) {
                              // Use pre-formatted transfer note from backend
                              labelText = point.transferNote;
                            } else if (point.storageBargeIds?.length > 0) {
                              // Barges assigned
                              labelText = `Storage: ${point.storageBargeIds.map(id => id.replace('SmallBarge-', 'SB').replace('LargeBarge-', 'LB')).join(', ')}`;
                            } else if (point.bargeMovedTo && point.previousBargeIds?.length > 0) {
                              // Barges moved away
                              const bargeNames = point.previousBargeIds.map(id => id.replace('SmallBarge-', 'SB').replace('LargeBarge-', 'LB')).join(', ');
                              const dest = point.bargeMovedTo === 'demobilized' ? 'demob' : point.bargeMovedTo;
                              labelText = `${bargeNames} moved to ${dest}`;
                            } else {
                              labelText = 'Storage: none';
                            }

                            return (
                              <ReferenceLine
                                key={`cap-label-${idx}`}
                                x={point.index}
                                stroke="#7c3aed"
                                strokeWidth={1}
                                strokeDasharray="3 3"
                                label={{
                                  value: labelText,
                                  position: 'top',
                                  fontSize: 11,
                                  fill: '#7c3aed',
                                  fontWeight: 'bold'
                                }}
                              />
                            );
                          })}
                        </ComposedChart>
                      </ResponsiveContainer>
                    </div>
                  );
                })}
              </div>
            );
          })}
        </div>
      );
    }

    // =====================================================================
    // TUG JOURNEYS TAB
    // =====================================================================
    function TugJourneysTab({ result }) {
      const [currentPage, setCurrentPage] = useState(1);
      const [filterTug, setFilterTug] = useState('all');
      const [filterState, setFilterState] = useState('all');
      const pageSize = 50;

      if (!result || !result.tugJourneys) {
        return <div className="text-gray-500 p-8">No tug journey data available</div>;
      }

      const journeys = result.tugJourneys;

      // Get unique tug IDs for filter
      const uniqueTugIds = [...new Set(journeys.map(j => j.tugId))].sort();

      // Apply filters
      let filteredJourneys = journeys;
      if (filterTug !== 'all') {
        filteredJourneys = filteredJourneys.filter(j => j.tugId === filterTug);
      }
      if (filterState !== 'all') {
        // Handle activity-based sub-state filters
        if (filterState === 'at-source-filling') {
          filteredJourneys = filteredJourneys.filter(j => j.state === 'at-source' && j.activity === 'filling');
        } else if (filterState === 'at-source-waiting') {
          filteredJourneys = filteredJourneys.filter(j => j.state === 'at-source' && j.activity === 'waiting');
        } else if (filterState === 'at-source-idle') {
          filteredJourneys = filteredJourneys.filter(j => j.state === 'at-source' && (j.activity === 'idle' || j.activity === 'dispatch'));
        } else {
          filteredJourneys = filteredJourneys.filter(j => j.state === filterState);
        }
      }

      // Calculate pagination
      const totalPages = Math.ceil(filteredJourneys.length / pageSize);
      const startIdx = (currentPage - 1) * pageSize;
      const endIdx = startIdx + pageSize;
      const paginatedJourneys = filteredJourneys.slice(startIdx, endIdx);

      // Reset to page 1 when filters change
      React.useEffect(() => {
        setCurrentPage(1);
      }, [filterTug, filterState]);

      return (
        <div className="space-y-4">
          <div style={{
            background: 'white',
            borderRadius: '8px',
            border: '2px solid #1a1a1a',
            boxShadow: '3px 3px 0 #1a1a1a',
            padding: '24px'
          }}>
            <h3 style={{
              fontFamily: 'Bebas Neue, sans-serif',
              fontSize: '1.5rem',
              letterSpacing: '0.05em',
              textTransform: 'uppercase',
              marginBottom: '16px',
              color: '#1a1a1a'
            }}>Tug Journeys</h3>

            {/* Summary Stats - Travel States */}
            <div style={{
              display: 'grid',
              gridTemplateColumns: 'repeat(7, 1fr)',
              gap: '12px',
              marginBottom: '16px'
            }}>
              <div style={{
                background: '#2d9cdb',
                padding: '12px',
                borderRadius: '4px',
                border: '2px solid #1a1a1a',
                boxShadow: '2px 2px 0 #1a1a1a',
                textAlign: 'center'
              }}>
                <div style={{
                  fontSize: '1.75rem',
                  fontFamily: 'Bebas Neue, sans-serif',
                  color: 'white'
                }}>{journeys.length}</div>
                <div style={{
                  fontSize: '10px',
                  fontFamily: 'IBM Plex Mono, monospace',
                  color: 'white',
                  textTransform: 'uppercase'
                }}>Total</div>
              </div>
              <div style={{
                background: '#22c55e',
                padding: '12px',
                borderRadius: '4px',
                border: '2px solid #1a1a1a',
                boxShadow: '2px 2px 0 #1a1a1a',
                textAlign: 'center'
              }}>
                <div style={{
                  fontSize: '1.75rem',
                  fontFamily: 'Bebas Neue, sans-serif',
                  color: 'white'
                }}>
                  {journeys.filter(j => j.state === 'traveling-to-hdd').length}
                </div>
                <div style={{
                  fontSize: '10px',
                  fontFamily: 'IBM Plex Mono, monospace',
                  color: 'white',
                  textTransform: 'uppercase'
                }}>To HDD</div>
              </div>
              <div style={{
                background: '#f59e0b',
                padding: '12px',
                borderRadius: '4px',
                border: '2px solid #1a1a1a',
                boxShadow: '2px 2px 0 #1a1a1a',
                textAlign: 'center'
              }}>
                <div style={{
                  fontSize: '1.75rem',
                  fontFamily: 'Bebas Neue, sans-serif',
                  color: 'white'
                }}>
                  {journeys.filter(j => j.state === 'traveling-to-source').length}
                </div>
                <div style={{
                  fontSize: '10px',
                  fontFamily: 'IBM Plex Mono, monospace',
                  color: 'white',
                  textTransform: 'uppercase'
                }}>To Source</div>
              </div>
              <div style={{
                background: '#8b5cf6',
                padding: '12px',
                borderRadius: '4px',
                border: '2px solid #1a1a1a',
                boxShadow: '2px 2px 0 #1a1a1a',
                textAlign: 'center'
              }}>
                <div style={{
                  fontSize: '1.75rem',
                  fontFamily: 'Bebas Neue, sans-serif',
                  color: 'white'
                }}>
                  {journeys.filter(j => j.state === 'at-rig').length}
                </div>
                <div style={{
                  fontSize: '10px',
                  fontFamily: 'IBM Plex Mono, monospace',
                  color: 'white',
                  textTransform: 'uppercase'
                }}>At-Rig</div>
              </div>
              <div style={{
                background: '#6366f1',
                padding: '12px',
                borderRadius: '4px',
                border: '2px solid #1a1a1a',
                boxShadow: '2px 2px 0 #1a1a1a',
                textAlign: 'center'
              }}>
                <div style={{
                  fontSize: '1.75rem',
                  fontFamily: 'Bebas Neue, sans-serif',
                  color: 'white'
                }}>
                  {journeys.filter(j => j.state === 'traveling-storage').length}
                </div>
                <div style={{
                  fontSize: '10px',
                  fontFamily: 'IBM Plex Mono, monospace',
                  color: 'white',
                  textTransform: 'uppercase'
                }}>Storage</div>
              </div>
              <div style={{
                background: '#06b6d4',
                padding: '12px',
                borderRadius: '4px',
                border: '2px solid #1a1a1a',
                boxShadow: '2px 2px 0 #1a1a1a',
                textAlign: 'center'
              }}>
                <div style={{
                  fontSize: '1.75rem',
                  fontFamily: 'Bebas Neue, sans-serif',
                  color: 'white'
                }}>
                  {journeys.filter(j => j.state === 'traveling-pickup').length}
                </div>
                <div style={{
                  fontSize: '10px',
                  fontFamily: 'IBM Plex Mono, monospace',
                  color: 'white',
                  textTransform: 'uppercase'
                }}>Pickup</div>
              </div>
              <div style={{
                background: '#f59e0b',
                padding: '12px',
                borderRadius: '4px',
                border: '2px solid #1a1a1a',
                boxShadow: '2px 2px 0 #1a1a1a',
                textAlign: 'center'
              }}>
                <div style={{
                  fontSize: '1.75rem',
                  fontFamily: 'Bebas Neue, sans-serif',
                  color: 'white'
                }}>
                  {journeys.filter(j => j.state === 'direct-hdd-delivery').length}
                </div>
                <div style={{
                  fontSize: '10px',
                  fontFamily: 'IBM Plex Mono, monospace',
                  color: 'white',
                  textTransform: 'uppercase'
                }}>HDD-to-HDD</div>
              </div>
            </div>

            {/* At-Source Breakdown */}
            <div style={{
              display: 'grid',
              gridTemplateColumns: 'repeat(4, 1fr)',
              gap: '12px',
              marginBottom: '24px'
            }}>
              <div style={{
                background: 'white',
                padding: '12px',
                borderRadius: '4px',
                border: '2px solid #1a1a1a',
                borderLeft: '6px solid #6b7280',
                boxShadow: '2px 2px 0 #1a1a1a'
              }}>
                <div style={{
                  fontSize: '1.5rem',
                  fontFamily: 'Bebas Neue, sans-serif',
                  color: '#6b7280'
                }}>
                  {journeys.filter(j => j.state === 'at-source').length}
                </div>
                <div style={{
                  fontSize: '10px',
                  fontFamily: 'IBM Plex Mono, monospace',
                  color: '#6b7280',
                  textTransform: 'uppercase'
                }}>At-Source (Total)</div>
              </div>
              <div style={{
                background: 'white',
                padding: '12px',
                borderRadius: '4px',
                border: '2px solid #1a1a1a',
                borderLeft: '6px solid #2d9cdb',
                boxShadow: '2px 2px 0 #1a1a1a'
              }}>
                <div style={{
                  fontSize: '1.5rem',
                  fontFamily: 'Bebas Neue, sans-serif',
                  color: '#2d9cdb'
                }}>
                  {journeys.filter(j => j.state === 'at-source' && j.activity === 'filling').length}
                </div>
                <div style={{
                  fontSize: '10px',
                  fontFamily: 'IBM Plex Mono, monospace',
                  color: '#2d9cdb',
                  textTransform: 'uppercase'
                }}>Filling Barges</div>
              </div>
              <div style={{
                background: 'white',
                padding: '12px',
                borderRadius: '4px',
                border: '2px solid #1a1a1a',
                borderLeft: '6px solid #eab308',
                boxShadow: '2px 2px 0 #1a1a1a'
              }}>
                <div style={{
                  fontSize: '1.5rem',
                  fontFamily: 'Bebas Neue, sans-serif',
                  color: '#eab308'
                }}>
                  {journeys.filter(j => j.state === 'at-source' && j.activity === 'waiting').length}
                </div>
                <div style={{
                  fontSize: '10px',
                  fontFamily: 'IBM Plex Mono, monospace',
                  color: '#eab308',
                  textTransform: 'uppercase'
                }}>Waiting (w/ barges)</div>
              </div>
              <div style={{
                background: 'white',
                padding: '12px',
                borderRadius: '4px',
                border: '2px solid #1a1a1a',
                borderLeft: '6px solid #9ca3af',
                boxShadow: '2px 2px 0 #1a1a1a'
              }}>
                <div style={{
                  fontSize: '1.5rem',
                  fontFamily: 'Bebas Neue, sans-serif',
                  color: '#9ca3af'
                }}>
                  {journeys.filter(j => j.state === 'at-source' && (j.activity === 'idle' || j.activity === 'dispatch')).length}
                </div>
                <div style={{
                  fontSize: '10px',
                  fontFamily: 'IBM Plex Mono, monospace',
                  color: '#9ca3af',
                  textTransform: 'uppercase'
                }}>Idle / Dispatch</div>
              </div>
            </div>

            {/* Filters */}
            <div className="flex gap-4 mb-4">
              <div className="flex-1">
                <label className="block text-xs font-medium text-gray-700 mb-1">Filter by Tug</label>
                <select
                  value={filterTug}
                  onChange={(e) => setFilterTug(e.target.value)}
                  className="input-field"
                >
                  <option value="all">All Tugs ({uniqueTugIds.length} tugs)</option>
                  {uniqueTugIds.map(tugId => (
                    <option key={tugId} value={tugId}>Tug {tugId}</option>
                  ))}
                </select>
              </div>
              <div className="flex-1">
                <label className="block text-xs font-medium text-gray-700 mb-1">Filter by State</label>
                <select
                  value={filterState}
                  onChange={(e) => setFilterState(e.target.value)}
                  className="input-field"
                >
                  <option value="all">All States</option>
                  <option value="traveling-to-hdd">To HDD (Delivering)</option>
                  <option value="traveling-to-source">To Source (Returning)</option>
                  <option value="at-rig">At Rig</option>
                  <option value="traveling-storage">Storage Delivery</option>
                  <option value="traveling-pickup">Barge Pickup</option>
                  <option value="direct-hdd-delivery">HDD-to-HDD Direct</option>
                  <option value="at-source">At Source (All)</option>
                  <option value="at-source-filling">At Source - Filling</option>
                  <option value="at-source-waiting">At Source - Waiting</option>
                  <option value="at-source-idle">At Source - Idle</option>
                </select>
              </div>
            </div>

            {/* Results count */}
            <div className="text-sm text-gray-600 mb-3">
              Showing {startIdx + 1}-{Math.min(endIdx, filteredJourneys.length)} of {filteredJourneys.length} journeys
            </div>

            {/* Journey Table */}
            <div className="overflow-x-auto">
              <table className="min-w-full divide-y divide-gray-200">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Tug ID</th>
                    <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">State</th>
                    <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Activity</th>
                    <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Barges</th>
                    <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Source</th>
                    <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Target HDD</th>
                    <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Target Rig</th>
                    <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Start Time</th>
                    <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">End Time</th>
                    <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Duration</th>
                  </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                  {paginatedJourneys.map((journey, idx) => {
                    const duration = journey.endHour ? (journey.endHour - journey.startHour).toFixed(2) : 'N/A';

                    // State color coding
                    const stateColor = journey.state === 'traveling-to-hdd' ? 'text-green-600' :
                                      journey.state === 'traveling-to-source' ? 'text-orange-600' :
                                      journey.state === 'at-rig' ? 'text-purple-600' :
                                      journey.state === 'traveling-storage' ? 'text-indigo-600' :
                                      journey.state === 'traveling-pickup' ? 'text-cyan-600' :
                                      journey.state === 'direct-hdd-delivery' ? 'text-amber-600' :
                                      journey.state === 'at-source' ? 'text-gray-500' :
                                      'text-gray-600';

                    // Activity color coding (for at-source sub-states)
                    const activityColor = journey.activity === 'filling' ? 'text-blue-600' :
                                         journey.activity === 'waiting' ? 'text-yellow-600' :
                                         journey.activity === 'pumping' ? 'text-green-600' :
                                         journey.activity === 'idle' ? 'text-gray-400' :
                                         journey.activity === 'dispatch' ? 'text-cyan-500' :
                                         'text-gray-400';

                    // Format activity display
                    const activityDisplay = journey.activity || (
                      journey.state === 'traveling-to-hdd' ? 'delivering' :
                      journey.state === 'traveling-to-source' ? 'returning' :
                      journey.state === 'traveling-storage' ? 'storage' :
                      journey.state === 'traveling-pickup' ? 'pickup' :
                      journey.state === 'direct-hdd-delivery' ? 'HDD-to-HDD' :
                      '-'
                    );

                    // Get barge IDs from journey
                    const bargeIds = journey.bargeIds || [];
                    const bargeIdStr = bargeIds.length > 0 ? bargeIds.join(', ') : '-';

                    return (
                      <tr key={`${journey.tugId}-${journey.startHour}-${idx}`} className="hover:bg-gray-50">
                        <td className="px-3 py-2 text-sm font-medium text-gray-900">{journey.tugId}</td>
                        <td className={`px-3 py-2 text-sm font-semibold ${stateColor}`}>
                          {journey.state}
                        </td>
                        <td className={`px-3 py-2 text-sm font-medium ${activityColor}`}>
                          {activityDisplay}
                        </td>
                        <td className="px-3 py-2 text-sm font-mono text-blue-600">{bargeIdStr}</td>
                        <td className="px-3 py-2 text-sm text-gray-600">{journey.sourceId || '-'}</td>
                        <td className="px-3 py-2 text-sm text-gray-600">{journey.targetCrossing || '-'}</td>
                        <td className="px-3 py-2 text-sm text-gray-600">{journey.targetRig || '-'}</td>
                        <td className="px-3 py-2 text-sm font-mono text-gray-900">
                          {journey.startDate ? `${journey.startDate} ${String(Math.floor(journey.startHour % 24)).padStart(2, '0')}:00` : journey.startHour.toFixed(2)}
                        </td>
                        <td className="px-3 py-2 text-sm font-mono text-gray-900">
                          {journey.endHour
                            ? (journey.endDate ? `${journey.endDate} ${String(Math.floor(journey.endHour % 24)).padStart(2, '0')}:00` : journey.endHour.toFixed(2))
                            : '-'}
                        </td>
                        <td className="px-3 py-2 text-sm font-mono text-gray-600">{duration} hrs</td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>

            {/* Pagination Controls */}
            {totalPages > 1 && (
              <div className="flex items-center justify-between mt-4 pt-4 border-t">
                <button
                  onClick={() => setCurrentPage(p => Math.max(1, p - 1))}
                  disabled={currentPage === 1}
                  className="btn-secondary disabled:opacity-50"
                >
                  Previous
                </button>
                <div className="text-sm text-gray-600">
                  Page {currentPage} of {totalPages}
                </div>
                <button
                  onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))}
                  disabled={currentPage === totalPages}
                  className="btn-secondary disabled:opacity-50"
                >
                  Next
                </button>
              </div>
            )}
          </div>
        </div>
      );
    }

    // =====================================================================
    // MAP ANIMATION TAB
    // =====================================================================
    function MapTab({ result, config }) {
      if (!result || !result.assetLog || !result.tugJourneys) {
        return (
          <div className="text-center py-8 text-gray-500">
            Run a simulation to see map animation
          </div>
        );
      }

      const [animationState, setAnimationState] = useState({
        isAnimating: false,
        animationProgress: 0,
        animationSpeed: 0,
        dateRangeStart: 0,
        dateRangeEnd: 100
      });

      // Layer visibility toggles
      const [showRoutes, setShowRoutes] = useState(true);
      const [showHDDMeters, setShowHDDMeters] = useState(true);
      const [showSourceCards, setShowSourceCards] = useState(true);
      const [showStorageBarges, setShowStorageBarges] = useState(true);

      // Zoom and pan state (default zoom 150%)
      const [zoomLevel, setZoomLevel] = useState(1.5);
      const [panOffset, setPanOffset] = useState({ x: 0, y: 0 });
      const [isPanning, setIsPanning] = useState(false);
      const [panStart, setPanStart] = useState({ x: 0, y: 0 });

      const animationRef = useRef(null);
      const svgRef = useRef(null);
      const { isAnimating, animationProgress, animationSpeed } = animationState;

      // Coordinate transformation (calibrated for MBTC map - 1662x1303 image)
      // Calibration values: Shift X=169, Y=137, Scale X=122%, Y=126%
      const transformCoord = (lng, lat) => {
        const baseScaleX = 1164.3;
        const baseScaleY = -1321.5;
        const refX = 555, refY = 172;
        const refLng = -94.93274, refLat = 29.71193;

        const scaleX = baseScaleX * 1.22;  // 122%
        const scaleY = baseScaleY * 1.26;  // 126%

        const x = refX + scaleX * (lng - refLng) + 169;
        const y = refY + scaleY * (lat - refLat) + 137;
        return { x, y };
      };

      // Animation loop
      useEffect(() => {
        if (!isAnimating) {
          if (animationRef.current) {
            clearInterval(animationRef.current);
            animationRef.current = null;
          }
          return;
        }

        const minIncrement = 0.00208; // ~2.5 min per frame (half of previous slowest)
        const maxIncrement = 0.0833;  // ~2 hr per frame
        const increment = minIncrement + (animationSpeed / 100) * (maxIncrement - minIncrement);

        animationRef.current = setInterval(() => {
          setAnimationState(prev => {
            const next = prev.animationProgress + increment;
            if (next >= 100) return { ...prev, animationProgress: 100, isAnimating: false };
            return { ...prev, animationProgress: next };
          });
        }, 50);

        return () => {
          if (animationRef.current) {
            clearInterval(animationRef.current);
            animationRef.current = null;
          }
        };
      }, [isAnimating, animationSpeed]);

      // Mouse wheel zoom
      useEffect(() => {
        const svg = svgRef.current;
        if (!svg) return;

        const handleWheel = (e) => {
          e.preventDefault();
          const delta = e.deltaY > 0 ? -0.1 : 0.1;
          setZoomLevel(z => Math.max(0.5, Math.min(4, z + delta)));
        };

        svg.addEventListener('wheel', handleWheel, { passive: false });
        return () => svg.removeEventListener('wheel', handleWheel);
      }, []);

      // Pan handlers
      const handleMouseDown = (e) => {
        setIsPanning(true);
        setPanStart({ x: e.clientX - panOffset.x, y: e.clientY - panOffset.y });
      };

      const handleMouseMove = (e) => {
        if (!isPanning) return;
        setPanOffset({
          x: e.clientX - panStart.x,
          y: e.clientY - panStart.y
        });
      };

      const handleMouseUp = () => {
        setIsPanning(false);
      };

      // Add global mouse handlers
      useEffect(() => {
        if (isPanning) {
          document.addEventListener('mousemove', handleMouseMove);
          document.addEventListener('mouseup', handleMouseUp);
          return () => {
            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', handleMouseUp);
          };
        }
      }, [isPanning, panStart]);

      // Calculate current simulation hour
      const currentSimulationHour = useMemo(() => {
        // Find first water-related event (filling at source or draining at HDD)
        const waterEvents = result.assetLog.filter(e =>
          e.status === 'filling' || e.status === 'draining'
        );

        // Use first water event as start time, or fall back to overall min if no water events
        const minHour = waterEvents.length > 0
          ? Math.min(...waterEvents.map(e => e.simHour || 0))
          : Math.min(...result.assetLog.map(e => e.simHour || 0));

        const maxHour = Math.max(...result.assetLog.map(e => e.simHour || 0));
        const totalHours = maxHour - minHour;
        return minHour + (totalHours * animationProgress / 100);
      }, [result.assetLog, animationProgress]);

      // Calculate current date/time for display
      const currentDateTime = useMemo(() => {
        const currentHourInt = Math.floor(currentSimulationHour);
        const logEntry = result.assetLog.find(e => Math.floor(e.simHour) === currentHourInt);

        if (!logEntry) {
          const closest = result.assetLog.reduce((prev, curr) =>
            Math.abs(curr.simHour - currentSimulationHour) < Math.abs(prev.simHour - currentSimulationHour) ? curr : prev
          );
          if (closest) {
            const date = new Date(closest.date);
            const hour = Math.floor(currentSimulationHour % 24);
            const minute = Math.floor((currentSimulationHour % 1) * 60);
            return {
              dateStr: `${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`,
              timeStr: `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`,
              fullDate: closest.date
            };
          }
        }

        const date = new Date(logEntry.date);
        const hour = Math.floor(currentSimulationHour % 24);
        const minute = Math.floor((currentSimulationHour % 1) * 60);

        return {
          dateStr: `${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`,
          timeStr: `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`,
          fullDate: logEntry.date
        };
      }, [result.assetLog, currentSimulationHour]);

      // ROBUST: Get tug positions directly from assetLog (no dependency on animationTimeline)
      const tugPositions = useMemo(() => {
        const positions = [];
        const lastKnownPositions = {}; // Track last known good position for each tug

        // DEBUG: Count renders by status
        const renderStats = {
          'en-route-loaded': 0,
          'en-route-empty': 0,
          'at-rig': 0,
          'arrived-at-rig': 0,
          'idle': 0,
          'mobilized': 0,
          'other': 0
        };

        // Helper: Get coordinates for a location (matches simulation's getLocationCoordinates)
        const getLocationCoords = (location) => {
          if (!location || !window.MULTI_SOURCE_ROUTES) return null;

          // Extract source or HDD identifier from ANY location string
          // This handles all formats: "at source1", "to HDD17", "returning to source2",
          // "to source3 for storage pickup", "from source1", etc.

          // Try to find source first
          const sourceMatch = location.match(/source(\d+)/i);
          if (sourceMatch) {
            const sourceId = `source${sourceMatch[1]}`;
            if (window.MULTI_SOURCE_ROUTES[sourceId]) {
              return window.MULTI_SOURCE_ROUTES[sourceId].location;
            }
          }

          // Try to find HDD
          const hddMatch = location.match(/HDD(\d+)/i);
          if (hddMatch) {
            const crossing = `HDD${hddMatch[1]}`;
            // Find from any source's routes
            for (const sourceData of Object.values(window.MULTI_SOURCE_ROUTES)) {
              if (sourceData.routes?.[crossing]) {
                const route = sourceData.routes[crossing];
                if (route && route.length > 0) {
                  const endpoint = route[route.length - 1];
                  return { lat: endpoint[1], lng: endpoint[0] };
                }
              }
            }
          }

          return null;
        };

        // Helper: Extract source and crossing from location
        const extractSourceAndCrossing = (location) => {
          const sourceMatch = location?.match(/source(\d+)/i);
          const crossingMatch = location?.match(/HDD(\d+)/i);
          return {
            sourceId: sourceMatch ? `source${sourceMatch[1]}` : null,
            crossing: crossingMatch ? `HDD${crossingMatch[1]}` : null
          };
        };

        // Helper: Get route between source and HDD
        const getRoute = (sourceId, crossing) => {
          if (!window.MULTI_SOURCE_ROUTES) return null;
          const sourceData = window.MULTI_SOURCE_ROUTES[sourceId];
          return sourceData?.routes?.[crossing] || null;
        };

        // Helper: Find route between two locations
        const findRouteBetweenLocations = (loc1, loc2) => {
          const info1 = extractSourceAndCrossing(loc1);
          const info2 = extractSourceAndCrossing(loc2);

          // Source to HDD (forward direction)
          if (info1.sourceId && info2.crossing) {
            const route = getRoute(info1.sourceId, info2.crossing);
            return { route, reverse: false, sourceId: info1.sourceId, crossing: info2.crossing };
          }
          // HDD to source (reverse direction)
          if (info1.crossing && info2.sourceId) {
            const route = getRoute(info2.sourceId, info1.crossing);
            return { route, reverse: true, sourceId: info2.sourceId, crossing: info1.crossing };
          }

          // HDD to HDD (direct-hdd-delivery) - use centerline data
          if (info1.crossing && info2.crossing && info1.crossing !== info2.crossing) {
            // For HDD-to-HDD, we use linear interpolation since CENTERLINE_HDD_DISTANCES
            // only provides distances, not actual routes. Return null route to trigger
            // the linear interpolation fallback.
            return { route: null, reverse: false, isHddToHdd: true, fromHdd: info1.crossing, toHdd: info2.crossing };
          }

          // Fallback: Try to find ANY route to the HDD if mentioned in either location
          const anyCrossing = info1.crossing || info2.crossing;
          const anySource = info1.sourceId || info2.sourceId;

          if (anyCrossing && anySource) {
            const route = getRoute(anySource, anyCrossing);
            // Determine direction: if we're going TO the crossing, forward; if FROM, reverse
            const goingToCrossing = info2.crossing === anyCrossing;
            return { route, reverse: !goingToCrossing, sourceId: anySource, crossing: anyCrossing };
          }

          return { route: null, reverse: false };
        };

        // Helper: Interpolate position along route and calculate angle pointing toward next waypoint
        // Uses DISTANCE-based interpolation for constant speed regardless of waypoint density
        const interpolateAlongRoute = (route, progress, reverse = false, debugLabel = '') => {
          if (!route || route.length === 0) return null;

          const orderedRoute = reverse ? [...route].reverse() : route;
          const totalSegments = orderedRoute.length - 1;

          if (totalSegments <= 0) {
            return {
              lat: orderedRoute[0][1],
              lng: orderedRoute[0][0],
              angle: 0
            };
          }

          // Calculate cumulative distance along route (in degrees lat/lng)
          const segmentDistances = [];
          let totalDistance = 0;

          for (let i = 0; i < totalSegments; i++) {
            const p1 = orderedRoute[i];
            const p2 = orderedRoute[i + 1];
            const dx = p2[0] - p1[0]; // lng
            const dy = p2[1] - p1[1]; // lat
            const dist = Math.sqrt(dx * dx + dy * dy);
            segmentDistances.push(dist);
            totalDistance += dist;
          }

          // Find position at (progress * totalDistance)
          const targetDistance = progress * totalDistance;
          let accumulatedDistance = 0;
          let segmentIndex = 0;
          let segmentProgress = 0;

          for (let i = 0; i < segmentDistances.length; i++) {
            if (accumulatedDistance + segmentDistances[i] >= targetDistance) {
              segmentIndex = i;
              const remainingDistance = targetDistance - accumulatedDistance;
              segmentProgress = segmentDistances[i] > 0 ? remainingDistance / segmentDistances[i] : 0;
              break;
            }
            accumulatedDistance += segmentDistances[i];
          }

          // If we've gone past the end, use last segment
          if (segmentIndex >= totalSegments) {
            segmentIndex = totalSegments - 1;
            segmentProgress = 1;
          }

          const start = orderedRoute[segmentIndex];
          const end = orderedRoute[segmentIndex + 1] || start;

          const result = {
            lat: start[1] + (end[1] - start[1]) * segmentProgress,
            lng: start[0] + (end[0] - start[0]) * segmentProgress
          };

          // Calculate angle pointing from current position toward END of current segment (next waypoint)
          const dx = end[0] - start[0]; // lng difference (start → end waypoint)
          const dy = end[1] - start[1]; // lat difference (start → end waypoint)

          if (Math.abs(dx) > 0.0001 || Math.abs(dy) > 0.0001) {
            // atan2(-dy, dx) because SVG Y-axis is inverted (scaleY is negative)
            // In SVG: moving North in lat means moving UP (decreasing Y)
            const angleRadians = Math.atan2(-dy, dx);
            result.angle = angleRadians * (180 / Math.PI);
          } else {
            result.angle = 0; // No movement, default angle
          }

          return result;
        };

        // Get all unique tug IDs
        const tugIds = [...new Set(
          result.assetLog
            .filter(e => e.assetType === 'Tug')
            .map(e => e.assetId)
        )];

        tugIds.forEach(tugId => {
          // Get all events for this tug up to current time
          const tugEvents = result.assetLog
            .filter(e => e.assetType === 'Tug' && e.assetId === tugId && e.simHour <= currentSimulationHour)
            .sort((a, b) => a.simHour - b.simHour);

          if (tugEvents.length === 0) return;

          // Get current event - handle conflicts at same timestamp by prioritizing traveling states
          let currentEvent = tugEvents[tugEvents.length - 1];

          // Check if there are multiple events at the exact same timestamp
          const sameTimeEvents = tugEvents.filter(e => e.simHour === currentEvent.simHour);
          if (sameTimeEvents.length > 1) {
            // Prioritize in order: at-rig > arrived-at-rig > en-route-* > idle
            const priorityOrder = ['at-rig', 'arrived-at-rig', 'en-route-loaded', 'en-route-empty',
                                  'en-route-storage', 'en-route-pickup', 'traveling-to-next-stop'];
            for (const status of priorityOrder) {
              const found = sameTimeEvents.find(e => e.status === status);
              if (found) {
                currentEvent = found;
                break;
              }
            }
          }

          const nextEvent = result.assetLog.find(e =>
            e.assetType === 'Tug' && e.assetId === tugId && e.simHour > currentSimulationHour
          );

          // Check mobilization - but be lenient if date is undefined
          const tugMob = result.mobilizationSchedule?.tugs?.find(t => t.id === tugId);
          if (tugMob && currentDateTime?.fullDate) {
            if (currentDateTime.fullDate < tugMob.mobDate || currentDateTime.fullDate > tugMob.demobDate) {
              return; // Not mobilized
            }
          }

          // Calculate position - try multiple sources
          let coords = currentEvent.coordinates;

          if (!coords && currentEvent.location) {
            coords = getLocationCoords(currentEvent.location);
          }

          // If still no coords but we have sourceId or targetCrossing, try using those
          // BUT skip this for direct-hdd-delivery since we need to interpolate between HDDs
          if (!coords && currentEvent.sourceId && currentEvent.status !== 'direct-hdd-delivery') {
            coords = getLocationCoords(currentEvent.sourceId);
          }

          if (!coords && currentEvent.targetCrossing && currentEvent.status !== 'direct-hdd-delivery') {
            coords = getLocationCoords(currentEvent.targetCrossing);
          }

          let angle = 0;

          // Detect if we need to synthesize travel (teleportation fix)
          // Include ALL en-route statuses from the simulation
          const travelingStatuses = [
            'en-route-loaded',
            'en-route-empty',
            'en-route-storage',
            'en-route-pickup',
            'en-route-return-to-source',
            'en-route-demob',
            'en-route-transfer-pickup',
            'en-route-transfer-delivery',
            'traveling-to-next-stop',
            'direct-hdd-delivery'  // HDD-to-HDD direct delivery
          ];
          const isExplicitlyTraveling = travelingStatuses.includes(currentEvent.status);
          const nextIsStartingTravel = nextEvent && travelingStatuses.includes(nextEvent.status);

          // TELEPORTATION FIX: If location changed between current and next but status isn't traveling,
          // synthesize smooth travel
          // CRITICAL: Don't synthesize if NEXT event is starting travel (en-route-*) - that's just dispatch, not a gap
          if (!isExplicitlyTraveling && nextEvent && currentEvent.location !== nextEvent.location && !nextIsStartingTravel) {
            const duration = nextEvent.simHour - currentEvent.simHour;
            const elapsed = currentSimulationHour - currentEvent.simHour;

            // Only synthesize if we're in the gap between events
            if (duration > 0 && elapsed > 0 && elapsed < duration) {
              const t = Math.min(1, Math.max(0, elapsed / duration));

              // Try to find route between locations
              const { route, reverse } = findRouteBetweenLocations(currentEvent.location, nextEvent.location);

              if (route && route.length > 1) {
                const interpolated = interpolateAlongRoute(route, t, reverse, `${tugId}-synthesized`);
                if (interpolated && interpolated.lat && interpolated.lng) {
                  coords = interpolated;
                  angle = interpolated.angle || 0; // Use angle from route interpolation
                }
              } else {
                // Linear interpolation fallback
                const startCoords = currentEvent.coordinates || getLocationCoords(currentEvent.location);
                const endCoords = nextEvent.coordinates || getLocationCoords(nextEvent.location);

                if (startCoords && endCoords) {
                  coords = {
                    lat: startCoords.lat + (endCoords.lat - startCoords.lat) * t,
                    lng: startCoords.lng + (endCoords.lng - startCoords.lng) * t
                  };
                }
              }

              // Calculate angle for synthesized travel
              const endCoords = nextEvent.coordinates || getLocationCoords(nextEvent.location);
              if (endCoords && coords) {
                const dx = endCoords.lng - coords.lng;
                const dy = endCoords.lat - coords.lat;
                if (Math.abs(dx) > 0.0001 || Math.abs(dy) > 0.0001) {
                  angle = Math.atan2(dy, dx) * (180 / Math.PI);
                }
              }
            }
          }
          // Normal travel interpolation (explicit traveling status)
          else if (isExplicitlyTraveling) {
            // CRITICAL FIX: For direct-hdd-delivery, we need to force interpolation
            // The early coord lookup sets coords to origin HDD, but we need to interpolate
            // between origin and destination HDDs. Clear coords to force fallback path.
            if (currentEvent.status === 'direct-hdd-delivery') {
              coords = null;  // Force interpolation path
            }
            // Handle case where tug is traveling but nextEvent is missing (end of simulation)
            // In this case, show tug at its destination (extracted from location like "to HDD17")
            if (!nextEvent) {
              const destInfo = extractSourceAndCrossing(currentEvent.location);
              if (destInfo.crossing) {
                const destCoords = getLocationCoords(destInfo.crossing);
                if (destCoords) coords = destCoords;
              } else if (destInfo.sourceId) {
                const destCoords = getLocationCoords(destInfo.sourceId);
                if (destCoords) coords = destCoords;
              }
              // coords already set from initial lookup, will use that as fallback
            } else {
              // Normal case: we have both current and next event
            const duration = nextEvent.simHour - currentEvent.simHour;
            const elapsed = currentSimulationHour - currentEvent.simHour;
            const t = duration > 0 ? Math.min(1, Math.max(0, elapsed / duration)) : 0;

            // Extract source and destination from event data
            // The assetLog entries have location like "to HDD17" or "returning to source1"
            // We need to figure out which source and crossing this route uses

            // Get source from: explicit sourceId, or extract from location/previous events
            let sourceId = currentEvent.sourceId;
            let crossing = currentEvent.targetCrossing;

            // If not explicit, try to extract from current and next event locations
            if (!sourceId || !crossing) {
              const currentInfo = extractSourceAndCrossing(currentEvent.location);
              const nextInfo = extractSourceAndCrossing(nextEvent.location);

              // Handle HDD-to-HDD direct delivery (sourceId is origin HDD, not water source)
              if (currentEvent.status === 'direct-hdd-delivery') {
                // For direct-hdd-delivery, sourceId is the origin HDD (not water source)
                // We need to handle interpolation specially below
                sourceId = null;  // No water source involved - flag for special handling
                crossing = crossing || nextInfo.crossing || currentInfo.crossing || currentEvent.targetCrossing;
              }
              // Determine source and crossing based on travel direction
              else if (currentEvent.status === 'en-route-loaded' || currentEvent.status === 'en-route-storage') {
                // Going TO a crossing from a source
                sourceId = sourceId || currentInfo.sourceId || nextInfo.sourceId;
                crossing = crossing || nextInfo.crossing || currentInfo.crossing;
              } else if (currentEvent.status === 'en-route-empty') {
                // Returning TO a source from a crossing
                sourceId = sourceId || nextInfo.sourceId || currentInfo.sourceId;
                crossing = crossing || currentInfo.crossing || nextInfo.crossing;
              } else {
                // Other en-route statuses (pickup, etc.)
                sourceId = sourceId || currentInfo.sourceId || nextInfo.sourceId;
                crossing = crossing || currentInfo.crossing || nextInfo.crossing;
              }
            }

            // Save original coords for fallback
            const originalCoords = currentEvent.coordinates || getLocationCoords(currentEvent.location);

            // Try to use route for smooth path
            if (sourceId && crossing) {
              const route = getRoute(sourceId, crossing);
              if (route && route.length > 1) {
                // Determine direction: en-route-empty means returning FROM HDD TO source
                const isReverse = currentEvent.status === 'en-route-empty';
                const interpolated = interpolateAlongRoute(route, t, isReverse, `${tugId}-${currentEvent.status}`);
                if (interpolated && interpolated.lat && interpolated.lng) {
                  coords = interpolated;
                  angle = interpolated.angle || 0; // Use angle pointing to next waypoint
                }
              }
            }

            // Fallback: try to find route using findRouteBetweenLocations helper
            if (!coords || !coords.lat) {
              const { route, reverse } = findRouteBetweenLocations(currentEvent.location, nextEvent.location);
              if (route && route.length > 1) {
                const interpolated = interpolateAlongRoute(route, t, reverse, `${tugId}-fallback-route`);
                if (interpolated && interpolated.lat && interpolated.lng) {
                  coords = interpolated;
                  angle = interpolated.angle || 0; // Use angle pointing to next waypoint
                }
              }
            }

            // Fallback: linear interpolation between start and end coordinates
            if (!coords || !coords.lat) {
              let startCoords = originalCoords;
              let endCoords = nextEvent.coordinates || getLocationCoords(nextEvent.location);

              // Special handling for direct-hdd-delivery: use sourceId (origin HDD) and targetCrossing
              if (currentEvent.status === 'direct-hdd-delivery') {
                // sourceId contains origin HDD (e.g., "HDD17"), targetCrossing contains destination
                const originHDD = currentEvent.sourceId || currentEvent.details?.sourceId;
                const destHDD = currentEvent.targetCrossing || currentEvent.details?.targetCrossing;

                if (originHDD) {
                  startCoords = getLocationCoords(originHDD);
                }
                if (destHDD) {
                  endCoords = getLocationCoords(destHDD);
                }
              }

              if (startCoords && endCoords && startCoords.lat && endCoords.lat) {
                coords = {
                  lat: startCoords.lat + (endCoords.lat - startCoords.lat) * t,
                  lng: startCoords.lng + (endCoords.lng - startCoords.lng) * t
                };

                // Calculate angle pointing toward destination (negate dy for SVG Y-axis inversion)
                const dx = endCoords.lng - startCoords.lng;
                const dy = endCoords.lat - startCoords.lat;
                if (Math.abs(dx) > 0.0001 || Math.abs(dy) > 0.0001) {
                  angle = Math.atan2(-dy, dx) * (180 / Math.PI);
                }
              } else if (startCoords && startCoords.lat) {
                // If we don't have end coords, just hold current position
                coords = startCoords;
              }
            }

            // Last resort: use original coords
            if (!coords || !coords.lat) {
              coords = originalCoords;
            }

            // Calculate angle as fallback only if not already set by route interpolation
            if (angle === 0 && coords && nextEvent) {
              const nextCoords = nextEvent.coordinates || getLocationCoords(nextEvent.location);
              if (nextCoords && nextCoords.lat && nextCoords.lng) {
                const dx = nextCoords.lng - coords.lng;
                const dy = nextCoords.lat - coords.lat;
                if (Math.abs(dx) > 0.0001 || Math.abs(dy) > 0.0001) {
                  angle = Math.atan2(-dy, dx) * (180 / Math.PI); // Negate dy for SVG Y-axis inversion
                }
              }
            }
            } // Close the "else { // Normal case" block
          }

          // DEBUG: Log if coords are missing (tug will disappear)
          if (!coords || !coords.lat || !coords.lng) {
            // Only log unique disappearances to avoid spam
            const disappearKey = `${tugId}-${currentEvent.status}-${Math.floor(currentSimulationHour)}`;
            if (!lastKnownPositions[disappearKey]) {
              lastKnownPositions[disappearKey] = true;
              console.warn(`[TUG-DISAPPEARED] ${tugId}: No valid coords - tug will not render`, {
                status: currentEvent.status,
                location: currentEvent.location,
                triedEventCoords: !!currentEvent.coordinates,
                triedLocationLookup: !!getLocationCoords(currentEvent.location),
                triedSourceId: currentEvent.sourceId ? !!getLocationCoords(currentEvent.sourceId) : 'n/a',
                triedTargetCrossing: currentEvent.targetCrossing ? !!getLocationCoords(currentEvent.targetCrossing) : 'n/a',
                simHour: currentSimulationHour.toFixed(2)
              });
            }
            return;
          }

          const svgPos = transformCoord(coords.lng, coords.lat);

          // DEBUG: Sample logging for all statuses to see render coverage
          // Track render stats
          if (renderStats[currentEvent.status] !== undefined) {
            renderStats[currentEvent.status]++;
          } else {
            renderStats['other']++;
          }

          positions.push({
            tugId,
            x: svgPos.x,
            y: svgPos.y,
            angle: angle, // Angle already points bow in direction of travel
            status: currentEvent.status,
            attachedBargeIds: currentEvent.attachedBargeIds || [],
            targetRig: currentEvent.targetRig,
            location: currentEvent.location
          });
        });

        // Apply vertical stacking for tugs at same location
        const locationGroups = {};
        positions.forEach(tug => {
          const locKey = `${Math.round(tug.x / 5) * 5},${Math.round(tug.y / 5) * 5}`;
          if (!locationGroups[locKey]) locationGroups[locKey] = [];
          locationGroups[locKey].push(tug);
        });

        Object.values(locationGroups).forEach(tugsAtLocation => {
          if (tugsAtLocation.length > 1) {
            const spacing = 12; // Slightly more room between stacked tugs
            const totalHeight = (tugsAtLocation.length - 1) * spacing;
            const startOffset = -totalHeight / 2;
            tugsAtLocation.forEach((tug, idx) => {
              tug.y += startOffset + (idx * spacing);
            });
          }
        });

        return positions;
      }, [result.assetLog, currentSimulationHour, currentDateTime, result.mobilizationSchedule]);

      // Get barge positions (attached to tugs or at sources)
      const bargePositions = useMemo(() => {
        const barges = [];

        // Get current barge states from asset log
        const currentHourInt = Math.floor(currentSimulationHour);
        const bargeEvents = result.assetLog.filter(e =>
          (e.assetType === 'Barge (small)' || e.assetType === 'Barge (large)') &&
          e.simHour <= currentSimulationHour
        );

        // Group by barge ID and get most recent event
        // CRITICAL FIX: Prioritize traveling states when multiple events at same timestamp
        const bargeStates = {};
        const travelingStatuses = ['en-route-loaded', 'en-route-empty', 'en-route-storage', 'at-rig', 'arrived-at-rig'];

        bargeEvents.forEach(event => {
          const existing = bargeStates[event.assetId];

          // If no existing event, use this one
          if (!existing) {
            bargeStates[event.assetId] = event;
            return;
          }

          // If this event is newer, use it
          if (event.simHour > existing.simHour) {
            bargeStates[event.assetId] = event;
            return;
          }

          // If same timestamp, prioritize traveling states over idle/filling
          if (event.simHour === existing.simHour) {
            const eventIsTraveling = travelingStatuses.includes(event.status);
            const existingIsTraveling = travelingStatuses.includes(existing.status);

            if (eventIsTraveling && !existingIsTraveling) {
              bargeStates[event.assetId] = event; // Prefer traveling
            }
          }
        });

        // Debug logging removed

        // Process each barge
        Object.values(bargeStates).forEach(bargeEvent => {
          // FIX 1: Check if barge is mobilized at current date
          const bargeMob = result.mobilizationSchedule.barges.find(b =>
            b.id === bargeEvent.assetId || b.id === `Barge-${bargeEvent.assetId}`
          );
          if (bargeMob && currentDateTime && currentDateTime.fullDate) {
            if (currentDateTime.fullDate < bargeMob.mobDate || currentDateTime.fullDate > bargeMob.demobDate) {
              return; // Barge not mobilized yet or already demobilized
            }
          }

          // Find if this barge is attached to a tug
          const attachedToTug = tugPositions.find(t =>
            t.attachedBargeIds && t.attachedBargeIds.includes(bargeEvent.assetId)
          );

          // REMOVED: Don't render barges at sources on map (shown in source cards instead)

          if (attachedToTug) {
            const capacity = bargeEvent.capacity || (bargeEvent.assetType === 'Barge (large)' ? 400000 : 80000);
            let fillLevel = bargeEvent.fillLevel || 0;

            // Simplified: Use assetLog fillLevel and interpolate between events for smooth animation
            // The simulation updates fillLevel at key moments - we just animate between them

            // Find next event for this barge for interpolation
            const nextBargeEvent = result.assetLog.find(e =>
              e.assetId === bargeEvent.assetId &&
              e.simHour > currentSimulationHour
            );

            if (nextBargeEvent && nextBargeEvent.simHour > bargeEvent.simHour) {
              const duration = nextBargeEvent.simHour - bargeEvent.simHour;
              const elapsed = currentSimulationHour - bargeEvent.simHour;
              const t = Math.min(1, Math.max(0, elapsed / duration));

              // Interpolate fill level between current and next event
              const currentFill = bargeEvent.fillLevel || 0;
              const nextFill = nextBargeEvent.fillLevel || 0;
              fillLevel = currentFill + (nextFill - currentFill) * t;
            }

            // Barge is with tug - position near tug
            // Find index within this tug's barges for proper stacking
            const bargeIndexForTug = attachedToTug.attachedBargeIds.indexOf(bargeEvent.assetId);

            barges.push({
              bargeId: bargeEvent.assetId,
              x: attachedToTug.x,
              y: attachedToTug.y,
              type: bargeEvent.assetType === 'Barge (large)' ? 'large' : 'small',
              fillLevel,
              capacity,
              status: bargeEvent.status,
              attachedToTugId: attachedToTug.tugId,
              angle: attachedToTug.angle, // Tug angle already corrected, barge uses same angle
              stackIndex: bargeIndexForTug // Index within this tug's barges
            });
          }
        });

        return barges;
      }, [result.assetLog, currentSimulationHour, tugPositions]);

      // Calculate real-time counters
      const counters = useMemo(() => {
        const completedJourneys = result.tugJourneys.filter(j =>
          j.state === 'traveling-loaded' && j.endHour <= currentSimulationHour
        );

        const totalSimHours = Math.max(...result.assetLog.map(e => e.simHour || 0));
        const minSimHour = Math.min(...result.assetLog.map(e => e.simHour || 0));
        const progressFraction = totalSimHours > minSimHour ?
          (currentSimulationHour - minSimHour) / (totalSimHours - minSimHour) : 0;

        const totalTugDays = result.mobilizationSchedule.summary.totalTugDays * progressFraction;
        const totalSmallBargeDays = result.mobilizationSchedule.summary.totalSmallBargeDays * progressFraction;
        const totalLargeBargeDays = result.mobilizationSchedule.summary.totalLargeBargeDays * progressFraction;

        return {
          trips: completedJourneys.length,
          tugDays: Math.round(totalTugDays),
          smallBargeDays: Math.round(totalSmallBargeDays),
          largeBargeDays: Math.round(totalLargeBargeDays)
        };
      }, [result, currentSimulationHour]);

      // Calculate HDD storage meters (position, fill level, active status)
      const hddMeters = useMemo(() => {
        if (!result.hddStorageTimeline || !showHDDMeters) return [];

        const meters = [];

        result.hddStorageTimeline.forEach(hddTimeline => {
          // FIX: Use timestamp field instead of index for accurate matching
          // Find the hourly data bracketing current simulation time based on timestamp
          const beforePoint = hddTimeline.hourlyData
            .filter(d => d.timestamp !== undefined && d.timestamp <= currentSimulationHour)
            .pop();
          const afterPoint = hddTimeline.hourlyData
            .find(d => d.timestamp !== undefined && d.timestamp > currentSimulationHour);

          if (!beforePoint) return;

          let storageLevel = beforePoint.storageLevel || 0;
          const storageCapacity = beforePoint.storageCapacity || 240000;

          // Simple interpolation between hourly snapshots
          // The simulation already calculated correct storage levels - just interpolate
          if (afterPoint && beforePoint.timestamp !== afterPoint.timestamp) {
            const progress = (currentSimulationHour - beforePoint.timestamp) /
                           (afterPoint.timestamp - beforePoint.timestamp);
            storageLevel = beforePoint.storageLevel + (afterPoint.storageLevel - beforePoint.storageLevel) * progress;
          }

          // Calculate fill percent from storage level and capacity
          const fillPercent = Math.min(100, Math.max(0, (storageLevel / storageCapacity) * 100));

          const dataPoint = beforePoint; // Use for date checking

          // FIX 3: Check if this HDD is active at current time (using currentDateTime)
          if (!currentDateTime || !currentDateTime.fullDate) return;
          const currentDate = currentDateTime.fullDate;
          const isActive = currentDate >= hddTimeline.start && currentDate <= hddTimeline.rigDown;

          // Only show active HDDs
          if (!isActive) return;

          // Get coordinates for this HDD crossing
          let coords = null;
          for (const [sourceId, sourceData] of Object.entries(window.MULTI_SOURCE_ROUTES || {})) {
            if (sourceData.routes && sourceData.routes[hddTimeline.crossing]) {
              const route = sourceData.routes[hddTimeline.crossing];
              if (route && route.length > 0) {
                const endPoint = route[route.length - 1];
                coords = { lat: endPoint[1], lng: endPoint[0] };
                break;
              }
            }
          }

          if (!coords) return;

          const svgPos = transformCoord(coords.lng, coords.lat);

          // FIX 4: Color-code by rig
          const rigColors = {
            Blue: '#1e3a5f',    // WHC Navy
            Green: '#22c55e',   // Status Green
            Red: '#d94545'      // WHC Red
          };

          // Get storage barges from the hourly data - this is already tracked by the simulation
          // Format: ["LargeBarge-1", "SmallBarge-2"] -> ["LB1", "SB2"]
          const rawBargeIds = dataPoint.storageBargeIds || [];
          const assignedBargeIds = rawBargeIds.map(id =>
            id.replace('LargeBarge-', 'LB').replace('SmallBarge-', 'SB')
          );

          // FIX 5: Use interpolated values with storage barge IDs
          meters.push({
            crossing: hddTimeline.crossing,
            rig: hddTimeline.rig,
            color: rigColors[hddTimeline.rig] || '#22c55e',
            x: svgPos.x,
            y: svgPos.y,
            fillPercent: Math.min(100, Math.max(0, fillPercent)),
            storageLevel: Math.max(0, storageLevel),
            stage: dataPoint.stage,
            storageBargeIds: assignedBargeIds // Add storage barge IDs
          });
        });

        return meters;
      }, [result.hddStorageTimeline, currentSimulationHour, showHDDMeters, currentDateTime]);

      // Calculate barges at each source for floating cards
      const bargesAtSources = useMemo(() => {
        if (!showSourceCards) return {};

        const grouped = { source1: [], source2: [], source3: [] };

        // Get current barge states
        const currentHourInt = Math.floor(currentSimulationHour);
        const bargeEvents = result.assetLog.filter(e =>
          (e.assetType === 'Barge (small)' || e.assetType === 'Barge (large)') &&
          e.simHour <= currentSimulationHour
        );

        const bargeStates = {};
        bargeEvents.forEach(event => {
          if (!bargeStates[event.assetId] || event.simHour > bargeStates[event.assetId].simHour) {
            bargeStates[event.assetId] = event;
          }
        });

        Object.values(bargeStates).forEach(bargeEvent => {
          // FIX 3: Check if barge is mobilized (match with Barge- prefix)
          const bargeMob = result.mobilizationSchedule.barges.find(b =>
            b.id === `Barge-${bargeEvent.assetId}`
          );

          // If barge not in mobilization schedule OR outside date range, skip it
          if (!bargeMob) return; // Never mobilized (shouldn't exist)

          if (currentDateTime && currentDateTime.fullDate) {
            if (currentDateTime.fullDate < bargeMob.mobDate || currentDateTime.fullDate > bargeMob.demobDate) {
              return; // Not mobilized yet or already demobilized
            }
          }

          // Only include barges at sources (not en-route or at-rig)
          if (!bargeEvent.location || !bargeEvent.location.includes('source')) return;

          const sourceId = bargeEvent.location.match(/source(\d+)/)?.[0];
          if (!sourceId || !grouped[sourceId]) return;

          // Skip barges attached to tugs that are traveling or at-rig (not at source)
          const attachedToTug = tugPositions.find(t =>
            t.attachedBargeIds &&
            t.attachedBargeIds.includes(bargeEvent.assetId) &&
            (t.status === 'en-route-loaded' || t.status === 'en-route-empty' || t.status === 'at-rig' || t.status === 'arrived-at-rig' || t.status === 'throttled-standby' || t.status === 'direct-hdd-delivery')
          );
          if (attachedToTug) return;

          const capacity = bargeEvent.capacity || (bargeEvent.assetType === 'Barge (large)' ? 400000 : 80000);
          let fillLevel = bargeEvent.fillLevel || 0;

          // Calculate real-time fill for filling barges
          if (bargeEvent.status === 'filling') {
            const sourceFlowRate = config.sourceConfig?.[sourceId]?.flowRate || 800;
            const fillRatePerHour = sourceFlowRate * 60;

            // Find the transition TO 'filling' status (when filling started this session)
            const bargeAllEvents = result.assetLog
              .filter(e => e.assetId === bargeEvent.assetId)
              .sort((a, b) => a.simHour - b.simHour);

            // Find the most recent non-filling event before current time
            let fillStartEvent = null;
            for (let i = 0; i < bargeAllEvents.length; i++) {
              if (bargeAllEvents[i].simHour > currentSimulationHour) break;

              // When we see 'filling' status, check if previous event was NOT filling
              if (bargeAllEvents[i].status === 'filling') {
                const prevEvent = i > 0 ? bargeAllEvents[i - 1] : null;
                if (!prevEvent || prevEvent.status !== 'filling') {
                  fillStartEvent = bargeAllEvents[i]; // This is start of fill session
                }
              }
            }

            if (fillStartEvent) {
              const fillingDuration = currentSimulationHour - fillStartEvent.simHour;
              const volumeFilled = fillingDuration * fillRatePerHour;
              const initialFill = fillStartEvent.fillLevel || 0;
              fillLevel = Math.min(capacity, initialFill + volumeFilled);
            }
          }

          grouped[sourceId].push({
            id: bargeEvent.assetId,
            type: bargeEvent.assetType === 'Barge (large)' ? 'large' : 'small',
            status: bargeEvent.status,
            fillLevel,
            capacity,
            fillPercent: (fillLevel / capacity) * 100
          });
        });

        // Sort by status (filling first, then queued, then idle)
        // FIX 6: Group barges by assigned tug
        Object.keys(grouped).forEach(sourceId => {
          const barges = grouped[sourceId];

          // Separate into tug assignments
          const tugGroups = {};
          const unassigned = [];

          barges.forEach(barge => {
            // Check if barge has an assigned tug ID in details
            const bargeFullEvent = result.assetLog.filter(e => e.assetId === barge.id)
              .sort((a, b) => b.simHour - a.simHour)[0];

            const assignedTugId = bargeFullEvent?.assignedTugId;

            if (assignedTugId) {
              if (!tugGroups[assignedTugId]) tugGroups[assignedTugId] = [];
              tugGroups[assignedTugId].push({ ...barge, tugId: assignedTugId });
            } else {
              unassigned.push(barge);
            }
          });

          grouped[sourceId] = { tugGroups, unassigned };
        });

        return grouped;
      }, [result.assetLog, currentSimulationHour, tugPositions, showSourceCards, config, currentDateTime]);

      // Calculate storage barge positions at HDD sites
      const storageBargePositions = useMemo(() => {
        if (!showStorageBarges) return [];

        const positions = [];

        // Get ALL storage barge info from asset log (small and large)
        const storageBargeEvents = result.assetLog.filter(e =>
          (e.assetType === 'Barge (large)' || e.assetType === 'Barge (small)') &&
          e.usage === 'storage' &&
          e.simHour <= currentSimulationHour
        );

        // Get most recent event for each storage barge
        const bargeStates = {};
        storageBargeEvents.forEach(event => {
          if (!bargeStates[event.assetId] || event.simHour > bargeStates[event.assetId].simHour) {
            bargeStates[event.assetId] = event;
          }
        });

        // Group by assigned crossing for vertical stacking
        const bargesByCrossing = {};
        Object.values(bargeStates).forEach(barge => {
          const crossing = barge.assignedCrossing || barge.location?.match(/HDD\d+/)?.[0];
          if (!crossing) return;

          if (!bargesByCrossing[crossing]) bargesByCrossing[crossing] = [];
          bargesByCrossing[crossing].push({
            id: barge.assetId,
            fillLevel: barge.fillLevel || 0,
            capacity: barge.capacity || 400000,
            assignedRig: barge.assignedRig
          });
        });

        // Position each stack at HDD location
        Object.entries(bargesByCrossing).forEach(([crossing, barges]) => {
          // Get HDD coordinates
          let coords = null;
          for (const [sourceId, sourceData] of Object.entries(window.MULTI_SOURCE_ROUTES || {})) {
            if (sourceData.routes && sourceData.routes[crossing]) {
              const route = sourceData.routes[crossing];
              if (route && route.length > 0) {
                const endPoint = route[route.length - 1];
                coords = { lat: endPoint[1], lng: endPoint[0] };
                break;
              }
            }
          }

          if (!coords) return;

          const svgPos = transformCoord(coords.lng, coords.lat);

          // Vertical stacking (14px spacing, centered on HDD point)
          const totalStackHeight = barges.length * 14;
          const startY = svgPos.y - totalStackHeight / 2;

          barges.forEach((barge, idx) => {
            positions.push({
              ...barge,
              x: svgPos.x + 50, // Offset to right of HDD
              y: startY + (idx * 14),
              crossing
            });
          });
        });

        return positions;
      }, [result.assetLog, currentSimulationHour, showStorageBarges]);

      const svgWidth = 1662, svgHeight = 1303;

      // Get actual rendered SVG dimensions for source card positioning
      const actualSvgWidth = svgRef.current?.clientWidth || svgWidth;
      const actualSvgHeight = svgRef.current?.clientHeight || svgHeight;

      // Calculate viewBox for zoom/pan
      const viewWidth = svgWidth / zoomLevel;
      const viewHeight = svgHeight / zoomLevel;
      const viewX = (svgWidth - viewWidth) / 2 - panOffset.x / zoomLevel;
      const viewY = (svgHeight - viewHeight) / 2 - panOffset.y / zoomLevel;

      return (
        <div style={{ background: 'var(--card-bg)', borderRadius: 'var(--card-radius)', padding: '20px', boxShadow: '0 18px 40px rgba(112, 144, 176, 0.12)' }}>
          {/* TOP: Controls Bar - W3Admin Style */}
          <div style={{
            display: 'flex',
            alignItems: 'center',
            gap: '16px',
            marginBottom: '20px',
            padding: '16px 20px',
            background: 'var(--bg-white)',
            borderRadius: 'var(--card-radius)',
            border: '2px solid var(--border-black)',
            boxShadow: '4px 4px 0 var(--border-black)',
            flexWrap: 'wrap',
            position: 'relative',
            zIndex: 10
          }}>
            {/* Playback Controls */}
            <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
              <button
                onClick={() => {
                  if (isAnimating) {
                    setAnimationState(prev => ({ ...prev, isAnimating: false }));
                  } else {
                    if (animationProgress >= 100) {
                      setAnimationState(prev => ({ ...prev, animationProgress: 0, isAnimating: true }));
                    } else {
                      setAnimationState(prev => ({ ...prev, isAnimating: true }));
                    }
                  }
                }}
                style={{
                  padding: '12px 24px',
                  minWidth: '110px',
                  background: isAnimating ? 'var(--status-red)' : 'var(--primary-accent)',
                  color: 'white',
                  border: '2px solid var(--border-black)',
                  borderRadius: 'var(--btn-radius)',
                  fontWeight: '600',
                  fontSize: '0.875rem',
                  fontFamily: 'Bebas Neue, sans-serif',
                  letterSpacing: '0.05em',
                  cursor: 'pointer',
                  transition: 'all 0.2s ease',
                  boxShadow: '3px 3px 0 var(--border-black)',
                  textTransform: 'uppercase'
                }}
                onMouseEnter={(e) => {
                  e.target.style.transform = 'translate(-2px, -2px)';
                  e.target.style.boxShadow = '5px 5px 0 var(--border-black)';
                }}
                onMouseLeave={(e) => {
                  e.target.style.transform = 'translate(0, 0)';
                  e.target.style.boxShadow = '3px 3px 0 var(--border-black)';
                }}
              >
                {isAnimating ? '⏸ Pause' : '▶ Play'}
              </button>
              <button
                onClick={() => setAnimationState(prev => ({ ...prev, animationProgress: 0, isAnimating: false }))}
                style={{
                  padding: '12px 20px',
                  background: 'var(--bg-white)',
                  color: 'var(--text-dark)',
                  border: '2px solid var(--border-black)',
                  borderRadius: 'var(--btn-radius)',
                  fontWeight: '600',
                  fontSize: '0.875rem',
                  fontFamily: 'Bebas Neue, sans-serif',
                  letterSpacing: '0.05em',
                  cursor: 'pointer',
                  transition: 'all 0.2s ease',
                  boxShadow: '3px 3px 0 var(--border-black)',
                  textTransform: 'uppercase'
                }}
                onMouseEnter={(e) => {
                  e.target.style.transform = 'translate(-2px, -2px)';
                  e.target.style.boxShadow = '5px 5px 0 var(--border-black)';
                }}
                onMouseLeave={(e) => {
                  e.target.style.transform = 'translate(0, 0)';
                  e.target.style.boxShadow = '3px 3px 0 var(--border-black)';
                }}
              >
                ↺ Reset
              </button>

              {/* Timestamp Clock - Grungy Style */}
              <div style={{
                padding: '12px 20px',
                background: 'var(--bg-light)',
                borderRadius: 'var(--btn-radius)',
                border: '2px solid var(--border-black)',
                boxShadow: '2px 2px 0 rgba(0, 0, 0, 0.15)',
                fontFamily: "'IBM Plex Mono', monospace",
                fontSize: '0.9rem',
                fontWeight: '700',
                color: 'var(--text-black)',
                minWidth: '140px',
                textAlign: 'center',
                letterSpacing: '0.05em'
              }}>
                {currentDateTime ? `${currentDateTime.dateStr} ${currentDateTime.timeStr}` : '--/-- --:--'}
              </div>
            </div>

            {/* Progress Slider */}
            <div style={{ flex: 1, display: 'flex', alignItems: 'center', gap: '12px', minWidth: '200px' }}>
              <input
                type="range"
                min="0"
                max="100"
                value={animationProgress}
                onChange={(e) => setAnimationState(prev => ({
                  ...prev,
                  animationProgress: parseFloat(e.target.value),
                  isAnimating: false
                }))}
                style={{
                  flex: 1,
                  height: '6px',
                  background: `linear-gradient(to right, var(--whc-navy) ${animationProgress}%, var(--border-subtle) ${animationProgress}%)`,
                  borderRadius: '3px',
                  cursor: 'pointer',
                  appearance: 'none',
                  WebkitAppearance: 'none'
                }}
              />
              <span style={{
                fontSize: '0.8rem',
                color: 'var(--text-medium)',
                fontFamily: "'IBM Plex Mono', monospace",
                width: '50px',
                textAlign: 'right'
              }}>
                {animationProgress.toFixed(0)}%
              </span>
            </div>

            {/* Speed Control */}
            <div style={{ display: 'flex', alignItems: 'center', gap: '10px', paddingLeft: '16px', borderLeft: '1px solid var(--border-subtle)' }}>
              <span style={{ fontSize: '0.8rem', color: 'var(--text-medium)', fontWeight: '500' }}>Speed</span>
              <input
                type="range"
                min="0"
                max="100"
                value={animationSpeed}
                onChange={(e) => setAnimationState(prev => ({ ...prev, animationSpeed: parseInt(e.target.value) }))}
                style={{
                  width: '100px',
                  height: '6px',
                  background: `linear-gradient(to right, var(--oneok-cyan) ${animationSpeed}%, var(--border-subtle) ${animationSpeed}%)`,
                  borderRadius: '3px',
                  cursor: 'pointer',
                  appearance: 'none',
                  WebkitAppearance: 'none'
                }}
              />
            </div>

            {/* Zoom Controls */}
            <div style={{ display: 'flex', alignItems: 'center', gap: '8px', paddingLeft: '16px', borderLeft: '2px solid var(--border-black)' }}>
              <span style={{
                fontSize: '0.75rem',
                color: 'var(--text-black)',
                fontWeight: '600',
                fontFamily: 'IBM Plex Mono, monospace',
                letterSpacing: '0.05em'
              }}>Zoom</span>
              <button
                onClick={() => setZoomLevel(z => Math.max(0.5, z - 0.25))}
                style={{
                  width: '36px',
                  height: '36px',
                  background: 'var(--bg-white)',
                  border: '2px solid var(--border-black)',
                  borderRadius: 'var(--btn-radius)',
                  fontWeight: '700',
                  fontSize: '1.2rem',
                  color: 'var(--text-black)',
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  transition: 'all 0.2s ease',
                  boxShadow: '2px 2px 0 rgba(0, 0, 0, 0.15)'
                }}
                onMouseEnter={(e) => {
                  e.target.style.transform = 'translate(-1px, -1px)';
                  e.target.style.boxShadow = '3px 3px 0 rgba(0, 0, 0, 0.2)';
                }}
                onMouseLeave={(e) => {
                  e.target.style.transform = 'translate(0, 0)';
                  e.target.style.boxShadow = '2px 2px 0 rgba(0, 0, 0, 0.15)';
                }}
              >
                −
              </button>
              <span style={{
                fontSize: '0.8rem',
                color: 'var(--text-black)',
                fontFamily: "'IBM Plex Mono', monospace",
                fontWeight: '700',
                width: '50px',
                textAlign: 'center'
              }}>
                {(zoomLevel * 100).toFixed(0)}%
              </span>
              <button
                onClick={() => setZoomLevel(z => Math.min(4, z + 0.25))}
                style={{
                  width: '36px',
                  height: '36px',
                  background: 'var(--bg-white)',
                  border: '2px solid var(--border-black)',
                  borderRadius: 'var(--btn-radius)',
                  fontWeight: '700',
                  fontSize: '1.2rem',
                  color: 'var(--text-black)',
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  transition: 'all 0.2s ease',
                  boxShadow: '2px 2px 0 rgba(0, 0, 0, 0.15)'
                }}
                onMouseEnter={(e) => {
                  e.target.style.transform = 'translate(-1px, -1px)';
                  e.target.style.boxShadow = '3px 3px 0 rgba(0, 0, 0, 0.2)';
                }}
                onMouseLeave={(e) => {
                  e.target.style.transform = 'translate(0, 0)';
                  e.target.style.boxShadow = '2px 2px 0 rgba(0, 0, 0, 0.15)';
                }}
              >
                +
              </button>
              <button
                onClick={() => { setZoomLevel(1.5); setPanOffset({ x: 0, y: 0 }); }}
                style={{
                  padding: '8px 14px',
                  background: 'var(--bg-white)',
                  border: '2px solid var(--border-black)',
                  borderRadius: 'var(--btn-radius)',
                  fontSize: '0.7rem',
                  fontWeight: '600',
                  color: 'var(--text-dark)',
                  cursor: 'pointer',
                  fontFamily: 'Bebas Neue, sans-serif',
                  letterSpacing: '0.05em',
                  textTransform: 'uppercase',
                  transition: 'all 0.2s ease',
                  boxShadow: '2px 2px 0 rgba(0, 0, 0, 0.15)'
                }}
                onMouseEnter={(e) => {
                  e.target.style.transform = 'translate(-1px, -1px)';
                  e.target.style.boxShadow = '3px 3px 0 rgba(0, 0, 0, 0.2)';
                }}
                onMouseLeave={(e) => {
                  e.target.style.transform = 'translate(0, 0)';
                  e.target.style.boxShadow = '2px 2px 0 rgba(0, 0, 0, 0.15)';
                }}
              >
                Reset
              </button>
            </div>
          </div>

          {/* MAIN CONTENT: Sidebar + Map */}
          <div style={{ display: 'flex', gap: '20px' }}>
            {/* LEFT: Narrow Sidebar - Grungy Style */}
            <div style={{ flexShrink: 0, width: '180px', display: 'flex', flexDirection: 'column', gap: '16px' }}>
              {/* Layer Toggles */}
              <div style={{
                background: 'var(--bg-white)',
                borderRadius: 'var(--card-radius)',
                padding: '16px',
                border: '2px solid var(--border-black)',
                boxShadow: '3px 3px 0 var(--border-black)'
              }}>
                <span style={{
                  display: 'block',
                  fontSize: '0.75rem',
                  fontWeight: '700',
                  color: 'var(--text-black)',
                  textTransform: 'uppercase',
                  letterSpacing: '0.1em',
                  marginBottom: '12px',
                  fontFamily: 'Bebas Neue, sans-serif'
                }}>LAYERS</span>
                {[
                  { checked: showRoutes, onChange: setShowRoutes, label: 'Routes' },
                  { checked: showHDDMeters, onChange: setShowHDDMeters, label: 'HDD Meters' },
                  { checked: showSourceCards, onChange: setShowSourceCards, label: 'Source Cards' },
                  { checked: showStorageBarges, onChange: setShowStorageBarges, label: 'Storage Barges' }
                ].map((item, idx) => (
                  <label key={idx} style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '10px',
                    cursor: 'pointer',
                    padding: '10px 0',
                    borderBottom: idx < 3 ? '2px solid var(--border-light)' : 'none'
                  }}>
                    <input
                      type="checkbox"
                      checked={item.checked}
                      onChange={(e) => item.onChange(e.target.checked)}
                      style={{
                        width: '18px',
                        height: '18px',
                        accentColor: 'var(--primary-accent)',
                        cursor: 'pointer',
                        border: '2px solid var(--border-black)'
                      }}
                    />
                    <span style={{
                      fontSize: '0.75rem',
                      color: 'var(--text-dark)',
                      fontWeight: '600',
                      fontFamily: 'Work Sans, sans-serif'
                    }}>{item.label}</span>
                  </label>
                ))}
              </div>

              {/* Real-time Counters - Grungy Style */}
              <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                <div style={{
                  background: 'var(--bg-white)',
                  borderRadius: 'var(--btn-radius)',
                  padding: '14px',
                  border: '2px solid var(--border-black)',
                  boxShadow: '2px 2px 0 rgba(0, 0, 0, 0.15)'
                }}>
                  <div style={{
                    fontSize: '0.65rem',
                    color: 'var(--text-medium)',
                    marginBottom: '4px',
                    textTransform: 'uppercase',
                    letterSpacing: '0.05em',
                    fontFamily: 'IBM Plex Mono, monospace'
                  }}>Trips</div>
                  <div style={{
                    fontSize: '1.5rem',
                    fontWeight: '700',
                    color: 'var(--primary-accent)',
                    fontFamily: 'Bebas Neue, sans-serif',
                    letterSpacing: '0.02em'
                  }}>{counters.trips}</div>
                </div>
                <div style={{
                  background: 'var(--bg-white)',
                  borderRadius: 'var(--btn-radius)',
                  padding: '14px',
                  border: '2px solid var(--border-black)',
                  boxShadow: '2px 2px 0 rgba(0, 0, 0, 0.15)'
                }}>
                  <div style={{
                    fontSize: '0.65rem',
                    color: 'var(--text-medium)',
                    marginBottom: '4px',
                    textTransform: 'uppercase',
                    letterSpacing: '0.05em',
                    fontFamily: 'IBM Plex Mono, monospace'
                  }}>Tug Days</div>
                  <div style={{
                    fontSize: '1.5rem',
                    fontWeight: '700',
                    color: 'var(--status-green)',
                    fontFamily: 'Bebas Neue, sans-serif',
                    letterSpacing: '0.02em'
                  }}>{counters.tugDays}</div>
                </div>
                <div style={{
                  background: 'var(--bg-white)',
                  borderRadius: 'var(--btn-radius)',
                  padding: '14px',
                  border: '2px solid var(--border-black)',
                  boxShadow: '2px 2px 0 rgba(0, 0, 0, 0.15)'
                }}>
                  <div style={{
                    fontSize: '0.65rem',
                    color: 'var(--text-medium)',
                    marginBottom: '4px',
                    textTransform: 'uppercase',
                    letterSpacing: '0.05em',
                    fontFamily: 'IBM Plex Mono, monospace'
                  }}>Sm Brg Days</div>
                  <div style={{
                    fontSize: '1.5rem',
                    fontWeight: '700',
                    color: 'var(--status-orange)',
                    fontFamily: 'Bebas Neue, sans-serif',
                    letterSpacing: '0.02em'
                  }}>{counters.smallBargeDays}</div>
                </div>
                <div style={{
                  background: 'var(--bg-white)',
                  borderRadius: 'var(--btn-radius)',
                  padding: '14px',
                  border: '2px solid var(--border-black)',
                  boxShadow: '2px 2px 0 rgba(0, 0, 0, 0.15)'
                }}>
                  <div style={{
                    fontSize: '0.65rem',
                    color: 'var(--text-medium)',
                    marginBottom: '4px',
                    textTransform: 'uppercase',
                    letterSpacing: '0.05em',
                    fontFamily: 'IBM Plex Mono, monospace'
                  }}>Lg Brg Days</div>
                  <div style={{
                    fontSize: '1.5rem',
                    fontWeight: '700',
                    color: 'var(--whc-red)',
                    fontFamily: 'Bebas Neue, sans-serif',
                    letterSpacing: '0.02em'
                  }}>{counters.largeBargeDays}</div>
                </div>
              </div>

              {/* Counter Validation Section */}
              {animationProgress >= 99 && (
                <div className="p-2 bg-yellow-50 border border-yellow-200 rounded-lg">
                  <h3 className="font-semibold text-yellow-800 mb-1 text-xs">Validation</h3>
                  <div className="space-y-1 text-xs">
                    <div>
                      <span className="text-gray-600">Anim:</span>
                      <span className="font-mono ml-1">{counters.tugDays}</span>
                    </div>
                    <div>
                      <span className="text-gray-600">Exp:</span>
                      <span className="font-mono ml-1">{result.mobilizationSchedule.summary.totalTugDays}</span>
                      <span className={`ml-1 ${Math.abs(counters.tugDays - result.mobilizationSchedule.summary.totalTugDays) < 1 ? 'text-green-600' : 'text-red-600'}`}>
                        {Math.abs(counters.tugDays - result.mobilizationSchedule.summary.totalTugDays) < 1 ? '✓' : '✗'}
                      </span>
                    </div>
                  </div>
                </div>
              )}
            </div>

            {/* RIGHT: Large Map */}
            <div className="flex-1 border rounded-lg overflow-hidden bg-gray-100 relative" style={{ height: '800px' }}>
            <svg
              ref={svgRef}
              width="100%"
              height="100%"
              viewBox={`${viewX} ${viewY} ${viewWidth} ${viewHeight}`}
              className="bg-white"
              style={{ cursor: isPanning ? 'grabbing' : 'grab' }}
              onMouseDown={handleMouseDown}
            >
              {/* Background Image */}
              <image
                href="map_background.png"
                x="0"
                y="0"
                width={svgWidth}
                height={svgHeight}
                opacity="1"
                preserveAspectRatio="none"
              />

              {/* Routes: FIX 4: Show only routes from sources actually used for active HDDs */}
              {showRoutes && hddMeters.map((meter, idx) => {
                // Find which sources are actually used for this HDD (from journey history)
                const sourcesUsed = new Set();
                result.tugJourneys.forEach(j => {
                  if (j.targetCrossing === meter.crossing) {
                    sourcesUsed.add(j.sourceId);
                  }
                });

                // Only show routes from sources that will be used
                return Array.from(sourcesUsed).map(sourceId => {
                  const sourceData = window.MULTI_SOURCE_ROUTES?.[sourceId];
                  const routeData = sourceData?.routes?.[meter.crossing];
                  if (!routeData) return null;

                  const pathData = routeData.map((point, i) => {
                    const pos = transformCoord(point[0], point[1]);
                    return `${i === 0 ? 'M' : 'L'} ${pos.x} ${pos.y}`;
                  }).join(' ');

                  // Check if this route is currently being traveled
                  const isActiveRoute = result.tugJourneys.some(j =>
                    j.sourceId === sourceId &&
                    j.targetCrossing === meter.crossing &&
                    j.state === 'traveling-loaded' &&
                    j.startHour <= currentSimulationHour &&
                    j.endHour >= currentSimulationHour
                  );

                  return (
                    <path
                      key={`route-${sourceId}-${meter.crossing}`}
                      d={pathData}
                      stroke={isActiveRoute ? "#fbbf24" : "#94a3b8"}
                      strokeWidth={isActiveRoute ? "3" : "2"}
                      fill="none"
                      opacity={isActiveRoute ? 0.8 : 0.3}
                      strokeDasharray={isActiveRoute ? "5,5" : "none"}
                    />
                  );
                });
              })}

              {/* Barges (render first so they appear behind tugs) */}
              {bargePositions.map((barge, idx) => {
                // Barge dimensions: Small = 12×12px square, Large = 18×12px rectangle
                const width = barge.type === 'large' ? 18 : 12;
                const height = 12; // Same as tug height

                // Colors
                const bargeColor = barge.type === 'large' ? '#a855f7' : '#fb923c'; // Purple for large, orange for small

                // Fill percentage
                const fillPercent = Math.min(100, (barge.fillLevel / barge.capacity) * 100);

                // Position offset from tug (stack barges behind tug horizontally)
                // Use stackIndex if available (for barges attached to tug), otherwise use global idx
                const bargeStackIndex = barge.stackIndex !== undefined ? barge.stackIndex : idx;
                const offsetDistance = 18 + (bargeStackIndex * 12); // Barge trails behind tug
                const offsetX = -Math.cos(barge.angle * Math.PI / 180) * offsetDistance;
                const offsetY = -Math.sin(barge.angle * Math.PI / 180) * offsetDistance;

                return (
                  <g key={`barge-${barge.bargeId}`} transform={`translate(${barge.x + offsetX}, ${barge.y + offsetY}) rotate(${barge.angle})`}>
                    {/* Barge body (simple rectangle) - Refined dark grey border */}
                    <rect
                      x={-width/2}
                      y={-height/2}
                      width={width}
                      height={height}
                      fill={bargeColor}
                      stroke="#3a3a3a"
                      strokeWidth="1.5"
                      rx="1"
                    />

                    {/* Fill meter background (empty bar) - Subtle border */}
                    <rect
                      x={-width/2 + 2}
                      y={-height/4}
                      width={width - 4}
                      height={height/2}
                      fill="white"
                      stroke="#5a5a5a"
                      strokeWidth="0.75"
                      rx="1"
                    />

                    {/* Fill meter foreground (colored fill growing left to right) */}
                    <rect
                      x={-width/2 + 2}
                      y={-height/4}
                      width={Math.max(0, (width - 4) * (fillPercent / 100))}
                      height={height/2}
                      fill="#3d7068"
                      rx="1"
                    />
                  </g>
                );
              })}

              {/* Tugs (realistic tugboat shape from above) */}
              {tugPositions.map(tug => {
                const color = tug.status === 'en-route-loaded' ? '#0891b2' :
                             tug.status === 'direct-hdd-delivery' ? '#d97706' :  // Amber for HDD-to-HDD
                             tug.status === 'throttled-standby' ? '#a855f7' :  // Purple for throttled standby
                             tug.status === 'at-rig' ? '#22c55e' : '#94a3b8';

                // Tug dimensions (tugboat shape)
                const tugLength = 20;
                const tugWidth = 12;
                const bowLength = 6; // Pointed bow

                // Tug shape: Rectangle (wheelhouse) + chevron point (bow)
                // Body is rectangle, front is pointed chevron
                const tugPath = `
                  M ${-tugLength/2} ${-tugWidth/2}
                  L ${tugLength/2 - bowLength} ${-tugWidth/2}
                  L ${tugLength/2} 0
                  L ${tugLength/2 - bowLength} ${tugWidth/2}
                  L ${-tugLength/2} ${tugWidth/2}
                  Z
                `;

                // Wheelhouse detail (darker rectangle in center-rear)
                const wheelhouseWidth = 6;
                const wheelhouseHeight = 6;

                return (
                  <g key={`tug-${tug.tugId}`} transform={`translate(${tug.x}, ${tug.y}) rotate(${tug.angle})`}>
                    {/* Tug main body - Refined dark grey border */}
                    <path
                      d={tugPath}
                      fill={color}
                      stroke="#3a3a3a"
                      strokeWidth="1.5"
                    />
                    {/* Wheelhouse detail */}
                    <rect
                      x={-tugLength/2 + 2}
                      y={-wheelhouseHeight/2}
                      width={wheelhouseWidth}
                      height={wheelhouseHeight}
                      fill="rgba(0, 0, 0, 0.3)"
                      rx="1"
                    />
                  </g>
                );
              })}

              {/* Storage Barges - Not rendered visually, only shown as text labels below HDD meters */}

              {/* HDD Storage Meters - Match source card styling exactly */}
              {hddMeters.map(meter => {
                const barWidth = 60; // Fill bar area (narrower)
                const labelWidth = 40; // HDD label area
                const totalWidth = barWidth + labelWidth;
                const meterHeight = 16;
                const outerPadding = 2; // Space between outer and white bar
                const innerPadding = 2; // White margin around colored fill

                const fillWidth = (barWidth - outerPadding * 2 - innerPadding * 2) * (meter.fillPercent / 100);

                // Mute colors during RigUp/RigDown (not consuming water)
                const isInactive = meter.stage === 'RigUp' || meter.stage === 'RigDown';
                const meterColor = isInactive ? '#9ca3af' : meter.color; // Gray when inactive
                const meterOpacity = isInactive ? 0.6 : 1;

                // Position meter to the right of the HDD endpoint, vertically centered
                const meterOffsetX = 15; // Small gap to the right of tug position
                const meterOffsetY = -meterHeight / 2; // Center vertically on tug position

                return (
                  <g key={`hdd-meter-${meter.crossing}`} opacity={meterOpacity}>
                    {/* Flat shadow - solid black rectangle offset 3px right and 3px down */}
                    <rect
                      x={meter.x + meterOffsetX + 3}
                      y={meter.y + meterOffsetY + 3}
                      width={totalWidth}
                      height={meterHeight}
                      fill="#1a1a1a"
                      rx="6"
                    />

                    {/* Outer container (rig-colored background) - Thin border like source card */}
                    <rect
                      x={meter.x + meterOffsetX}
                      y={meter.y + meterOffsetY}
                      width={totalWidth}
                      height={meterHeight}
                      fill={meterColor}
                      stroke="#1a1a1a"
                      strokeWidth="1"
                      rx="6"
                    />

                    {/* White background bar */}
                    <rect
                      x={meter.x + meterOffsetX + outerPadding}
                      y={meter.y + meterOffsetY + outerPadding}
                      width={barWidth - outerPadding * 2}
                      height={meterHeight - outerPadding * 2}
                      fill="white"
                      rx="2"
                    />

                    {/* Colored fill (grows left to right with white margin) */}
                    <rect
                      x={meter.x + meterOffsetX + outerPadding + innerPadding}
                      y={meter.y + meterOffsetY + outerPadding + innerPadding}
                      width={fillWidth}
                      height={meterHeight - outerPadding * 2 - innerPadding * 2}
                      fill={meterColor}
                      rx="1"
                    />

                    {/* Storage barge IDs (inside white bar area) */}
                    {(() => {
                      // Use pre-calculated storage barge IDs from meter data
                      const assignedBargeList = meter.storageBargeIds || [];
                      const displayText = assignedBargeList.join(',');

                      // Only render if we have barges to show
                      if (!displayText) return null;

                      // Adjust font size based on number of characters
                      const fontSize = displayText.length > 12 ? 6.5 : 8;

                      // Use white text with dark stroke for contrast on any fill level
                      return (
                        <text
                          x={meter.x + meterOffsetX + barWidth/2}
                          y={meter.y + meterOffsetY + meterHeight/2 + 3}
                          textAnchor="middle"
                          fontSize={fontSize}
                          fontWeight="normal"
                          fill="white"
                          stroke="#1e293b"
                          strokeWidth="2.5"
                          paintOrder="stroke"
                        >
                          {displayText}
                        </text>
                      );
                    })()}

                    {/* HDD label (white text on colored background, right side) */}
                    <text
                      x={meter.x + meterOffsetX + barWidth + labelWidth/2}
                      y={meter.y + meterOffsetY + meterHeight/2 + 4}
                      textAnchor="middle"
                      fontSize="11"
                      fontWeight="normal"
                      fill="white"
                    >
                      {meter.crossing}
                    </text>
                  </g>
                );
              })}

              {/* Sources - Removed per user request (already on background map) */}
            </svg>

            {/* Source Floating Cards - Adaptive sizing for visibility */}
            {showSourceCards && ['source1', 'source2', 'source3'].map(sourceId => {
              const data = bargesAtSources[sourceId] || { tugGroups: {}, unassigned: [] };
              const { tugGroups, unassigned } = data;
              const totalBarges = Object.values(tugGroups).flat().length + unassigned.length;

              // Get source position in SVG coordinates
              const sourceData = window.MULTI_SOURCE_ROUTES?.[sourceId];
              if (!sourceData || !sourceData.location) {
                return null;
              }

              const sourcePos = transformCoord(sourceData.location.lng, sourceData.location.lat);

              // Calculate position accounting for zoom/pan using actual rendered dimensions
              const scaledX = (sourcePos.x - viewX) * (actualSvgWidth / viewWidth);
              const scaledY = (sourcePos.y - viewY) * (actualSvgHeight / viewHeight);

              // Check if source is visible in viewport
              const isVisible = scaledX >= 0 && scaledX <= actualSvgWidth &&
                               scaledY >= 0 && scaledY <= actualSvgHeight;

              // If source not visible, don't render card
              if (!isVisible) {
                return null;
              }

              // Calculate available space for card
              const spaceToRight = actualSvgWidth - scaledX;
              const spaceToLeft = scaledX;
              const spaceBelow = actualSvgHeight - scaledY;
              const spaceAbove = scaledY;

              // Determine card width based on available space
              const preferredWidth = 200;
              const minWidth = 150;
              let cardWidth = preferredWidth;
              let offsetX = 0;

              if (sourceId === 'source2') {
                // Source 2: prefer right side
                if (spaceToRight > preferredWidth + 30) {
                  offsetX = 30;
                } else if (spaceToRight > minWidth + 30) {
                  cardWidth = spaceToRight - 40;
                  offsetX = 30;
                } else if (spaceToLeft > preferredWidth + 30) {
                  // Flip to left if not enough space on right
                  offsetX = -(preferredWidth + 10);
                } else {
                  cardWidth = Math.max(minWidth, spaceToLeft - 40);
                  offsetX = -(cardWidth + 10);
                }
              } else {
                // Source 1 & 3: prefer left side
                if (spaceToLeft > preferredWidth + 30) {
                  offsetX = -(preferredWidth + 10);
                } else if (spaceToLeft > minWidth + 30) {
                  cardWidth = spaceToLeft - 40;
                  offsetX = -(cardWidth + 10);
                } else if (spaceToRight > preferredWidth + 30) {
                  // Flip to right if not enough space on left
                  offsetX = 30;
                } else {
                  cardWidth = Math.max(minWidth, spaceToRight - 40);
                  offsetX = 30;
                }
              }

              // Determine card height based on available space
              const preferredMaxHeight = 400;
              const minHeight = 150;
              let maxHeight = preferredMaxHeight;
              let offsetY = 0;

              if (sourceId === 'source1') {
                // Source 1: prefer below (top-aligned)
                offsetY = 0;
                maxHeight = Math.max(minHeight, Math.min(preferredMaxHeight, spaceBelow - 20));
              } else {
                // Source 2 & 3: prefer above
                if (spaceAbove > preferredMaxHeight + 50) {
                  offsetY = -50;
                  maxHeight = preferredMaxHeight;
                } else if (spaceAbove > minHeight + 50) {
                  maxHeight = spaceAbove - 60;
                  offsetY = -50;
                } else if (spaceBelow > preferredMaxHeight) {
                  // Flip below if not enough space above
                  offsetY = 10;
                  maxHeight = Math.max(minHeight, Math.min(preferredMaxHeight, spaceBelow - 20));
                } else {
                  maxHeight = Math.max(minHeight, spaceBelow - 20);
                  offsetY = 10;
                }
              }

              return (
                <div
                  key={`source-card-${sourceId}`}
                  style={{
                    position: 'absolute',
                    left: `${scaledX + offsetX}px`,
                    top: `${scaledY + offsetY}px`,
                    width: `${cardWidth}px`,
                    maxHeight: `${maxHeight}px`,
                    overflow: 'auto',
                    zIndex: 10,
                    background: 'var(--bg-white)',
                    borderRadius: 'var(--btn-radius)',
                    border: '2px solid var(--border-black)',
                    boxShadow: '3px 3px 0 var(--border-black)',
                    padding: '12px'
                  }}
                >
                  <div style={{
                    fontFamily: 'Bebas Neue, sans-serif',
                    fontSize: '0.95rem',
                    fontWeight: '400',
                    letterSpacing: '0.05em',
                    color: 'var(--text-black)',
                    marginBottom: '10px',
                    paddingBottom: '8px',
                    borderBottom: '2px solid var(--border-black)',
                    textTransform: 'uppercase'
                  }}>
                    Source {sourceId.replace('source', '')}
                  </div>

                  {/* Tug-assigned barges */}
                  {Object.entries(tugGroups).map(([tugId, barges]) => (
                    <div key={`tug-${tugId}`} style={{ marginBottom: '12px' }}>
                      <div style={{
                        fontFamily: 'IBM Plex Mono, monospace',
                        fontSize: '0.7rem',
                        fontWeight: '600',
                        color: 'var(--primary-accent)',
                        marginBottom: '6px',
                        letterSpacing: '0.03em'
                      }}>TUG {tugId}</div>
                      {barges.map(barge => {
                        const statusColor = barge.status === 'filling' ? 'var(--status-green)' :
                                           barge.status === 'queued' ? 'var(--status-orange)' : 'var(--text-light)';

                        return (
                          <div key={barge.id} style={{
                            marginBottom: '6px',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '6px',
                            fontSize: '0.7rem'
                          }}>
                            <span style={{
                              fontFamily: 'IBM Plex Mono, monospace',
                              fontWeight: '600',
                              width: '32px',
                              color: 'var(--text-black)'
                            }}>{barge.id}</span>
                            <div style={{
                              flex: 1,
                              height: '12px',
                              background: 'var(--bg-light)',
                              borderRadius: '3px',
                              overflow: 'hidden',
                              border: '1px solid var(--border-black)'
                            }}>
                              <div style={{
                                height: '100%',
                                width: `${barge.fillPercent.toFixed(0)}%`,
                                background: 'var(--status-green)',
                                transition: 'width 0.3s ease'
                              }} />
                            </div>
                            <span style={{
                              fontFamily: 'IBM Plex Mono, monospace',
                              fontWeight: '700',
                              width: '32px',
                              textAlign: 'right',
                              fontSize: '0.65rem',
                              color: 'var(--text-black)'
                            }}>{barge.fillPercent.toFixed(0)}%</span>
                            <span style={{
                              width: '40px',
                              textAlign: 'right',
                              color: statusColor,
                              fontFamily: 'Work Sans, sans-serif',
                              fontWeight: '600',
                              fontSize: '0.65rem',
                              textTransform: 'uppercase'
                            }}>
                              {barge.status === 'filling' ? 'Fill' : barge.status === 'queued' ? 'Queue' : 'Idle'}
                            </span>
                          </div>
                        );
                      })}
                    </div>
                  ))}

                  {/* Unassigned barges */}
                  {unassigned.length > 0 && (
                    <div style={Object.keys(tugGroups).length > 0 ? {
                      marginTop: '12px',
                      paddingTop: '12px',
                      borderTop: '2px solid var(--border-light)'
                    } : {}}>
                      {unassigned.map(barge => {
                        const statusColor = barge.status === 'filling' ? 'var(--status-green)' :
                                           barge.status === 'queued' ? 'var(--status-orange)' : 'var(--text-light)';

                        return (
                          <div key={barge.id} style={{
                            marginBottom: '6px',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '6px',
                            fontSize: '0.7rem'
                          }}>
                            <span style={{
                              fontFamily: 'IBM Plex Mono, monospace',
                              fontWeight: '600',
                              width: '32px',
                              color: 'var(--text-black)'
                            }}>{barge.id}</span>
                            <div style={{
                              flex: 1,
                              height: '12px',
                              background: 'var(--bg-light)',
                              borderRadius: '3px',
                              overflow: 'hidden',
                              border: '1px solid var(--border-black)'
                            }}>
                              <div style={{
                                height: '100%',
                                width: `${barge.fillPercent.toFixed(0)}%`,
                                background: 'var(--status-green)',
                                transition: 'width 0.3s ease'
                              }} />
                            </div>
                            <span style={{
                              fontFamily: 'IBM Plex Mono, monospace',
                              fontWeight: '700',
                              width: '32px',
                              textAlign: 'right',
                              fontSize: '0.65rem',
                              color: 'var(--text-black)'
                            }}>{barge.fillPercent.toFixed(0)}%</span>
                            <span style={{
                              width: '40px',
                              textAlign: 'right',
                              color: statusColor,
                              fontFamily: 'Work Sans, sans-serif',
                              fontWeight: '600',
                              fontSize: '0.65rem',
                              textTransform: 'uppercase'
                            }}>
                              {barge.status === 'filling' ? 'Fill' : barge.status === 'queued' ? 'Queue' : 'Idle'}
                            </span>
                          </div>
                        );
                      })}
                    </div>
                  )}

                  {totalBarges === 0 && (
                    <div style={{
                      fontSize: '0.7rem',
                      color: 'var(--text-light)',
                      fontStyle: 'italic',
                      fontFamily: 'Work Sans, sans-serif'
                    }}>No equipment at source</div>
                  )}
                </div>
              );
            })}
          </div>
          {/* END MAP */}

          </div>
          {/* END MAIN CONTENT */}

        </div>
      );
    }

    // MOBILIZATION SCHEDULE TAB - Gantt chart showing all asset mob/demob dates
    function MobilizationScheduleTab({ result }) {
      if (!result || !result.mobilizationSchedule) {
        return <div className="text-gray-500 p-8">No mobilization schedule available</div>;
      }

      const schedule = result.mobilizationSchedule;
      const allAssets = [...(schedule.tugs || []), ...(schedule.barges || [])];

      if (allAssets.length === 0) {
        return <div className="text-gray-500 p-8">No assets mobilized</div>;
      }

      // Sort assets by mobDate, then by type
      const sortedAssets = allAssets.sort((a, b) => {
        if (a.mobDate !== b.mobDate) return a.mobDate.localeCompare(b.mobDate);
        if (a.assetType !== b.assetType) return a.assetType.localeCompare(b.assetType);
        return a.id.localeCompare(b.id);
      });

      // Find date range
      const allDates = sortedAssets.flatMap(a => [a.mobDate, a.demobDate]);
      const minDate = new Date(Math.min(...allDates.map(d => new Date(d))));
      const maxDate = new Date(Math.max(...allDates.map(d => new Date(d))));
      const totalDays = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24)) + 1;

      return (
        <div className="space-y-4">
          <div className="bg-white rounded-lg shadow p-6">
            <h3 className="font-semibold mb-4 text-lg">Asset Mobilization Schedule</h3>
            <div className="text-sm text-gray-600 mb-4">
              Total Assets: {allAssets.length}
              ({schedule.tugs?.length || 0} tugs, {schedule.barges?.filter(b => b.bargeSize === 'small').length || 0} small barges,
              {schedule.barges?.filter(b => b.bargeSize === 'large').length || 0} large barges)
            </div>

            {/* Gantt Chart */}
            <div className="overflow-x-auto">
              <table className="text-xs border-collapse" style={{ minWidth: `${totalDays * 20 + 500}px` }}>
                <thead>
                  <tr className="bg-gray-100">
                    <th className="border p-2 text-left sticky left-0 bg-gray-100 z-10" style={{ width: '120px', minWidth: '120px' }}>Asset ID</th>
                    <th className="border p-2 text-left" style={{ width: '140px', minWidth: '140px' }}>Type</th>
                    <th className="border p-2 text-left" style={{ width: '90px', minWidth: '90px' }}>Mob Date</th>
                    <th className="border p-2 text-left" style={{ width: '90px', minWidth: '90px' }}>Demob Date</th>
                    <th className="border p-2 text-right" style={{ width: '60px', minWidth: '60px' }}>Days</th>
                    <th className="border p-2 text-left" colSpan={totalDays}>Timeline</th>
                  </tr>
                </thead>
                <tbody>
                  {sortedAssets.map((asset, idx) => {
                    const mobDate = new Date(asset.mobDate);
                    const demobDate = new Date(asset.demobDate);
                    const startDay = Math.ceil((mobDate - minDate) / (1000 * 60 * 60 * 24));
                    const endDay = Math.ceil((demobDate - minDate) / (1000 * 60 * 60 * 24));
                    const duration = endDay - startDay + 1;

                    // Color by asset type - Using Option 2 Balanced Duo Palette
                    const bgColor = asset.assetType === 'tug' ? 'var(--color-2-ocean-blue)' :
                                   (asset.bargeSize === 'large' ? 'var(--color-3-crimson)' : 'var(--color-4-soft-crimson)');
                    const borderColor = 'var(--color-5-blue-gray)';
                    const textColor = asset.assetType === 'tug' ? 'var(--color-1-deep-navy)' :
                                     (asset.bargeSize === 'large' ? 'var(--color-3-crimson)' : 'var(--color-4-soft-crimson)');

                    return (
                      <tr key={idx} className="hover:bg-gray-50">
                        <td className="border p-2 font-mono sticky left-0 bg-white z-10">{asset.id}</td>
                        <td className="border p-2 font-medium" style={{ color: textColor, fontFamily: 'IBM Plex Mono, monospace', fontSize: '0.75rem' }}>
                          {asset.assetType === 'tug' ? 'Tug' : `${asset.bargeSize.charAt(0).toUpperCase() + asset.bargeSize.slice(1)} ${asset.usage}`}
                        </td>
                        <td className="border p-2">{asset.mobDate}</td>
                        <td className="border p-2">{asset.demobDate}</td>
                        <td className="border p-2 text-right">{asset.daysOnSite}</td>
                        <td className="border p-0" colSpan={totalDays}>
                          <div className="relative h-8" style={{ width: `${totalDays * 20}px` }}>
                            <div
                              className="absolute h-6 top-1"
                              style={{
                                left: `${startDay * 20}px`,
                                width: `${duration * 20}px`,
                                background: bgColor,
                                border: `2px solid ${borderColor}`,
                                borderRadius: '3px',
                                boxShadow: '2px 2px 0 rgba(0, 0, 0, 0.15)'
                              }}
                              title={`${asset.id}: ${asset.mobDate} to ${asset.demobDate} (${asset.daysOnSite} days)`}
                            >
                              <span className="text-white text-xs px-1 truncate block leading-6" style={{ fontWeight: '600', textShadow: '0 1px 2px rgba(0,0,0,0.3)' }}>
                                {duration > 3 ? `${asset.daysOnSite}d` : ''}
                              </span>
                            </div>
                          </div>
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>

            {/* Daily Water Demand Chart */}
            {result.dailyResults && result.dailyResults.length > 0 && (
              <div className="mt-6">
                <h4 className="font-semibold mb-2 text-sm">Daily Water Demand</h4>
                <div className="overflow-x-auto">
                  <table className="text-xs border-collapse" style={{ minWidth: `${totalDays * 20 + 500}px` }}>
                    <tbody>
                      <tr>
                        <td className="border p-2" style={{ width: '120px', minWidth: '120px' }}></td>
                        <td className="border p-2" style={{ width: '140px', minWidth: '140px' }}></td>
                        <td className="border p-2" style={{ width: '90px', minWidth: '90px' }}></td>
                        <td className="border p-2" style={{ width: '90px', minWidth: '90px' }}></td>
                        <td className="border p-2" style={{ width: '60px', minWidth: '60px' }}></td>
                        <td className="border p-0" colSpan={totalDays}>
                          <svg width={totalDays * 20} height="180" className="border-l border-gray-300">
                      {(() => {
                        const dailyDemands = result.dailyResults.map(d => {
                          const dateStr = d.date;
                          const date = new Date(dateStr);
                          const dayOffset = Math.floor((date - minDate) / (1000 * 60 * 60 * 24));
                          return { dayOffset, demand: d.demand || 0, date: dateStr };
                        });

                        const maxDemand = Math.max(...dailyDemands.map(d => d.demand), 1);
                        const yScale = 120 / maxDemand; // 120px chart height
                        const gridLines = 5;
                        const gridStep = maxDemand / gridLines;

                        return (
                          <>
                            {/* Y-axis grid lines and labels */}
                            {[...Array(gridLines + 1)].map((_, i) => {
                              const value = Math.round(gridStep * i);
                              const y = 130 - (value * yScale);
                              return (
                                <g key={i}>
                                  <line x1="0" y1={y} x2={totalDays * 20} y2={y} stroke="#E5E7EB" strokeWidth="1" />
                                  <text x="-5" y={y + 3} fontSize="9" fill="#6B7280" textAnchor="end">
                                    {(value / 1000).toFixed(0)}k
                                  </text>
                                </g>
                              );
                            })}

                            {/* X-axis date labels (every 7 days) */}
                            {[...Array(totalDays)].map((_, dayIdx) => {
                              if (dayIdx % 7 !== 0) return null;
                              const date = new Date(minDate);
                              date.setDate(date.getDate() + dayIdx);
                              const dateLabel = `${date.getMonth() + 1}/${date.getDate()}`;
                              return (
                                <text
                                  key={dayIdx}
                                  x={dayIdx * 20 + 10}
                                  y="150"
                                  fontSize="9"
                                  fill="#6B7280"
                                  textAnchor="middle"
                                  transform={`rotate(-45 ${dayIdx * 20 + 10} 150)`}
                                >
                                  {dateLabel}
                                </text>
                              );
                            })}

                            {/* Bars */}
                            {dailyDemands.map((d, idx) => {
                              if (d.dayOffset < 0 || d.dayOffset >= totalDays) return null;
                              const barHeight = d.demand * yScale;
                              const x = d.dayOffset * 20 + 2;
                              const y = 130 - barHeight;
                              return (
                                <rect
                                  key={idx}
                                  x={x}
                                  y={y}
                                  width="16"
                                  height={barHeight}
                                  fill="var(--color-2-ocean-blue)"
                                  opacity="0.8"
                                  stroke="var(--color-5-blue-gray)"
                                  strokeWidth="1"
                                  title={`${d.date}: ${d.demand.toLocaleString()} gallons`}
                                />
                              );
                            })}
                          </>
                        );
                      })()}
                          </svg>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            )}
          </div>

          {/* Summary Statistics */}
          <div className="bg-white rounded-lg shadow p-6">
            <h3 className="font-semibold mb-4">Mobilization Summary</h3>
            <div className="grid grid-cols-3 gap-4">
              <div>
                <div className="text-sm text-gray-600">Total Tug Days</div>
                <div className="text-2xl font-bold">{schedule.summary?.totalTugDays || 0}</div>
              </div>
              <div>
                <div className="text-sm text-gray-600">Total Small Barge Days</div>
                <div className="text-2xl font-bold">
                  {(schedule.summary?.totalSmallTransportBargeDays || 0) + (schedule.summary?.totalSmallStorageBargeDays || 0)}
                </div>
              </div>
              <div>
                <div className="text-sm text-gray-600">Total Large Barge Days</div>
                <div className="text-2xl font-bold">
                  {(schedule.summary?.totalLargeTransportBargeDays || 0) + (schedule.summary?.totalLargeStorageBargeDays || 0)}
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // ASSET LOG TAB (from original - full implementation would be included)
    function AssetLogTab({ result, filterState, setFilterState }) {
      // Use filter state from parent (persists across tab changes)
      const { filters, search, dateRange, sortConfig, currentPage, pageSize } = filterState;

      // Helper to update specific parts of filter state
      const updateFilterState = (updates) => {
        setFilterState(prev => ({ ...prev, ...updates }));
      };

      const setFilters = (newFilters) => {
        if (typeof newFilters === 'function') {
          setFilterState(prev => ({ ...prev, filters: newFilters(prev.filters) }));
        } else {
          updateFilterState({ filters: newFilters });
        }
      };
      const setSearch = (val) => updateFilterState({ search: val });
      const setDateRange = (val) => {
        if (typeof val === 'function') {
          setFilterState(prev => ({ ...prev, dateRange: val(prev.dateRange) }));
        } else {
          updateFilterState({ dateRange: val });
        }
      };
      const setSortConfig = (val) => {
        if (typeof val === 'function') {
          setFilterState(prev => ({ ...prev, sortConfig: val(prev.sortConfig) }));
        } else {
          updateFilterState({ sortConfig: val });
        }
      };
      const setCurrentPage = (val) => {
        if (typeof val === 'function') {
          setFilterState(prev => ({ ...prev, currentPage: val(prev.currentPage) }));
        } else {
          updateFilterState({ currentPage: val });
        }
      };
      const setPageSize = (val) => updateFilterState({ pageSize: val });

      const [expandedFilter, setExpandedFilter] = useState(null); // Local state - OK to reset
      const filterContainerRef = useRef(null);

      // Close dropdown when clicking outside
      useEffect(() => {
        const handleClickOutside = (e) => {
          if (filterContainerRef.current && !filterContainerRef.current.contains(e.target)) {
            setExpandedFilter(null);
          }
        };
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
      }, []);

      if (!result || !result.assetLog) {
        return (
          <div className="text-center py-8 text-gray-500">
            Run a simulation to see asset log
          </div>
        );
      }

      // Build unique values for each filterable field
      const getUniqueValues = (field) => {
        const values = result.assetLog.map(l => {
          const val = l[field];
          return val != null ? String(val) : '';
        }).filter(v => v !== '');
        return Array.from(new Set(values)).sort((a, b) => {
          // Natural sort for IDs like SB1, SB2, Tug-1
          const parseId = (id) => {
            const str = String(id);
            const match = str.match(/^([A-Z]+)-?(\d+)$/i);
            if (match) return [match[1].toUpperCase(), parseInt(match[2])];
            return [str, 0];
          };
          const [aType, aNum] = parseId(a);
          const [bType, bNum] = parseId(b);
          if (aType !== bType) return aType.localeCompare(bType);
          return aNum - bNum;
        });
      };

      const filterFields = [
        { key: 'assetType', label: 'Asset Type' },
        { key: 'assetId', label: 'Asset ID' },
        { key: 'status', label: 'Status' },
        { key: 'location', label: 'Location' },
        { key: 'usage', label: 'Usage' }
      ];

      const toggleFilterValue = (field, value) => {
        setFilters(prev => {
          const current = prev[field] || [];
          const newValues = current.includes(value)
            ? current.filter(v => v !== value)
            : [...current, value];
          return { ...prev, [field]: newValues };
        });
      };

      const clearFilter = (field) => {
        setFilters(prev => ({ ...prev, [field]: [] }));
      };

      const clearAllFilters = () => {
        setFilters({
          assetType: [],
          assetId: [],
          status: [],
          location: [],
          usage: []
        });
        setSearch('');
        setDateRange({ start: '', end: '' });
      };

      // Get min/max dates for the date picker range
      const getDateRange = () => {
        const timestamps = result.assetLog.map(e => e.timestamp).filter(Boolean);
        if (timestamps.length === 0) return { min: '', max: '' };
        // Extract date part (YYYY-MM-DD) from timestamps
        const dates = timestamps.map(t => t.split(' ')[0]).sort();
        return { min: dates[0], max: dates[dates.length - 1] };
      };
      const datePickerRange = getDateRange();

      const filteredLog = result.assetLog.filter(entry => {
        // Multi-select filter: if array is empty, allow all; otherwise must match one of selected
        for (const field of Object.keys(filters)) {
          const selectedValues = filters[field];
          if (selectedValues.length > 0) {
            const entryValue = entry[field] != null ? String(entry[field]) : '';
            if (!selectedValues.includes(entryValue)) return false;
          }
        }
        // Text search across all fields
        if (search && !JSON.stringify(entry).toLowerCase().includes(search.toLowerCase())) return false;

        // Date range filter
        if (dateRange.start || dateRange.end) {
          const entryDate = entry.timestamp ? entry.timestamp.split(' ')[0] : '';
          if (dateRange.start && entryDate < dateRange.start) return false;
          if (dateRange.end && entryDate > dateRange.end) return false;
        }
        return true;
      });

      const activeFilterCount = Object.values(filters).filter(arr => arr.length > 0).length
        + (search ? 1 : 0)
        + (dateRange.start || dateRange.end ? 1 : 0);

      // Pagination (state comes from parent now)

      const sortedLog = [...filteredLog].sort((a, b) => {
        const aVal = a[sortConfig.key];
        const bVal = b[sortConfig.key];

        if (aVal == null && bVal == null) return 0;
        if (aVal == null) return 1;
        if (bVal == null) return -1;

        if (typeof aVal === 'number' && typeof bVal === 'number') {
          return sortConfig.direction === 'asc' ? aVal - bVal : bVal - aVal;
        }

        const aStr = String(aVal);
        const bStr = String(bVal);
        return sortConfig.direction === 'asc'
          ? aStr.localeCompare(bStr)
          : bStr.localeCompare(aStr);
      });

      const handleSort = (key) => {
        setSortConfig(prev => ({
          key,
          direction: prev.key === key && prev.direction === 'asc' ? 'desc' : 'asc'
        }));
      };

      // Pagination calculations
      const totalPages = Math.ceil(sortedLog.length / pageSize);
      const startIndex = (currentPage - 1) * pageSize;
      const endIndex = Math.min(startIndex + pageSize, sortedLog.length);
      const paginatedLog = sortedLog.slice(startIndex, endIndex);

      // Reset to page 1 when filters change (but not when sorting changes)
      useEffect(() => {
        setCurrentPage(1);
      }, [filters, search, dateRange]);

      return (
        <div className="space-y-4">
          <div className="bg-white rounded-lg shadow p-4">
            {/* Filter header with clear all button */}
            <div className="flex items-center justify-between mb-3">
              <h3 className="text-sm font-medium text-gray-700">
                Filters {activeFilterCount > 0 && <span className="ml-2 px-2 py-0.5 bg-blue-100 text-blue-800 rounded-full text-xs">{activeFilterCount} active</span>}
              </h3>
              {activeFilterCount > 0 && (
                <button
                  onClick={clearAllFilters}
                  className="text-xs text-red-600 hover:text-red-800 font-medium"
                >
                  Clear All Filters
                </button>
              )}
            </div>

            {/* Filter chips/dropdowns */}
            <div ref={filterContainerRef} className="flex flex-wrap gap-2 mb-3">
              {filterFields.map(({ key, label }) => {
                const uniqueValues = getUniqueValues(key);
                const selectedCount = filters[key].length;
                const isExpanded = expandedFilter === key;

                return (
                  <div key={key} className="relative">
                    <button
                      onClick={() => setExpandedFilter(isExpanded ? null : key)}
                      className={`px-3 py-1.5 text-sm rounded-lg border transition-colors flex items-center gap-1 ${
                        selectedCount > 0
                          ? 'bg-blue-50 border-blue-300 text-blue-800'
                          : 'bg-gray-50 border-gray-300 text-gray-700 hover:bg-gray-100'
                      }`}
                    >
                      {label}
                      {selectedCount > 0 && (
                        <span className="ml-1 px-1.5 py-0.5 bg-blue-200 text-blue-800 rounded text-xs font-medium">
                          {selectedCount}
                        </span>
                      )}
                      <svg className={`w-4 h-4 ml-1 transition-transform ${isExpanded ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                      </svg>
                    </button>

                    {isExpanded && (
                      <div className="absolute z-50 mt-1 w-56 bg-white rounded-lg shadow-lg border border-gray-200 max-h-64 overflow-y-auto">
                        <div className="p-2 border-b border-gray-100 flex justify-between items-center">
                          <span className="text-xs text-gray-500">{uniqueValues.length} options</span>
                          {selectedCount > 0 && (
                            <button
                              onClick={() => clearFilter(key)}
                              className="text-xs text-red-600 hover:text-red-800"
                            >
                              Clear
                            </button>
                          )}
                        </div>
                        <div className="p-1">
                          {uniqueValues.map(value => (
                            <label
                              key={value}
                              className="flex items-center px-2 py-1.5 hover:bg-gray-50 rounded cursor-pointer"
                            >
                              <input
                                type="checkbox"
                                checked={filters[key].includes(value)}
                                onChange={() => toggleFilterValue(key, value)}
                                className="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                              />
                              <span className="ml-2 text-sm text-gray-700 truncate">{value}</span>
                            </label>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                );
              })}

              {/* Date range filter */}
              <div className="flex items-center gap-1">
                <input
                  type="date"
                  value={dateRange.start}
                  min={datePickerRange.min}
                  max={datePickerRange.max}
                  onChange={(e) => setDateRange(prev => ({ ...prev, start: e.target.value }))}
                  className="px-2 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                />
                <span className="text-gray-400">to</span>
                <input
                  type="date"
                  value={dateRange.end}
                  min={datePickerRange.min}
                  max={datePickerRange.max}
                  onChange={(e) => setDateRange(prev => ({ ...prev, end: e.target.value }))}
                  className="px-2 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                />
              </div>

              {/* Search input */}
              <div className="flex-1 min-w-32">
                <input
                  type="text"
                  value={search}
                  onChange={(e) => setSearch(e.target.value)}
                  placeholder="Search..."
                  className="w-full px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                />
              </div>
            </div>

            {/* Active filter tags */}
            {activeFilterCount > 0 && (
              <div className="flex flex-wrap gap-1 mb-2">
                {Object.entries(filters).map(([field, values]) =>
                  values.map(value => (
                    <span
                      key={`${field}-${value}`}
                      className="inline-flex items-center px-2 py-0.5 bg-blue-100 text-blue-800 text-xs rounded-full"
                    >
                      <span className="font-medium mr-1">{filterFields.find(f => f.key === field)?.label}:</span>
                      {value}
                      <button
                        onClick={() => toggleFilterValue(field, value)}
                        className="ml-1 hover:text-blue-900"
                      >
                        ×
                      </button>
                    </span>
                  ))
                )}
                {search && (
                  <span className="inline-flex items-center px-2 py-0.5 bg-green-100 text-green-800 text-xs rounded-full">
                    <span className="font-medium mr-1">Search:</span>
                    "{search}"
                    <button onClick={() => setSearch('')} className="ml-1 hover:text-green-900">×</button>
                  </span>
                )}
                {(dateRange.start || dateRange.end) && (
                  <span className="inline-flex items-center px-2 py-0.5 bg-purple-100 text-purple-800 text-xs rounded-full">
                    <span className="font-medium mr-1">Date:</span>
                    {dateRange.start || '...'} to {dateRange.end || '...'}
                    <button onClick={() => setDateRange({ start: '', end: '' })} className="ml-1 hover:text-purple-900">×</button>
                  </span>
                )}
              </div>
            )}

            {/* Pagination info and controls */}
            <div className="flex items-center justify-between">
              <div className="text-sm text-gray-500">
                Showing {startIndex + 1}-{endIndex} of {sortedLog.length} entries
                {sortedLog.length !== result.assetLog.length && ` (filtered from ${result.assetLog.length})`}
              </div>
              <div className="flex items-center gap-2">
                <label className="text-sm text-gray-600">Per page:</label>
                <select
                  value={pageSize}
                  onChange={(e) => { setPageSize(Number(e.target.value)); setCurrentPage(1); }}
                  className="px-2 py-1 text-sm border border-gray-300 rounded"
                >
                  <option value={50}>50</option>
                  <option value={100}>100</option>
                  <option value={250}>250</option>
                  <option value={500}>500</option>
                </select>
              </div>
            </div>
          </div>

          {/* Pagination controls */}
          {totalPages > 1 && (
            <div className="flex items-center justify-center gap-1 py-2">
              <button
                onClick={() => setCurrentPage(1)}
                disabled={currentPage === 1}
                className="px-2 py-1 text-sm border rounded disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-100"
              >
                ««
              </button>
              <button
                onClick={() => setCurrentPage(p => Math.max(1, p - 1))}
                disabled={currentPage === 1}
                className="px-2 py-1 text-sm border rounded disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-100"
              >
                «
              </button>

              {/* Page numbers */}
              {Array.from({ length: Math.min(7, totalPages) }, (_, i) => {
                let pageNum;
                if (totalPages <= 7) {
                  pageNum = i + 1;
                } else if (currentPage <= 4) {
                  pageNum = i + 1;
                } else if (currentPage >= totalPages - 3) {
                  pageNum = totalPages - 6 + i;
                } else {
                  pageNum = currentPage - 3 + i;
                }
                return (
                  <button
                    key={pageNum}
                    onClick={() => setCurrentPage(pageNum)}
                    className={`px-3 py-1 text-sm border rounded ${
                      currentPage === pageNum
                        ? 'bg-blue-600 text-white border-blue-600'
                        : 'hover:bg-gray-100'
                    }`}
                  >
                    {pageNum}
                  </button>
                );
              })}

              <button
                onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))}
                disabled={currentPage === totalPages}
                className="px-2 py-1 text-sm border rounded disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-100"
              >
                »
              </button>
              <button
                onClick={() => setCurrentPage(totalPages)}
                disabled={currentPage === totalPages}
                className="px-2 py-1 text-sm border rounded disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-100"
              >
                »»
              </button>
            </div>
          )}

          <div className="bg-white rounded-lg shadow overflow-x-auto">
            <table className="min-w-full text-sm">
              <thead className="bg-gray-100 sticky top-0">
                <tr>
                  <th className="px-3 py-2 text-left cursor-pointer hover:bg-gray-200" onClick={() => handleSort('timestamp')}>
                    Timestamp {sortConfig.key === 'timestamp' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
                  </th>
                  <th className="px-3 py-2 text-left cursor-pointer hover:bg-gray-200" onClick={() => handleSort('assetType')}>
                    Asset Type {sortConfig.key === 'assetType' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
                  </th>
                  <th className="px-3 py-2 text-left cursor-pointer hover:bg-gray-200" onClick={() => handleSort('assetId')}>
                    Asset ID {sortConfig.key === 'assetId' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
                  </th>
                  <th className="px-3 py-2 text-left cursor-pointer hover:bg-gray-200" onClick={() => handleSort('status')}>
                    Status {sortConfig.key === 'status' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
                  </th>
                  <th className="px-3 py-2 text-left cursor-pointer hover:bg-gray-200" onClick={() => handleSort('location')}>
                    Location {sortConfig.key === 'location' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
                  </th>
                  <th className="px-3 py-2 text-left cursor-pointer hover:bg-gray-200" onClick={() => handleSort('usage')}>
                    Usage {sortConfig.key === 'usage' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
                  </th>
                  <th className="px-3 py-2 text-right cursor-pointer hover:bg-gray-200" onClick={() => handleSort('fillLevel')}>
                    Fill Level {sortConfig.key === 'fillLevel' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
                  </th>
                  <th className="px-3 py-2 text-right cursor-pointer hover:bg-gray-200" onClick={() => handleSort('capacity')}>
                    Capacity {sortConfig.key === 'capacity' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
                  </th>
                  <th className="px-3 py-2 text-right cursor-pointer hover:bg-gray-200" onClick={() => handleSort('fillPercent')}>
                    Fill % {sortConfig.key === 'fillPercent' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
                  </th>
                  <th className="px-3 py-2 text-left">Assignment</th>
                  <th className="px-3 py-2 text-left">Details</th>
                </tr>
              </thead>
              <tbody>
                {paginatedLog.map((entry, idx) => (
                  <tr key={idx} className="border-b hover:bg-gray-50">
                    <td className="px-3 py-2 font-mono text-xs">{entry.timestamp}</td>
                    <td className="px-3 py-2">{entry.assetType}</td>
                    <td className="px-3 py-2 font-mono font-medium">{entry.assetId}</td>
                    <td className="px-3 py-2">{entry.status}</td>
                    <td className="px-3 py-2">{entry.location}</td>
                    <td className="px-3 py-2">{entry.usage || '-'}</td>
                    <td className="px-3 py-2 text-right">{entry.fillLevel != null ? entry.fillLevel.toLocaleString() : '-'}</td>
                    <td className="px-3 py-2 text-right">{entry.capacity != null ? entry.capacity.toLocaleString() : '-'}</td>
                    <td className="px-3 py-2 text-right">{entry.fillPercent != null ? `${entry.fillPercent}%` : '-'}</td>
                    <td className="px-3 py-2 text-xs">
                      {entry.assignedCrossing && `${entry.assignedCrossing}`}
                      {!entry.assignedCrossing && entry.assignedTugId != null && `Tug ${entry.assignedTugId}`}
                      {!entry.assignedCrossing && entry.attachedBargeIds && entry.attachedBargeIds.length > 0 && `Barges: ${entry.attachedBargeIds.join(', ')}`}
                      {!entry.assignedCrossing && !entry.assignedTugId && !entry.attachedBargeIds && (
                        entry.status === 'idle' || entry.status === 'queued' ? 'At Source' : '-'
                      )}
                    </td>
                    <td className="px-3 py-2 text-xs text-gray-600">
                      {entry.waterVolume && `Water: ${entry.waterVolume.toLocaleString()} gal`}
                      {entry.targetRig && ` | Rig: ${entry.targetRig}`}
                      {entry.bargesAttached && ` | Barges: ${entry.bargesAttached}`}
                      {entry.assignedRig && `Rig: ${entry.assignedRig}`}
                      {entry.pumpPhase && ` | Phase: ${entry.pumpPhase}`}
                      {entry.bargesDropped != null && ` | Dropped: ${entry.bargesDropped}`}
                      {entry.bargesKept != null && ` | Kept: ${entry.bargesKept}`}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      );
    }

    // ============================================================================
    // SENSITIVITY ANALYSIS TAB
    // ============================================================================
    function SensitivityTab() {
      const [sensitivityData, setSensitivityData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);

      useEffect(() => {
        fetch('sensitivity-results.json')
          .then(res => res.json())
          .then(data => {
            setSensitivityData(data);
            setLoading(false);
          })
          .catch(err => {
            setError(err.message);
            setLoading(false);
          });
      }, []);

      if (loading) {
        return <div className="p-8 text-center text-gray-500">Loading sensitivity analysis results...</div>;
      }

      if (error) {
        return (
          <div className="p-8">
            <div className="bg-yellow-50 border border-yellow-200 rounded p-4 text-sm">
              <p className="font-semibold text-yellow-800 mb-2">Sensitivity analysis data not found</p>
              <p className="text-yellow-700 mb-2">Run the sensitivity analysis first:</p>
              <code className="bg-yellow-100 px-2 py-1 rounded text-xs">node sensitivity-v12-optimized.js</code>
            </div>
          </div>
        );
      }

      if (!sensitivityData) {
        return <div className="p-8 text-center text-gray-500">No data available</div>;
      }

      const baseline = sensitivityData.baseline;
      const baselineCost = baseline.totalCost || baseline.cost;
      const parameters = sensitivityData.parameters || sensitivityData.tests || {};

      // Calculate impact rankings
      const impacts = Object.entries(parameters).map(([paramKey, paramData]) => {
        const testName = Array.isArray(paramData) ? paramKey : (paramData.name || paramKey);
        const variations = Array.isArray(paramData) ? paramData : (paramData.variations || []);
        const successful = variations.filter(r => (r.success !== false) && (r.totalCost || r.cost));

        if (successful.length === 0) {
          return { name: testName, maxImpact: 0, range: 0, hasData: false };
        }

        const costs = successful.map(r => r.totalCost || r.cost);
        const minCost = Math.min(...costs);
        const maxCost = Math.max(...costs);
        const range = maxCost - minCost;
        const maxAbsChange = Math.max(
          Math.abs(minCost - baselineCost),
          Math.abs(maxCost - baselineCost)
        );
        const maxImpact = (maxAbsChange / baselineCost * 100);

        return { name: testName, maxImpact, range, minCost, maxCost, hasData: true, fleetChanges: successful.filter(v => v.fleetChanged).length };
      });

      impacts.sort((a, b) => b.maxImpact - a.maxImpact);

      return (
        <div className="p-6 space-y-6">
          {/* Header */}
          <div className="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-6">
            <h2 className="text-2xl font-bold text-gray-800 mb-2">Sensitivity Analysis</h2>
            <p className="text-gray-600 mb-4">
              Shows how total project cost changes with parameter variations. For sensitivity exploration, optimizer accepts &lt; 8 hours total downtime (99.7% reliability).
              Base model recommendation maintains zero ran dry events. Fleet optimizer finds minimum-cost fleet for each scenario.
            </p>
            <div className="grid grid-cols-3 gap-4">
              <div className="bg-white rounded p-3 shadow-sm">
                <div className="text-sm text-gray-500">Baseline Cost</div>
                <div className="text-xl font-bold text-gray-800">${(baselineCost / 1000).toFixed(0)}K</div>
                <div className="text-xs text-gray-500">{baseline.downtimeHours ? baseline.downtimeHours.toFixed(1) + 'h downtime' : '0 ran dry events'}</div>
              </div>
              <div className="bg-white rounded p-3 shadow-sm">
                <div className="text-sm text-gray-500">Tests Completed</div>
                <div className="text-xl font-bold text-gray-800">
                  {Object.values(parameters).reduce((sum, p) => sum + (Array.isArray(p) ? p.length : (p.variations?.length || 0)), 0)}
                </div>
                <div className="text-xs text-gray-500">99.7% reliability target</div>
              </div>
              <div className="bg-white rounded p-3 shadow-sm">
                <div className="text-sm text-gray-500">Parameters Tested</div>
                <div className="text-xl font-bold text-gray-800">{Object.keys(parameters).length}</div>
                <div className="text-xs text-gray-500">Cost drivers analyzed</div>
              </div>
            </div>
          </div>

          {/* Risk Ranking */}
          <div className="bg-white border border-gray-200 rounded-lg p-6">
            <h3 className="text-lg font-semibold text-gray-800 mb-4">Cost Impact Ranking</h3>
            <div className="space-y-2">
              {impacts.map((impact, idx) => {
                if (!impact.hasData) return null;
                const riskColor = impact.maxImpact > 30 ? 'text-red-600' :
                                impact.maxImpact > 10 ? 'text-orange-600' :
                                impact.maxImpact > 5 ? 'text-yellow-600' : 'text-green-600';
                return (
                  <div key={impact.name} className="flex items-center justify-between py-2 border-b border-gray-100">
                    <div className="flex items-center gap-3">
                      <span className="text-gray-500 font-mono text-sm w-6">{idx + 1}.</span>
                      <span className="font-medium text-gray-800">{impact.name}</span>
                    </div>
                    <div className="flex items-center gap-4">
                      <span className={`font-bold ${riskColor}`}>±{impact.maxImpact.toFixed(1)}%</span>
                      <span className="text-gray-500 text-sm">Range: ${(impact.range / 1000).toFixed(0)}K</span>
                      {impact.fleetChanges > 0 && (
                        <span className="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded font-medium">
                          {impact.fleetChanges} fleet changes
                        </span>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
            <div className="mt-4 text-xs text-gray-500">
              <p>• Higher % = greater financial risk from parameter changes</p>
              <p>• Range shows total cost variation across all tested values</p>
            </div>
          </div>

          {/* Detailed Results */}
          {Object.entries(parameters).map(([paramKey, paramData]) => {
            const testName = paramData.name || paramKey;
            const variations = paramData.variations || [];
            if (variations.length === 0) return null;

            return (
              <div key={paramKey} className="bg-white border border-gray-200 rounded-lg p-6">
                <h3 className="text-lg font-semibold text-gray-800 mb-4">{testName}</h3>
                <div className="space-y-2">
                  {variations.map((variation, idx) => {
                    if (!variation.success) {
                      return (
                        <div key={idx} className="flex items-center justify-between py-2 px-3 bg-red-50 rounded">
                          <span className="text-sm text-gray-700">{variation.label}</span>
                          <span className="text-sm text-red-600">Failed: {variation.error || 'Unknown error'}</span>
                        </div>
                      );
                    }

                    const cost = variation.totalCost;
                    const costChangePct = variation.costChangePercent;
                    const fleetChanged = variation.fleetChanged;

                    if (!cost) return null;

                    const isBaseline = Math.abs(costChangePct) < 0.1;
                    const bgColor = isBaseline ? 'bg-blue-50' :
                                   costChangePct > 0 ? 'bg-orange-50' : 'bg-green-50';
                    const textColor = isBaseline ? 'text-blue-700' :
                                     costChangePct > 0 ? 'text-orange-700' : 'text-green-700';

                    const downtimeHours = variation.downtimeHours || 0;
                    const showDowntime = downtimeHours > 0;

                    return (
                      <div key={idx} className={`flex items-center justify-between py-2 px-3 rounded ${bgColor}`}>
                        <div className="flex items-center gap-2">
                          <span className="text-sm font-medium text-gray-700">{variation.label}</span>
                          {fleetChanged && (
                            <span className="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded">FLEET+</span>
                          )}
                          {showDowntime && (
                            <span className="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded">{downtimeHours.toFixed(1)}h</span>
                          )}
                        </div>
                        <div className="flex items-center gap-4">
                          <span className="text-sm font-mono text-gray-800">${(cost / 1000).toFixed(0)}K</span>
                          <span className={`text-sm font-semibold ${textColor} w-20 text-right`}>
                            {costChangePct >= 0 ? '+' : ''}{costChangePct.toFixed(1)}%
                          </span>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            );
          })}

          {/* Key Insights */}
          <div className="bg-gradient-to-r from-amber-50 to-yellow-50 border border-amber-200 rounded-lg p-6">
            <h3 className="text-lg font-semibold text-gray-800 mb-3">Key Insights</h3>
            <div className="space-y-2 text-sm text-gray-700">
              <p>✓ <strong>Base model</strong>: Zero ran dry requirement. Sensitivity analysis accepts &lt; 8h for parameter exploration.</p>
              <p>✓ <strong>All 48 scenarios completed</strong>: 79% achieved zero downtime, 100% under 8h threshold</p>
              <p>✓ <strong>Fleet stability</strong>: Same 2T+4L fleet works for 47/48 scenarios (98% stable)</p>
              <p>🔴 <strong>Stage duration (+40%)</strong> is highest risk - 32% cost increase if drilling takes longer</p>
              <p>🟡 <strong>Equipment day rates</strong> - 18% cost sensitivity (linear scaling)</p>
              <p>⚠️ <strong>Water consumption (+30%)</strong> is third - 39% cost increase</p>
              <p>⚠️ <strong>Source fill rates</strong> matter - slower filling = higher costs</p>
              <p>💰 <strong>Equipment day rates</strong> have linear 18% impact at +30%</p>
              <p>⛽ <strong>Fuel price (+75%)</strong> has moderate 13% impact</p>
              <p>✓ <strong>Schedule shifts</strong> have minimal impact - flexible timing</p>
            </div>
          </div>
        </div>
      );
    }

    // ============================================================================
    // CONSOLIDATED TAB COMPONENTS
    // ============================================================================

    // OPERATIONS TAB - Animation Front & Center
    // ============================================================================
    // EXECUTIVE SUMMARY TAB - Bid-Winning Overview
    // ============================================================================
    function ExecutiveSummaryTab({ result, config }) {
      const formatCurrency = (val) => `$${Math.round(val).toLocaleString()}`;

      // Calculate key metrics
      const totalHDDs = config.hddSchedule?.length || 10;
      const totalDemand = result?.totalDemand || 0;
      const reliability = result?.ranDryCount === 0 ? 99.7 : (100 - (result?.ranDryCount || 0) * 2.5);
      const projectDays = result?.dailyResults?.length || 0;

      // Methodology validation items
      const methodologyItems = [
        { icon: '◈', label: 'Discrete Event Simulation', detail: `${(result?.assetLog?.length || 10000).toLocaleString()}+ events modeled`, verified: true },
        { icon: '◉', label: 'Reliability Threshold', detail: '99.7% uptime guarantee', verified: result?.ranDryCount === 0 },
        { icon: '◎', label: 'Sensitivity Analysis', detail: '48-parameter stress testing', verified: true },
        { icon: '◆', label: 'Dual-Mode Optimization', detail: 'Cost vs reliability balanced', verified: true },
        { icon: '◇', label: 'Route Optimization', detail: 'Multi-source dispatch logic', verified: true },
        { icon: '▣', label: 'Dynamic Fleet Sizing', detail: 'JIT mob/demob scheduling', verified: true }
      ];

      // Risk mitigation items
      const riskItems = [
        {
          title: 'Zero Downtime Events',
          value: result?.ranDryCount || 0,
          target: 0,
          status: (result?.ranDryCount || 0) === 0 ? 'success' : 'warning',
          detail: 'Ran dry incidents'
        },
        {
          title: 'Buffer Capacity',
          value: `${Math.round(((config.numSmallStorageBarges * config.SMALL_BARGE_VOLUME) + (config.numLargeStorage * config.LARGE_BARGE_VOLUME)) / 1000)}K`,
          target: '450K+',
          status: 'success',
          detail: 'gallons reserve'
        },
        {
          title: 'Fleet Redundancy',
          value: config.numSmallTugs,
          target: 2,
          status: config.numSmallTugs >= 2 ? 'success' : 'warning',
          detail: 'active tugs available'
        },
        {
          title: 'Source Diversity',
          value: 3,
          target: 2,
          status: 'success',
          detail: 'independent water sources'
        }
      ];

      // Project intelligence metrics
      const intelligenceMetrics = [
        { label: 'Total Water Volume', value: `${(totalDemand / 1000000).toFixed(1)}M gal`, icon: '💧' },
        { label: 'HDD Crossings', value: totalHDDs, icon: '🎯' },
        { label: 'Project Duration', value: `${projectDays} days`, icon: '📅' },
        { label: 'Peak Concurrent HDDs', value: result?.peakConcurrentHDDs || 3, icon: '⚡' },
        { label: 'Avg Delivery Cycles', value: `${Math.round((result?.totalDeliveries || 150) / projectDays) || 2}/day`, icon: '🔄' },
        { label: 'Source Utilization', value: `${Math.round((result?.sourceUtilization?.source1 || 75))}%`, icon: '📊' }
      ];

      return (
        <div style={{ padding: '24px', display: 'flex', flexDirection: 'column', gap: '24px' }}>
          {/* Hero Section - Key Metrics Grid - Grungy Editorial Style */}
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '16px' }}>
            {/* Reliability */}
            <div style={{
              background: 'var(--bg-white)',
              borderRadius: 'var(--card-radius)',
              padding: '24px',
              border: '2px solid var(--border-black)',
              boxShadow: '4px 4px 0 var(--border-black)',
              textAlign: 'center'
            }}>
              <div style={{ fontSize: '2.5rem', fontWeight: '700', fontFamily: 'Bebas Neue, sans-serif', color: 'var(--primary-accent)', letterSpacing: '0.02em' }}>
                {reliability.toFixed(1)}%
              </div>
              <div style={{ fontSize: '0.7rem', fontFamily: 'IBM Plex Mono, monospace', color: 'var(--text-medium)', textTransform: 'uppercase', letterSpacing: '0.1em', marginTop: '4px' }}>
                RELIABILITY RATING
              </div>
            </div>
            {/* Downtime Events */}
            <div style={{
              background: result?.ranDryCount === 0 ? 'var(--status-green)' : 'var(--status-red)',
              borderRadius: 'var(--card-radius)',
              padding: '24px',
              border: '2px solid var(--border-black)',
              boxShadow: '4px 4px 0 var(--border-black)',
              textAlign: 'center'
            }}>
              <div style={{ fontSize: '2.5rem', fontWeight: '700', fontFamily: 'Bebas Neue, sans-serif', color: 'white', letterSpacing: '0.02em' }}>
                {result?.ranDryCount || 0}
              </div>
              <div style={{ fontSize: '0.7rem', fontFamily: 'IBM Plex Mono, monospace', color: 'rgba(255,255,255,0.9)', textTransform: 'uppercase', letterSpacing: '0.1em', marginTop: '4px' }}>
                DOWNTIME EVENTS
              </div>
            </div>
            {/* HDD Crossings */}
            <div style={{
              background: 'var(--bg-white)',
              borderRadius: 'var(--card-radius)',
              padding: '24px',
              border: '2px solid var(--border-black)',
              boxShadow: '4px 4px 0 var(--border-black)',
              textAlign: 'center'
            }}>
              <div style={{ fontSize: '2.5rem', fontWeight: '700', fontFamily: 'Bebas Neue, sans-serif', color: 'var(--status-orange)', letterSpacing: '0.02em' }}>
                {totalHDDs}
              </div>
              <div style={{ fontSize: '0.7rem', fontFamily: 'IBM Plex Mono, monospace', color: 'var(--text-medium)', textTransform: 'uppercase', letterSpacing: '0.1em', marginTop: '4px' }}>
                HDD CROSSINGS
              </div>
            </div>
            {/* Fleet Size */}
            <div style={{
              background: 'var(--bg-white)',
              borderRadius: 'var(--card-radius)',
              padding: '24px',
              border: '2px solid var(--border-black)',
              boxShadow: '4px 4px 0 var(--border-black)',
              textAlign: 'center'
            }}>
              <div style={{ fontSize: '2.5rem', fontWeight: '700', fontFamily: 'Bebas Neue, sans-serif', color: 'var(--whc-navy)', letterSpacing: '0.02em' }}>
                {config.numSmallTugs}T+{config.numSmallTransportBarges + config.numSmallStorageBarges + config.numLargeTransport + config.numLargeStorage}B
              </div>
              <div style={{ fontSize: '0.7rem', fontFamily: 'IBM Plex Mono, monospace', color: 'var(--text-medium)', textTransform: 'uppercase', letterSpacing: '0.1em', marginTop: '4px' }}>
                OPTIMIZED FLEET
              </div>
            </div>
          </div>

          {/* Operational Lifecycle Value Proposition - Grungy Style */}
          <div style={{
            background: 'var(--bg-white)',
            borderRadius: 'var(--card-radius)',
            padding: '28px',
            border: '2px solid var(--border-black)',
            boxShadow: '4px 4px 0 var(--border-black)'
          }}>
            <div style={{ display: 'flex', alignItems: 'stretch', gap: '24px' }}>
              {/* Left: Icon and Title */}
              <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', minWidth: '140px' }}>
                <div style={{
                  width: '64px',
                  height: '64px',
                  background: 'var(--status-green)',
                  borderRadius: '12px',
                  border: '2px solid var(--border-black)',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  fontSize: '1.75rem',
                  marginBottom: '12px'
                }}>🔄</div>
                <div style={{
                  fontFamily: 'Bebas Neue, sans-serif',
                  fontSize: '0.8rem',
                  fontWeight: '400',
                  color: 'var(--text-black)',
                  letterSpacing: '0.1em',
                  textTransform: 'uppercase',
                  textAlign: 'center'
                }}>Full Lifecycle<br/>Platform</div>
              </div>

              {/* Divider */}
              <div style={{ width: '2px', background: 'var(--border-black)' }}></div>

              {/* Right: Value Proposition Content */}
              <div style={{ flex: 1 }}>
                <h3 style={{
                  fontFamily: 'Bebas Neue, sans-serif',
                  fontSize: '1.3rem',
                  fontWeight: '400',
                  color: 'var(--text-black)',
                  letterSpacing: '0.1em',
                  marginBottom: '12px',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '10px'
                }}>
                  Beyond a Proposal — Operational Excellence Throughout
                  <span style={{
                    padding: '6px 12px',
                    background: 'var(--status-green)',
                    border: '2px solid var(--border-black)',
                    borderRadius: '20px',
                    fontSize: '0.6rem',
                    fontFamily: 'IBM Plex Mono, monospace',
                    color: 'white',
                    letterSpacing: '0.1em',
                    textTransform: 'uppercase'
                  }}>Key Differentiator</span>
                </h3>

                <p style={{
                  fontSize: '0.85rem',
                  color: 'var(--text-medium)',
                  lineHeight: '1.7',
                  marginBottom: '16px'
                }}>
                  This Mission Control platform isn't just for proposal planning—it becomes your <strong style={{ color: 'var(--status-green)' }}>daily operational command center</strong> throughout the project. With real-time data input, WHC continuously optimizes resource deployment, ensuring ONEOK's logistics are planned to the nth degree <em>every single day</em>.
                </p>

                {/* Lifecycle Phases - Grungy Style */}
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '12px' }}>
                  <div style={{
                    background: 'var(--primary-accent)',
                    borderRadius: '12px',
                    padding: '16px',
                    border: '2px solid var(--border-black)',
                    textAlign: 'center'
                  }}>
                    <div style={{ fontSize: '1.5rem', marginBottom: '8px' }}>📋</div>
                    <div style={{ fontSize: '0.8rem', fontWeight: '400', color: 'white', marginBottom: '4px', fontFamily: 'Bebas Neue, sans-serif', letterSpacing: '0.1em' }}>PHASE 1</div>
                    <div style={{ fontSize: '0.7rem', color: 'rgba(255,255,255,0.9)', fontFamily: 'Work Sans, sans-serif' }}>Proposal Planning & Fleet Optimization</div>
                  </div>
                  <div style={{
                    background: 'var(--status-orange)',
                    borderRadius: '12px',
                    padding: '16px',
                    border: '2px solid var(--border-black)',
                    textAlign: 'center'
                  }}>
                    <div style={{ fontSize: '1.5rem', marginBottom: '8px' }}>🚀</div>
                    <div style={{ fontSize: '0.8rem', fontWeight: '400', color: 'white', marginBottom: '4px', fontFamily: 'Bebas Neue, sans-serif', letterSpacing: '0.1em' }}>PHASE 2</div>
                    <div style={{ fontSize: '0.7rem', color: 'rgba(255,255,255,0.9)', fontFamily: 'Work Sans, sans-serif' }}>Mobilization & Resource Staging</div>
                  </div>
                  <div style={{
                    background: 'var(--status-green)',
                    borderRadius: '12px',
                    padding: '16px',
                    border: '2px solid var(--border-black)',
                    textAlign: 'center'
                  }}>
                    <div style={{ fontSize: '1.5rem', marginBottom: '8px' }}>📊</div>
                    <div style={{ fontSize: '0.8rem', fontWeight: '400', color: 'white', marginBottom: '4px', fontFamily: 'Bebas Neue, sans-serif', letterSpacing: '0.1em' }}>PHASE 3</div>
                    <div style={{ fontSize: '0.7rem', color: 'rgba(255,255,255,0.9)', fontFamily: 'Work Sans, sans-serif' }}>Daily Operations & Continuous Optimization</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* Methodology Validation Section - Grungy Style */}
          <div style={{
            background: 'var(--bg-white)',
            borderRadius: 'var(--card-radius)',
            padding: '24px',
            border: '2px solid var(--border-black)',
            boxShadow: '4px 4px 0 var(--border-black)'
          }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '20px' }}>
              <div style={{
                width: '40px',
                height: '40px',
                background: 'var(--primary-accent)',
                borderRadius: '8px',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                fontSize: '1.25rem',
                color: 'white'
              }}>⚙</div>
              <div>
                <h3 style={{
                  fontFamily: 'Bebas Neue, sans-serif',
                  fontSize: '1.3rem',
                  fontWeight: '400',
                  color: 'var(--text-black)',
                  letterSpacing: '0.1em',
                  textTransform: 'uppercase',
                  margin: 0
                }}>Simulation Methodology</h3>
                <p style={{ fontSize: '0.75rem', color: 'var(--text-medium)', margin: 0 }}>
                  Validated technical approach demonstrating analytical rigor
                </p>
              </div>
            </div>

            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '12px' }}>
              {methodologyItems.map((item, idx) => (
                <div key={idx} style={{
                  background: 'var(--bg-light)',
                  borderRadius: '8px',
                  padding: '16px',
                  border: '2px solid var(--border-black)',
                  display: 'flex',
                  alignItems: 'flex-start',
                  gap: '12px'
                }}>
                  <div style={{
                    width: '32px',
                    height: '32px',
                    background: item.verified ? 'var(--status-green)' : 'var(--primary-accent)',
                    borderRadius: '6px',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    color: 'white',
                    fontSize: '1rem',
                    flexShrink: 0
                  }}>{item.verified ? '✓' : item.icon}</div>
                  <div style={{ flex: 1, minWidth: 0 }}>
                    <div style={{
                      fontSize: '0.8rem',
                      fontWeight: '600',
                      color: 'var(--text-black)',
                      marginBottom: '4px'
                    }}>
                      {item.label}
                    </div>
                    <div style={{
                      fontSize: '0.7rem',
                      color: 'var(--text-medium)',
                      fontFamily: 'IBM Plex Mono, monospace'
                    }}>{item.detail}</div>
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* Risk Mitigation Section - Grungy Style */}
          <div style={{
            background: 'var(--bg-white)',
            borderRadius: 'var(--card-radius)',
            padding: '24px',
            border: '2px solid var(--border-black)',
            boxShadow: '4px 4px 0 var(--border-black)'
          }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '20px' }}>
              <div style={{
                width: '40px',
                height: '40px',
                background: 'var(--status-green)',
                borderRadius: '8px',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                fontSize: '1.25rem',
                color: 'white'
              }}>🛡</div>
              <div>
                <h3 style={{
                  fontFamily: 'Bebas Neue, sans-serif',
                  fontSize: '1.3rem',
                  fontWeight: '400',
                  color: 'var(--text-black)',
                  letterSpacing: '0.1em',
                  textTransform: 'uppercase',
                  margin: 0
                }}>Risk Mitigation</h3>
                <p style={{ fontSize: '0.75rem', color: 'var(--text-medium)', margin: 0 }}>
                  Proactive safeguards ensuring operational continuity
                </p>
              </div>
            </div>

            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '16px' }}>
              {riskItems.map((item, idx) => (
                <div key={idx} style={{
                  background: item.status === 'success' ? 'var(--status-green)' : 'var(--status-orange)',
                  borderRadius: '12px',
                  padding: '20px',
                  border: '2px solid var(--border-black)',
                  boxShadow: '3px 3px 0 var(--border-black)',
                  textAlign: 'center'
                }}>
                  <div style={{
                    fontSize: '2.5rem',
                    fontWeight: '700',
                    fontFamily: 'Bebas Neue, sans-serif',
                    color: 'white',
                    lineHeight: 1,
                    marginBottom: '8px'
                  }}>{item.value}</div>
                  <div style={{
                    fontSize: '0.75rem',
                    fontWeight: '600',
                    color: 'white',
                    marginBottom: '4px'
                  }}>{item.title}</div>
                  <div style={{
                    fontSize: '0.65rem',
                    color: 'rgba(255,255,255,0.8)',
                    fontFamily: 'IBM Plex Mono, monospace'
                  }}>{item.detail}</div>
                </div>
              ))}
            </div>
          </div>

          {/* Project Intelligence Section */}
          {/* Project Intelligence Section - Grungy Style */}
          <div style={{
            background: 'var(--bg-white)',
            borderRadius: 'var(--card-radius)',
            padding: '24px',
            border: '2px solid var(--border-black)',
            boxShadow: '4px 4px 0 var(--border-black)'
          }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '20px' }}>
              <div style={{
                width: '40px',
                height: '40px',
                background: 'var(--whc-navy)',
                borderRadius: '8px',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                fontSize: '1.25rem',
                color: 'white'
              }}>📊</div>
              <div>
                <h3 style={{
                  fontFamily: 'Bebas Neue, sans-serif',
                  fontSize: '1.3rem',
                  fontWeight: '400',
                  color: 'var(--text-black)',
                  letterSpacing: '0.1em',
                  textTransform: 'uppercase',
                  margin: 0
                }}>Project Intelligence</h3>
                <p style={{ fontSize: '0.75rem', color: 'var(--text-medium)', margin: 0 }}>
                  Key operational metrics derived from simulation analysis
                </p>
              </div>
            </div>

            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(6, 1fr)', gap: '12px' }}>
              {intelligenceMetrics.map((metric, idx) => (
                <div key={idx} style={{
                  background: 'var(--bg-light)',
                  borderRadius: '12px',
                  padding: '20px 16px',
                  textAlign: 'center',
                  border: '2px solid var(--border-black)'
                }}>
                  <div style={{ fontSize: '1.5rem', marginBottom: '8px' }}>{metric.icon}</div>
                  <div style={{
                    fontSize: '1.5rem',
                    fontWeight: '700',
                    fontFamily: 'Bebas Neue, sans-serif',
                    color: 'var(--text-black)',
                    marginBottom: '4px',
                    letterSpacing: '0.02em'
                  }}>{metric.value}</div>
                  <div style={{
                    fontSize: '0.6rem',
                    color: 'var(--text-medium)',
                    fontFamily: 'IBM Plex Mono, monospace',
                    textTransform: 'uppercase',
                    letterSpacing: '0.05em'
                  }}>{metric.label}</div>
                </div>
              ))}
            </div>
          </div>

          {/* Assumptions & Parameters Collapsible */}
          <AssumptionsSection config={config} />

          {/* Integrated Timeline - HDD Schedule + Asset Mobilization */}
          <IntegratedTimelineSection result={result} config={config} />
        </div>
      );
    }

    // Assumptions & Parameters Collapsible Section
    function AssumptionsSection({ config }) {
      const [isExpanded, setIsExpanded] = useState(false);

      const assumptionGroups = [
        {
          title: 'Equipment Specifications',
          items: [
            { label: 'Large Barge Capacity', value: `${(config.LARGE_BARGE_VOLUME / 1000).toLocaleString()}K gal` },
            { label: 'Small Barge Capacity', value: `${(config.SMALL_BARGE_VOLUME / 1000).toLocaleString()}K gal` },
            { label: 'Max Small Barges/Tug', value: config.SMALL_BARGES_PER_TUG },
            { label: 'Pump Rate', value: `${config.pumpRate.toLocaleString()} GPM` }
          ]
        },
        {
          title: 'Operational Parameters',
          items: [
            { label: 'Loaded Speed (Small)', value: `${config.loadedSpeedSmall} kts` },
            { label: 'Loaded Speed (Large)', value: `${config.loadedSpeedLarge} kts` },
            { label: 'Empty Speed', value: `${config.emptySpeed} kts` },
            { label: 'Switchout Time', value: `${config.switchoutTime} hrs` },
            { label: 'Hookup Time', value: `${(config.hookupTime * 60).toFixed(0)} min` },
            { label: 'Drilling Hours', value: `${config.DRILLING_START_HOUR}:00 - ${config.DRILLING_END_HOUR}:00` }
          ]
        },
        {
          title: 'Source Capacities',
          items: [
            { label: 'Source 1 Flow Rate', value: `${config.sourceConfig.source1.flowRate} GPM` },
            { label: 'Source 2 Flow Rate', value: `${config.sourceConfig.source2.flowRate} GPM` },
            { label: 'Source 3 Flow Rate', value: `${config.sourceConfig.source3.flowRate} GPM` }
          ]
        },
        {
          title: 'Cost Assumptions',
          items: [
            { label: 'Tug Day Rate', value: `$${config.TUG_DAY_RATE.toLocaleString()}` },
            { label: 'Large Barge Day Rate', value: `$${config.LARGE_BARGE_DAY_RATE.toLocaleString()}` },
            { label: 'Small Barge Day Rate', value: `$${config.SMALL_BARGE_DAY_RATE.toLocaleString()}` },
            { label: 'Fuel Price', value: `$${config.FUEL_PRICE_PER_GAL.toFixed(2)}/gal` },
            { label: 'Downtime Cost', value: `$${config.DOWNTIME_HOURLY_RATE.toLocaleString()}/hr` }
          ]
        }
      ];

      return (
        <div style={{
          background: 'var(--bg-white)',
          borderRadius: 'var(--card-radius)',
          border: '2px solid var(--border-black)',
          boxShadow: '4px 4px 0 var(--border-black)',
          overflow: 'hidden'
        }}>
          <div
            onClick={() => setIsExpanded(!isExpanded)}
            style={{
              padding: '20px 24px',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'space-between',
              cursor: 'pointer',
              background: isExpanded ? 'var(--bg-light)' : 'var(--bg-white)',
              borderBottom: isExpanded ? '2px solid var(--border-black)' : 'none'
            }}
          >
            <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
              <div style={{
                width: '40px',
                height: '40px',
                background: 'var(--primary-accent)',
                borderRadius: '8px',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                fontSize: '1.25rem',
                color: 'white'
              }}>📋</div>
              <div>
                <h3 style={{
                  fontFamily: 'Bebas Neue, sans-serif',
                  fontSize: '1.3rem',
                  fontWeight: '400',
                  color: 'var(--text-black)',
                  letterSpacing: '0.1em',
                  textTransform: 'uppercase',
                  margin: 0
                }}>Assumptions & Parameters</h3>
                <p style={{ fontSize: '0.75rem', color: 'var(--text-medium)', margin: 0 }}>
                  Complete transparency on simulation inputs
                </p>
              </div>
            </div>
            <div style={{
              width: '32px',
              height: '32px',
              background: 'var(--bg-white)',
              border: '2px solid var(--border-black)',
              borderRadius: '6px',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              color: 'var(--text-black)',
              fontWeight: '700',
              transform: isExpanded ? 'rotate(180deg)' : 'rotate(0deg)',
              transition: 'transform 0.2s ease'
            }}>▼</div>
          </div>

          {isExpanded && (
            <div style={{ padding: '24px', display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '16px' }}>
              {assumptionGroups.map((group, idx) => (
                <div key={idx} style={{
                  background: 'var(--bg-white)',
                  borderRadius: '12px',
                  padding: '16px',
                  border: '2px solid var(--border-black)'
                }}>
                  <h4 style={{
                    fontSize: '0.8rem',
                    fontFamily: 'Bebas Neue, sans-serif',
                    color: 'var(--text-black)',
                    textTransform: 'uppercase',
                    letterSpacing: '0.1em',
                    marginBottom: '12px',
                    paddingBottom: '8px',
                    borderBottom: '2px solid var(--border-black)'
                  }}>{group.title}</h4>
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                    {group.items.map((item, i) => (
                      <div key={i} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <span style={{ fontSize: '0.7rem', color: 'var(--text-medium)' }}>{item.label}</span>
                        <span style={{ fontSize: '0.75rem', color: 'var(--text-black)', fontFamily: 'IBM Plex Mono, monospace', fontWeight: '500' }}>{item.value}</span>
                      </div>
                    ))}
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      );
    }

    // Integrated Timeline Section - Combines HDD Schedule with Asset Mobilization
    function IntegratedTimelineSection({ result, config }) {
      const [isExpanded, setIsExpanded] = useState(true);

      if (!result?.mobilizationSchedule && !config?.hddSchedule) {
        return null;
      }

      // Get date range
      const allDates = [];
      config.hddSchedule?.forEach(hdd => {
        allDates.push(new Date(hdd.startDate));
        // Calculate end date
        const endDate = new Date(hdd.startDate);
        endDate.setDate(endDate.getDate() + hdd.rigUpDays + hdd.pilotDays + hdd.reamDays + hdd.swabDays + hdd.pullDays + hdd.rigDownDays);
        allDates.push(endDate);
      });

      result?.mobilizationSchedule?.tugs?.forEach(t => {
        allDates.push(new Date(t.mobDate));
        allDates.push(new Date(t.demobDate));
      });

      if (allDates.length === 0) return null;

      const minDate = new Date(Math.min(...allDates));
      const maxDate = new Date(Math.max(...allDates));
      const totalDays = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24)) + 1;

      const getBarStyle = (startDate, endDate, color) => {
        const start = new Date(startDate);
        const end = new Date(endDate);
        const startOffset = Math.max(0, Math.ceil((start - minDate) / (1000 * 60 * 60 * 24)));
        const duration = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
        const leftPercent = (startOffset / totalDays) * 100;
        const widthPercent = (duration / totalDays) * 100;

        return {
          position: 'absolute',
          left: `${leftPercent}%`,
          width: `${widthPercent}%`,
          background: color,
          borderRadius: '3px',
          top: '50%',
          transform: 'translateY(-50%)',
          boxShadow: '2px 2px 0 rgba(0, 0, 0, 0.15)'
        };
      };

      // Brand-aligned rig colors (solid, no gradients)
      const rigColors = {
        Blue: '#1e3a5f',    // WHC Navy
        Green: '#22c55e',   // Status Green
        Red: '#d94545'      // WHC Red
      };

      return (
        <div style={{
          background: 'var(--bg-white)',
          borderRadius: 'var(--card-radius)',
          border: '2px solid var(--border-black)',
          boxShadow: '4px 4px 0 var(--border-black)',
          overflow: 'hidden'
        }}>
          <div
            onClick={() => setIsExpanded(!isExpanded)}
            style={{
              padding: '20px 24px',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'space-between',
              cursor: 'pointer',
              background: isExpanded ? 'var(--bg-light)' : 'var(--bg-white)',
              borderBottom: isExpanded ? '2px solid var(--border-black)' : 'none'
            }}
          >
            <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
              <div style={{
                width: '40px',
                height: '40px',
                background: 'var(--status-orange)',
                borderRadius: '8px',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                fontSize: '1.25rem',
                color: 'white'
              }}>📅</div>
              <div>
                <h3 style={{
                  fontFamily: 'Bebas Neue, sans-serif',
                  fontSize: '1.3rem',
                  fontWeight: '400',
                  color: 'var(--text-black)',
                  letterSpacing: '0.1em',
                  textTransform: 'uppercase',
                  margin: 0
                }}>Integrated Project Timeline</h3>
                <p style={{ fontSize: '0.75rem', color: 'var(--text-medium)', margin: 0 }}>
                  HDD schedule coordinated with asset mobilization
                </p>
              </div>
            </div>
            <div style={{
              width: '32px',
              height: '32px',
              background: 'var(--bg-white)',
              border: '2px solid var(--border-black)',
              borderRadius: '6px',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              color: 'var(--text-black)',
              fontWeight: '700',
              transform: isExpanded ? 'rotate(180deg)' : 'rotate(0deg)',
              transition: 'transform 0.2s ease'
            }}>▼</div>
          </div>

          {isExpanded && (
            <div style={{ padding: '24px' }}>
              {/* Timeline Header */}
              <div style={{
                display: 'flex',
                justifyContent: 'space-between',
                marginBottom: '16px',
                fontSize: '0.75rem',
                fontFamily: 'IBM Plex Mono, monospace',
                color: 'var(--text-dark)',
                fontWeight: '500'
              }}>
                <span>{minDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span>
                <span>{maxDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span>
              </div>

              {/* HDD Crossings Section */}
              <div style={{ marginBottom: '24px' }}>
                <div style={{
                  fontSize: '0.7rem',
                  fontFamily: 'Bebas Neue, sans-serif',
                  color: 'var(--primary-accent)',
                  textTransform: 'uppercase',
                  letterSpacing: '0.1em',
                  marginBottom: '12px',
                  borderBottom: '2px solid var(--primary-accent)',
                  paddingBottom: '4px',
                  display: 'inline-block'
                }}>HDD Crossings</div>

                {config.hddSchedule?.map((hdd, idx) => {
                  const startDate = new Date(hdd.startDate);
                  const endDate = new Date(startDate);
                  endDate.setDate(endDate.getDate() + hdd.rigUpDays + hdd.pilotDays + hdd.reamDays + hdd.swabDays + hdd.pullDays + hdd.rigDownDays);

                  return (
                    <div key={idx} style={{
                      display: 'flex',
                      alignItems: 'center',
                      marginBottom: '8px',
                      height: '32px'
                    }}>
                      <div style={{
                        width: '80px',
                        fontSize: '0.7rem',
                        color: 'var(--text-medium)',
                        fontFamily: 'IBM Plex Mono, monospace',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '6px'
                      }}>
                        <span style={{
                          width: '8px',
                          height: '8px',
                          borderRadius: '50%',
                          background: rigColors[hdd.rig]?.split(',')[0]?.replace('linear-gradient(90deg, ', '') || '#666'
                        }}></span>
                        {hdd.crossing}
                      </div>
                      <div style={{
                        flex: 1,
                        position: 'relative',
                        height: '100%',
                        background: 'var(--bg-muted)',
                        borderRadius: '4px',
                        border: '1px solid var(--border-light)'
                      }}>
                        <div style={{
                          ...getBarStyle(startDate, endDate, rigColors[hdd.rig]),
                          border: '2px solid var(--border-black)',
                          height: '18px'
                        }}></div>
                      </div>
                    </div>
                  );
                })}
              </div>

              {/* Asset Mobilization Section - Tugs */}
              {result?.mobilizationSchedule?.tugs && (
                <div style={{ marginBottom: '20px' }}>
                  <div style={{
                    fontSize: '0.7rem',
                    fontFamily: 'Bebas Neue, sans-serif',
                    color: 'var(--primary-accent)',
                    textTransform: 'uppercase',
                    letterSpacing: '0.1em',
                    marginBottom: '12px',
                    borderBottom: '2px solid var(--primary-accent)',
                    paddingBottom: '4px',
                    display: 'inline-block'
                  }}>TUGS</div>

                  {result.mobilizationSchedule.tugs.map((tug, idx) => (
                    <div key={idx} style={{
                      display: 'flex',
                      alignItems: 'center',
                      marginBottom: '6px',
                      height: '28px'
                    }}>
                      <div style={{
                        width: '80px',
                        fontSize: '0.7rem',
                        color: 'var(--text-dark)',
                        fontFamily: 'IBM Plex Mono, monospace',
                        fontWeight: '500'
                      }}>
                        {tug.id}
                      </div>
                      <div style={{
                        flex: 1,
                        position: 'relative',
                        height: '100%',
                        background: 'var(--bg-muted)',
                        borderRadius: '4px',
                        border: '1px solid var(--border-light)'
                      }}>
                        <div style={{
                          ...getBarStyle(tug.mobDate, tug.demobDate, '#2d9cdb'),
                          border: '2px solid var(--border-black)',
                          height: '18px'
                        }}></div>
                      </div>
                    </div>
                  ))}
                </div>
              )}

              {/* Asset Mobilization Section - Barges */}
              {result?.mobilizationSchedule?.barges && (
                <div style={{ marginBottom: '20px' }}>
                  <div style={{
                    fontSize: '0.7rem',
                    fontFamily: 'Bebas Neue, sans-serif',
                    color: 'var(--status-orange)',
                    textTransform: 'uppercase',
                    letterSpacing: '0.1em',
                    marginBottom: '12px',
                    borderBottom: '2px solid var(--status-orange)',
                    paddingBottom: '4px',
                    display: 'inline-block'
                  }}>BARGES</div>

                  {result.mobilizationSchedule.barges.map((barge, idx) => (
                    <div key={idx} style={{
                      display: 'flex',
                      alignItems: 'center',
                      marginBottom: '6px',
                      height: '28px'
                    }}>
                      <div style={{
                        width: '80px',
                        fontSize: '0.65rem',
                        color: 'var(--text-dark)',
                        fontFamily: 'IBM Plex Mono, monospace',
                        fontWeight: '500'
                      }}>
                        {barge.id}
                      </div>
                      <div style={{
                        flex: 1,
                        position: 'relative',
                        height: '100%',
                        background: 'var(--bg-muted)',
                        borderRadius: '4px',
                        border: '1px solid var(--border-light)'
                      }}>
                        <div style={{
                          ...getBarStyle(barge.mobDate, barge.demobDate, barge.bargeSize === 'large' ? '#d94545' : '#f59e0b'),
                          border: '2px solid var(--border-black)',
                          height: '18px'
                        }}></div>
                      </div>
                    </div>
                  ))}
                </div>
              )}

              {/* Legend - Grungy Style */}
              <div style={{
                marginTop: '20px',
                paddingTop: '16px',
                borderTop: '2px solid var(--border-black)',
                display: 'flex',
                gap: '20px',
                flexWrap: 'wrap',
                justifyContent: 'center'
              }}>
                {['Blue', 'Green', 'Red'].map(rig => (
                  <div key={rig} style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                    <div style={{
                      width: '20px',
                      height: '10px',
                      borderRadius: '2px',
                      background: rigColors[rig],
                      border: '1px solid var(--border-black)'
                    }}></div>
                    <span style={{ fontSize: '0.7rem', color: 'var(--text-dark)', fontFamily: 'IBM Plex Mono, monospace', fontWeight: '500' }}>{rig} Rig</span>
                  </div>
                ))}
                <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                  <div style={{
                    width: '20px',
                    height: '10px',
                    borderRadius: '2px',
                    background: '#2d9cdb',
                    border: '1px solid var(--border-black)'
                  }}></div>
                  <span style={{ fontSize: '0.7rem', color: 'var(--text-dark)', fontFamily: 'IBM Plex Mono, monospace', fontWeight: '500' }}>Tugs</span>
                </div>
                <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                  <div style={{
                    width: '20px',
                    height: '10px',
                    borderRadius: '2px',
                    background: '#f59e0b',
                    border: '1px solid var(--border-black)'
                  }}></div>
                  <span style={{ fontSize: '0.7rem', color: 'var(--text-dark)', fontFamily: 'IBM Plex Mono, monospace', fontWeight: '500' }}>Sm Barges</span>
                </div>
                <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                  <div style={{
                    width: '20px',
                    height: '10px',
                    borderRadius: '2px',
                    background: '#d94545',
                    border: '1px solid var(--border-black)'
                  }}></div>
                  <span style={{ fontSize: '0.7rem', color: 'var(--text-dark)', fontFamily: 'IBM Plex Mono, monospace', fontWeight: '500' }}>Lg Barges</span>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    function OperationsTab({ result, config }) {
      // Render MapTab as the hero view with live status overlay
      return (
        <div style={{ position: 'relative', height: 'calc(100vh - 250px)', background: 'var(--dashboard-bg)', margin: '0 24px', borderRadius: 'var(--card-radius)', overflow: 'hidden' }}>
          {/* Map Animation - Full Height */}
          <MapTab result={result} config={config} />
        </div>
      );
    }

    // PLANNING TAB - Rig Inputs + Mobilization Combined
    function PlanningTab({ result, config, setConfig }) {
      const [expandedSections, setExpandedSections] = useState({
        schedule: true,
        mobilization: true
      });

      const toggleSection = (section) => {
        setExpandedSections(prev => ({ ...prev, [section]: !prev[section] }));
      };

      // Section Card Component - Grungy Style
      const SectionCard = ({ id, icon, title, subtitle, children, accentColor = '#22c55e' }) => (
        <div style={{
          background: 'white',
          borderRadius: '8px',
          overflow: 'hidden',
          boxShadow: '3px 3px 0 #1a1a1a',
          border: '2px solid #1a1a1a'
        }}>
          <div
            onClick={() => toggleSection(id)}
            style={{
              padding: '20px 24px',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'space-between',
              cursor: 'pointer',
              background: expandedSections[id] ? '#f9fafb' : 'white',
              borderBottom: expandedSections[id] ? '2px solid #1a1a1a' : 'none'
            }}
          >
            <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
              <div style={{
                width: '48px',
                height: '48px',
                borderRadius: '4px',
                background: accentColor,
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                fontSize: '1.25rem',
                border: '2px solid #1a1a1a',
                boxShadow: '2px 2px 0 rgba(0, 0, 0, 0.2)'
              }}>
                {icon}
              </div>
              <div>
                <h3 style={{
                  fontSize: '1.1rem',
                  fontFamily: 'Bebas Neue, sans-serif',
                  letterSpacing: '0.05em',
                  textTransform: 'uppercase',
                  color: '#1a1a1a',
                  margin: 0
                }}>{title}</h3>
                <p style={{
                  fontSize: '0.8rem',
                  fontFamily: 'IBM Plex Mono, monospace',
                  color: '#6b7280',
                  margin: '4px 0 0 0'
                }}>{subtitle}</p>
              </div>
            </div>
            <div style={{
              width: '32px',
              height: '32px',
              borderRadius: '4px',
              background: '#f3f4f6',
              border: '2px solid #1a1a1a',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              transition: 'transform 0.3s ease',
              transform: expandedSections[id] ? 'rotate(180deg)' : 'rotate(0deg)'
            }}>
              <span style={{ fontSize: '0.8rem', color: '#1a1a1a' }}>▼</span>
            </div>
          </div>
          <div style={{
            maxHeight: expandedSections[id] ? '2000px' : '0',
            overflow: 'hidden',
            transition: 'max-height 0.4s ease-in-out'
          }}>
            <div style={{ padding: '24px' }}>
              {children}
            </div>
          </div>
        </div>
      );

      return (
        <div style={{ display: 'flex', flexDirection: 'column', gap: '20px' }}>
          {/* Page Header */}
          <div style={{ marginBottom: '8px' }}>
            <div style={{
              fontFamily: 'IBM Plex Mono, monospace',
              fontSize: '0.7rem',
              fontWeight: 'bold',
              color: '#6b7280',
              letterSpacing: '0.1em',
              textTransform: 'uppercase',
              marginBottom: '8px'
            }}>PROJECT PLANNING</div>
            <h2 style={{
              fontSize: '2rem',
              fontFamily: 'Bebas Neue, sans-serif',
              letterSpacing: '0.05em',
              textTransform: 'uppercase',
              color: '#1a1a1a',
              margin: '8px 0'
            }}>
              Schedule & Resources
            </h2>
            <p style={{
              color: '#6b7280',
              fontSize: '0.9rem',
              fontFamily: 'Work Sans, sans-serif'
            }}>
              Configure HDD schedules, consumption rates, and view mobilization timeline
            </p>
          </div>

          {/* Collapsible Sections */}
          <SectionCard
            id="schedule"
            icon="📅"
            title="HDD Schedule & Consumption"
            subtitle={`${config.hddSchedule.length} crossings configured with rig consumption rates`}
            accentColor="#22c55e"
          >
            <RigInputsTab config={config} setConfig={setConfig} />
          </SectionCard>

          <SectionCard
            id="mobilization"
            icon="🚢"
            title="Mobilization Timeline"
            subtitle="Asset deployment schedule"
            accentColor="#d94545"
          >
            <MobilizationScheduleTab result={result} />
          </SectionCard>
        </div>
      );
    }

    // FINANCIALS TAB - Redesigned with Zero Duplication
    function FinancialsTab({ result, optimizationResults, config, setConfig, runOptimization, isRunning }) {
      const [expandedSections, setExpandedSections] = useState({
        costParameters: true,
        currentCosts: true,
        optimization: true,
        sensitivity: false
      });

      const toggleSection = (section) => {
        setExpandedSections(prev => ({ ...prev, [section]: !prev[section] }));
      };

      const formatCurrency = (val) => `$${Math.round(val).toLocaleString()}`;

      const updateConfig = (key, value) => {
        setConfig(prev => ({ ...prev, [key]: value }));
      };

      // Collapsible Section Card - Grungy Style
      const FinanceCard = ({ id, icon, title, subtitle, badge, children, accentColor = '#22c55e' }) => (
        <div style={{
          background: 'white',
          borderRadius: '8px',
          overflow: 'hidden',
          boxShadow: '3px 3px 0 #1a1a1a',
          border: '2px solid #1a1a1a'
        }}>
          <div
            onClick={() => toggleSection(id)}
            style={{
              padding: '20px 24px',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'space-between',
              cursor: 'pointer',
              background: expandedSections[id] ? '#f9fafb' : 'white',
              borderBottom: expandedSections[id] ? '2px solid #1a1a1a' : 'none'
            }}
          >
            <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
              <div style={{
                width: '48px',
                height: '48px',
                borderRadius: '4px',
                background: accentColor,
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                fontSize: '1.25rem',
                border: '2px solid #1a1a1a',
                boxShadow: '2px 2px 0 rgba(0, 0, 0, 0.2)'
              }}>
                {icon}
              </div>
              <div>
                <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                  <h3 style={{
                    fontSize: '1.1rem',
                    fontFamily: 'Bebas Neue, sans-serif',
                    letterSpacing: '0.05em',
                    textTransform: 'uppercase',
                    color: '#1a1a1a',
                    margin: 0
                  }}>{title}</h3>
                  {badge && <span style={{
                    padding: '6px 12px',
                    borderRadius: '4px',
                    fontSize: '0.65rem',
                    fontFamily: 'IBM Plex Mono, monospace',
                    fontWeight: 'bold',
                    background: badge.bg,
                    color: badge.color,
                    textTransform: 'uppercase',
                    border: '2px solid #1a1a1a',
                    boxShadow: '2px 2px 0 rgba(0, 0, 0, 0.2)'
                  }}>{badge.text}</span>}
                </div>
                <p style={{
                  fontSize: '0.8rem',
                  fontFamily: 'IBM Plex Mono, monospace',
                  color: '#6b7280',
                  margin: '4px 0 0 0'
                }}>{subtitle}</p>
              </div>
            </div>
            <div style={{
              width: '32px',
              height: '32px',
              borderRadius: '4px',
              background: '#f3f4f6',
              border: '2px solid #1a1a1a',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              transition: 'transform 0.3s ease',
              transform: expandedSections[id] ? 'rotate(180deg)' : 'rotate(0deg)'
            }}>
              <span style={{ fontSize: '0.8rem', color: '#1a1a1a' }}>▼</span>
            </div>
          </div>
          <div style={{
            maxHeight: expandedSections[id] ? '3000px' : '0',
            overflow: 'hidden',
            transition: 'max-height 0.4s ease-in-out'
          }}>
            <div style={{ padding: '24px' }}>
              {children}
            </div>
          </div>
        </div>
      );

      return (
        <div style={{ display: 'flex', flexDirection: 'column', gap: '20px' }}>
          {/* Page Header with Total Cost Hero */}
          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '24px', marginBottom: '8px' }}>
            <div>
              <div style={{
                fontFamily: 'IBM Plex Mono, monospace',
                fontSize: '0.7rem',
                fontWeight: 'bold',
                color: '#6b7280',
                letterSpacing: '0.1em',
                textTransform: 'uppercase',
                marginBottom: '8px'
              }}>FINANCIAL ANALYSIS</div>
              <h2 style={{
                fontSize: '2rem',
                fontFamily: 'Bebas Neue, sans-serif',
                letterSpacing: '0.05em',
                textTransform: 'uppercase',
                color: '#1a1a1a',
                margin: '8px 0'
              }}>
                Cost Dashboard
              </h2>
              <p style={{
                color: '#6b7280',
                fontSize: '0.9rem',
                fontFamily: 'Work Sans, sans-serif'
              }}>
                Configure pricing, analyze costs, and optimize fleet composition
              </p>
            </div>

            {/* Hero Total Cost Card - KEPT AS-IS */}
            {result && (
              <div style={{
                background: '#1e3a5f',
                borderRadius: '8px',
                padding: '28px 32px',
                color: 'white',
                border: '2px solid #1a1a1a',
                boxShadow: '4px 4px 0 #1a1a1a'
              }}>
                <div style={{
                  fontSize: '0.7rem',
                  fontFamily: 'IBM Plex Mono, monospace',
                  fontWeight: 'bold',
                  textTransform: 'uppercase',
                  letterSpacing: '0.15em',
                  opacity: 0.8,
                  marginBottom: '8px'
                }}>
                  Total Project Cost
                </div>
                <div style={{
                  fontSize: '2.5rem',
                  fontFamily: 'Bebas Neue, sans-serif',
                  letterSpacing: '0.02em'
                }}>
                  {formatCurrency(result.costs?.grandTotal || 0)}
                </div>
                <div style={{
                  display: 'flex',
                  gap: '24px',
                  marginTop: '16px',
                  fontSize: '0.8rem',
                  fontFamily: 'Work Sans, sans-serif',
                  paddingTop: '16px',
                  borderTop: '2px solid rgba(255, 255, 255, 0.2)'
                }}>
                  <div>
                    <span style={{ opacity: 0.7 }}>Equipment</span>{' '}
                    <strong style={{ fontFamily: 'IBM Plex Mono, monospace' }}>
                      {formatCurrency(result.costs?.equipmentTotal || 0)}
                    </strong>
                  </div>
                  <div>
                    <span style={{ opacity: 0.7 }}>Fuel</span>{' '}
                    <strong style={{ fontFamily: 'IBM Plex Mono, monospace' }}>
                      {formatCurrency(result.costs?.fuelTotal || 0)}
                    </strong>
                  </div>
                  <div>
                    <span style={{ opacity: 0.7 }}>Water</span>{' '}
                    <strong style={{ fontFamily: 'IBM Plex Mono, monospace' }}>
                      {formatCurrency(result.costs?.waterTotal || 0)}
                    </strong>
                  </div>
                </div>
              </div>
            )}
          </div>

          {/* FLEET OPTIMIZATION BUTTON - Prominent Top-Level Action */}
          <div style={{
            background: 'linear-gradient(135deg, #1e3a5f 0%, #152d47 100%)',
            border: '3px solid #1a1a1a',
            borderRadius: '12px',
            padding: '24px 32px',
            boxShadow: '5px 5px 0 #1a1a1a',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'space-between',
            gap: '24px'
          }}>
            <div style={{ flex: 1 }}>
              <div style={{
                fontSize: '1.25rem',
                fontFamily: 'Bebas Neue, sans-serif',
                letterSpacing: '0.05em',
                textTransform: 'uppercase',
                color: 'white',
                marginBottom: '8px'
              }}>
                ⚡ Fleet Cost Optimizer
              </div>
              <p style={{
                fontSize: '0.85rem',
                fontFamily: 'Work Sans, sans-serif',
                color: 'rgba(255, 255, 255, 0.9)',
                margin: 0
              }}>
                Test ~20 configurations to find lower-cost fleet alternatives
              </p>
            </div>
            <button
              onClick={runOptimization}
              disabled={isRunning || !result}
              style={{
                padding: '16px 48px',
                fontSize: '1.1rem',
                fontFamily: 'Bebas Neue, sans-serif',
                letterSpacing: '0.05em',
                textTransform: 'uppercase',
                background: isRunning || !result ? '#9ca3af' : '#d94545',
                color: 'white',
                border: '3px solid #1a1a1a',
                borderRadius: '8px',
                boxShadow: '4px 4px 0 #1a1a1a',
                cursor: isRunning || !result ? 'not-allowed' : 'pointer',
                transition: 'all 0.2s ease',
                whiteSpace: 'nowrap'
              }}
              onMouseEnter={(e) => {
                if (!isRunning && result) {
                  e.target.style.transform = 'translateY(-2px)';
                  e.target.style.boxShadow = '6px 6px 0 #1a1a1a';
                }
              }}
              onMouseLeave={(e) => {
                e.target.style.transform = 'translateY(0)';
                e.target.style.boxShadow = '4px 4px 0 #1a1a1a';
              }}
            >
              {isRunning ? '⏳ Optimizing...' : '⚡ Run Optimization'}
            </button>
            {optimizationResults && (
              <div style={{
                padding: '8px 16px',
                background: '#3d7068',
                border: '2px solid #1a1a1a',
                borderRadius: '6px',
                boxShadow: '2px 2px 0 #1a1a1a',
                fontSize: '0.75rem',
                fontFamily: 'IBM Plex Mono, monospace',
                fontWeight: 'bold',
                color: 'white',
                textTransform: 'uppercase',
                whiteSpace: 'nowrap'
              }}>
                ✓ {optimizationResults.successCount} Results
              </div>
            )}
          </div>

          {/* 1. COST PARAMETERS - Inputs Only, No Optimization Button */}
          <FinanceCard
            id="costParameters"
            icon="📊"
            title="Cost Parameters"
            subtitle="Configure pricing inputs for simulation"
            accentColor="#2d4f7c"
          >
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: '8px 16px' }}>
              <NumberInput label="Fuel Price" value={config.FUEL_PRICE_PER_GAL} onChange={v => updateConfig('FUEL_PRICE_PER_GAL', v)} step={0.01} unit="/gal" isCurrency={true} decimals={2} />
              <NumberInput label="Downtime Rate" value={config.DOWNTIME_HOURLY_RATE} onChange={v => updateConfig('DOWNTIME_HOURLY_RATE', v)} unit="/hr" isCurrency={true} />
              <NumberInput label="Tug Day Rate" value={config.TUG_DAY_RATE} onChange={v => updateConfig('TUG_DAY_RATE', v)} isCurrency={true} />
              <NumberInput label="Lg Barge Day Rate" value={config.LARGE_BARGE_DAY_RATE} onChange={v => updateConfig('LARGE_BARGE_DAY_RATE', v)} isCurrency={true} />
              <NumberInput label="Sm Barge Day Rate" value={config.SMALL_BARGE_DAY_RATE} onChange={v => updateConfig('SMALL_BARGE_DAY_RATE', v)} isCurrency={true} />
              <NumberInput label="Tug Mob Cost" value={config.TUG_MOB_COST} onChange={v => updateConfig('TUG_MOB_COST', v)} isCurrency={true} />
              <NumberInput label="Tug Demob Cost" value={config.TUG_DEMOB_COST} onChange={v => updateConfig('TUG_DEMOB_COST', v)} isCurrency={true} />
              <NumberInput label="Barge Mob Days" value={config.BARGE_MOB_DEMOB_COST_DAYS} onChange={v => updateConfig('BARGE_MOB_DEMOB_COST_DAYS', v)} unit="days" />
              <NumberInput label="Fuel (Idle)" value={config.TUG_FUEL_IDLE_GPH} onChange={v => updateConfig('TUG_FUEL_IDLE_GPH', v)} unit="gal/hr" />
              <NumberInput label="Fuel (Running)" value={config.TUG_FUEL_RUNNING_GPH} onChange={v => updateConfig('TUG_FUEL_RUNNING_GPH', v)} unit="gal/hr" />
            </div>

            {/* Water Acquisition Costs */}
            <div style={{ marginTop: '16px', paddingTop: '16px', borderTop: '2px solid #e5e7eb' }}>
              <h4 style={{
                fontSize: '0.75rem',
                fontFamily: 'IBM Plex Mono, monospace',
                fontWeight: 'bold',
                marginBottom: '12px',
                color: '#6b7280',
                textTransform: 'uppercase',
                letterSpacing: '0.05em'
              }}>Water Acquisition Costs</h4>
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '8px 16px' }}>
                <NumberInput label="Source 1" value={config.WATER_COST_SOURCE1} onChange={v => updateConfig('WATER_COST_SOURCE1', v)} step={0.01} unit="/gal" isCurrency={true} decimals={4} />
                <NumberInput label="Source 2" value={config.WATER_COST_SOURCE2} onChange={v => updateConfig('WATER_COST_SOURCE2', v)} step={0.01} unit="/gal" isCurrency={true} decimals={4} />
                <NumberInput label="Source 3" value={config.WATER_COST_SOURCE3} onChange={v => updateConfig('WATER_COST_SOURCE3', v)} step={0.01} unit="/gal" isCurrency={true} decimals={4} />
              </div>
            </div>
          </FinanceCard>

          {/* 2. CURRENT COSTS BREAKDOWN - New Consolidated Section */}
          {result && (
            <FinanceCard
              id="currentCosts"
              icon="💰"
              title="Current Simulation Costs"
              subtitle="Detailed breakdown of cost allocation"
              accentColor="#4a6b96"
            >
              {/* Daily Rental Costs */}
              <div style={{ marginBottom: '24px' }}>
                <h4 style={{
                  fontSize: '0.75rem',
                  fontFamily: 'IBM Plex Mono, monospace',
                  fontWeight: 'bold',
                  color: '#6b7280',
                  textTransform: 'uppercase',
                  letterSpacing: '0.05em',
                  marginBottom: '12px'
                }}>Daily Rental Costs</h4>
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '12px' }}>
                  <div style={{
                    background: 'white',
                    border: '2px solid #1a1a1a',
                    borderRadius: '8px',
                    padding: '20px',
                    boxShadow: '3px 3px 0 #1a1a1a',
                    textAlign: 'center',
                    borderTop: '4px solid #2d4f7c'
                  }}>
                    <div style={{
                      fontSize: '0.65rem',
                      fontFamily: 'IBM Plex Mono, monospace',
                      color: '#6b7280',
                      textTransform: 'uppercase',
                      marginBottom: '8px'
                    }}>Tug Rental</div>
                    <div style={{
                      fontSize: '1.75rem',
                      fontFamily: 'Bebas Neue, sans-serif',
                      color: '#1a1a1a'
                    }}>{formatCurrency(result.costs.tugRental)}</div>
                  </div>
                  <div style={{
                    background: 'white',
                    border: '2px solid #1a1a1a',
                    borderRadius: '8px',
                    padding: '20px',
                    boxShadow: '3px 3px 0 #1a1a1a',
                    textAlign: 'center',
                    borderTop: '4px solid #4a6b96'
                  }}>
                    <div style={{
                      fontSize: '0.65rem',
                      fontFamily: 'IBM Plex Mono, monospace',
                      color: '#6b7280',
                      textTransform: 'uppercase',
                      marginBottom: '8px'
                    }}>Small Barge Rental</div>
                    <div style={{
                      fontSize: '1.75rem',
                      fontFamily: 'Bebas Neue, sans-serif',
                      color: '#1a1a1a'
                    }}>{formatCurrency(result.costs.smallBargeRental)}</div>
                  </div>
                  <div style={{
                    background: 'white',
                    border: '2px solid #1a1a1a',
                    borderRadius: '8px',
                    padding: '20px',
                    boxShadow: '3px 3px 0 #1a1a1a',
                    textAlign: 'center',
                    borderTop: '4px solid #4a6b96'
                  }}>
                    <div style={{
                      fontSize: '0.65rem',
                      fontFamily: 'IBM Plex Mono, monospace',
                      color: '#6b7280',
                      textTransform: 'uppercase',
                      marginBottom: '8px'
                    }}>Large Barge Rental</div>
                    <div style={{
                      fontSize: '1.75rem',
                      fontFamily: 'Bebas Neue, sans-serif',
                      color: '#1a1a1a'
                    }}>{formatCurrency(result.costs.largeBargeRental)}</div>
                  </div>
                </div>
              </div>

              {/* Mobilization Costs */}
              <div style={{ marginBottom: '24px' }}>
                <h4 style={{
                  fontSize: '0.75rem',
                  fontFamily: 'IBM Plex Mono, monospace',
                  fontWeight: 'bold',
                  color: '#6b7280',
                  textTransform: 'uppercase',
                  letterSpacing: '0.05em',
                  marginBottom: '12px'
                }}>Mobilization & Demobilization</h4>
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '12px' }}>
                  <div style={{
                    background: '#f9fafb',
                    border: '2px solid #1a1a1a',
                    borderRadius: '8px',
                    padding: '16px',
                    boxShadow: '2px 2px 0 #1a1a1a',
                    textAlign: 'center'
                  }}>
                    <div style={{
                      fontSize: '0.6rem',
                      fontFamily: 'IBM Plex Mono, monospace',
                      color: '#6b7280',
                      textTransform: 'uppercase',
                      marginBottom: '6px'
                    }}>Tug Mob/Demob</div>
                    <div style={{
                      fontSize: '1.25rem',
                      fontFamily: 'Bebas Neue, sans-serif',
                      color: '#1a1a1a'
                    }}>{formatCurrency(result.costs.mobDemobBreakdown?.tugs || 0)}</div>
                  </div>
                  <div style={{
                    background: '#f9fafb',
                    border: '2px solid #1a1a1a',
                    borderRadius: '8px',
                    padding: '16px',
                    boxShadow: '2px 2px 0 #1a1a1a',
                    textAlign: 'center'
                  }}>
                    <div style={{
                      fontSize: '0.6rem',
                      fontFamily: 'IBM Plex Mono, monospace',
                      color: '#6b7280',
                      textTransform: 'uppercase',
                      marginBottom: '6px'
                    }}>Sm Barge Mob/Demob</div>
                    <div style={{
                      fontSize: '1.25rem',
                      fontFamily: 'Bebas Neue, sans-serif',
                      color: '#1a1a1a'
                    }}>{formatCurrency(result.costs.mobDemobBreakdown?.smallBarges || 0)}</div>
                  </div>
                  <div style={{
                    background: '#f9fafb',
                    border: '2px solid #1a1a1a',
                    borderRadius: '8px',
                    padding: '16px',
                    boxShadow: '2px 2px 0 #1a1a1a',
                    textAlign: 'center'
                  }}>
                    <div style={{
                      fontSize: '0.6rem',
                      fontFamily: 'IBM Plex Mono, monospace',
                      color: '#6b7280',
                      textTransform: 'uppercase',
                      marginBottom: '6px'
                    }}>Lg Barge Mob/Demob</div>
                    <div style={{
                      fontSize: '1.25rem',
                      fontFamily: 'Bebas Neue, sans-serif',
                      color: '#1a1a1a'
                    }}>{formatCurrency(result.costs.mobDemobBreakdown?.largeBarges || 0)}</div>
                  </div>
                </div>
              </div>

              {/* Operational Costs */}
              <div style={{ marginBottom: '24px' }}>
                <h4 style={{
                  fontSize: '0.75rem',
                  fontFamily: 'IBM Plex Mono, monospace',
                  fontWeight: 'bold',
                  color: '#6b7280',
                  textTransform: 'uppercase',
                  letterSpacing: '0.05em',
                  marginBottom: '12px'
                }}>Operational Costs</h4>
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '12px' }}>
                  <div style={{
                    background: 'white',
                    border: '2px solid #1a1a1a',
                    borderRadius: '8px',
                    padding: '16px',
                    boxShadow: '2px 2px 0 #1a1a1a',
                    textAlign: 'center',
                    borderLeft: '4px solid #c97575'
                  }}>
                    <div style={{
                      fontSize: '0.6rem',
                      fontFamily: 'IBM Plex Mono, monospace',
                      color: '#6b7280',
                      textTransform: 'uppercase',
                      marginBottom: '6px'
                    }}>Fuel Cost</div>
                    <div style={{
                      fontSize: '1.25rem',
                      fontFamily: 'Bebas Neue, sans-serif',
                      color: '#c97575'
                    }}>{formatCurrency(result.costs.fuelTotal)}</div>
                  </div>
                  <div style={{
                    background: 'white',
                    border: '2px solid #1a1a1a',
                    borderRadius: '8px',
                    padding: '16px',
                    boxShadow: '2px 2px 0 #1a1a1a',
                    textAlign: 'center',
                    borderLeft: '4px solid #d94545'
                  }}>
                    <div style={{
                      fontSize: '0.6rem',
                      fontFamily: 'IBM Plex Mono, monospace',
                      color: '#6b7280',
                      textTransform: 'uppercase',
                      marginBottom: '6px'
                    }}>Downtime Cost</div>
                    <div style={{
                      fontSize: '1.25rem',
                      fontFamily: 'Bebas Neue, sans-serif',
                      color: '#d94545'
                    }}>{formatCurrency(result.costs.downtimeTotal)}</div>
                  </div>
                  <div style={{
                    background: 'white',
                    border: '2px solid #1a1a1a',
                    borderRadius: '8px',
                    padding: '16px',
                    boxShadow: '2px 2px 0 #1a1a1a',
                    textAlign: 'center',
                    borderLeft: '4px solid #4a6b96'
                  }}>
                    <div style={{
                      fontSize: '0.6rem',
                      fontFamily: 'IBM Plex Mono, monospace',
                      color: '#6b7280',
                      textTransform: 'uppercase',
                      marginBottom: '6px'
                    }}>Water Acquisition</div>
                    <div style={{
                      fontSize: '1.25rem',
                      fontFamily: 'Bebas Neue, sans-serif',
                      color: '#4a6b96'
                    }}>{formatCurrency(result.costs.waterTotal || 0)}</div>
                  </div>
                </div>
              </div>

              {/* Cost-Per-Gallon Analysis Table */}
              {result.costPerGallonHistory && Object.keys(result.costPerGallonHistory).length > 0 && (
                <div style={{ marginTop: '32px', paddingTop: '24px', borderTop: '2px solid #e5e7eb' }}>
                  <h4 style={{
                    fontSize: '0.85rem',
                    fontFamily: 'Bebas Neue, sans-serif',
                    letterSpacing: '0.05em',
                    textTransform: 'uppercase',
                    color: '#1a1a1a',
                    marginBottom: '8px'
                  }}>Cost Per Gallon Analysis</h4>
                  <p style={{
                    fontSize: '0.75rem',
                    fontFamily: 'Work Sans, sans-serif',
                    color: '#6b7280',
                    marginBottom: '16px'
                  }}>
                    Delivered water cost by source-destination including acquisition, queue, fill, transit, and fuel
                  </p>
                  <div style={{ overflowX: 'auto' }}>
                    <table style={{
                      width: '100%',
                      fontSize: '0.75rem',
                      borderCollapse: 'collapse',
                      border: '2px solid #1a1a1a'
                    }}>
                      <thead>
                        <tr style={{ background: '#f3f4f6' }}>
                          <th style={{
                            padding: '12px',
                            textAlign: 'left',
                            fontFamily: 'IBM Plex Mono, monospace',
                            fontWeight: 'bold',
                            textTransform: 'uppercase',
                            borderBottom: '2px solid #1a1a1a'
                          }}>Route</th>
                          <th style={{
                            padding: '12px',
                            textAlign: 'right',
                            fontFamily: 'IBM Plex Mono, monospace',
                            fontWeight: 'bold',
                            textTransform: 'uppercase',
                            borderBottom: '2px solid #1a1a1a',
                            borderLeft: '1px solid #d1d5db'
                          }}>Deliveries</th>
                          <th style={{
                            padding: '12px',
                            textAlign: 'right',
                            fontFamily: 'IBM Plex Mono, monospace',
                            fontWeight: 'bold',
                            textTransform: 'uppercase',
                            borderBottom: '2px solid #1a1a1a',
                            borderLeft: '1px solid #d1d5db'
                          }}>Avg $/Gal</th>
                          <th style={{
                            padding: '12px',
                            textAlign: 'right',
                            fontFamily: 'IBM Plex Mono, monospace',
                            fontWeight: 'bold',
                            textTransform: 'uppercase',
                            borderBottom: '2px solid #1a1a1a',
                            borderLeft: '1px solid #d1d5db'
                          }}>Min $/Gal</th>
                          <th style={{
                            padding: '12px',
                            textAlign: 'right',
                            fontFamily: 'IBM Plex Mono, monospace',
                            fontWeight: 'bold',
                            textTransform: 'uppercase',
                            borderBottom: '2px solid #1a1a1a',
                            borderLeft: '1px solid #d1d5db'
                          }}>Max $/Gal</th>
                          <th style={{
                            padding: '12px',
                            textAlign: 'right',
                            fontFamily: 'IBM Plex Mono, monospace',
                            fontWeight: 'bold',
                            textTransform: 'uppercase',
                            borderBottom: '2px solid #1a1a1a',
                            borderLeft: '1px solid #d1d5db'
                          }}>Avg Queue (hrs)</th>
                          <th style={{
                            padding: '12px',
                            textAlign: 'right',
                            fontFamily: 'IBM Plex Mono, monospace',
                            fontWeight: 'bold',
                            textTransform: 'uppercase',
                            borderBottom: '2px solid #1a1a1a',
                            borderLeft: '1px solid #d1d5db'
                          }}>Total (K gal)</th>
                        </tr>
                      </thead>
                      <tbody>
                        {Object.entries(result.costPerGallonHistory)
                          .sort(([a], [b]) => a.localeCompare(b))
                          .map(([route, journeys], idx) => {
                            const avgCost = journeys.reduce((sum, j) => sum + j.costPerGallon, 0) / journeys.length;
                            const minCost = Math.min(...journeys.map(j => j.costPerGallon));
                            const maxCost = Math.max(...journeys.map(j => j.costPerGallon));
                            const avgQueue = journeys.reduce((sum, j) => sum + (j.queueTimeHours || 0), 0) / journeys.length;
                            const totalWater = journeys.reduce((sum, j) => sum + j.waterDelivered, 0) / 1000;
                            return (
                              <tr key={route} style={{
                                background: idx % 2 === 0 ? 'white' : '#f9fafb',
                                borderBottom: '1px solid #e5e7eb'
                              }}>
                                <td style={{
                                  padding: '12px',
                                  fontFamily: 'IBM Plex Mono, monospace',
                                  fontWeight: '600'
                                }}>{route}</td>
                                <td style={{
                                  padding: '12px',
                                  textAlign: 'right',
                                  fontFamily: 'IBM Plex Mono, monospace'
                                }}>{journeys.length}</td>
                                <td style={{
                                  padding: '12px',
                                  textAlign: 'right',
                                  fontFamily: 'IBM Plex Mono, monospace',
                                  fontWeight: '600'
                                }}>${avgCost.toFixed(4)}</td>
                                <td style={{
                                  padding: '12px',
                                  textAlign: 'right',
                                  fontFamily: 'IBM Plex Mono, monospace',
                                  color: '#3d7068'
                                }}>${minCost.toFixed(4)}</td>
                                <td style={{
                                  padding: '12px',
                                  textAlign: 'right',
                                  fontFamily: 'IBM Plex Mono, monospace',
                                  color: '#d94545'
                                }}>${maxCost.toFixed(4)}</td>
                                <td style={{
                                  padding: '12px',
                                  textAlign: 'right',
                                  fontFamily: 'IBM Plex Mono, monospace'
                                }}>{avgQueue.toFixed(1)}</td>
                                <td style={{
                                  padding: '12px',
                                  textAlign: 'right',
                                  fontFamily: 'IBM Plex Mono, monospace'
                                }}>{totalWater.toFixed(1)}</td>
                              </tr>
                            );
                          })}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}
            </FinanceCard>
          )}

          {/* 3. FLEET OPTIMIZATION RESULTS - Detailed Table */}
          {optimizationResults && optimizationResults.top15 && optimizationResults.top15.length > 0 && (
            <FinanceCard
              id="optimization"
              icon="📊"
              title="Optimization Results"
              subtitle="Detailed fleet configurations and cost breakdown"
              badge={{ text: `${optimizationResults.successCount} configs tested`, bg: '#3d7068', color: 'white' }}
              accentColor="#1e3a5f"
            >
              {/* Detailed 15-Column Optimization Results Table */}
              <div>
                <h4 style={{
                  fontSize: '0.85rem',
                  fontFamily: 'Bebas Neue, sans-serif',
                  letterSpacing: '0.05em',
                  textTransform: 'uppercase',
                  marginBottom: '8px'
                }}>Top 15 Configurations - Full Cost Breakdown</h4>
                <p style={{
                  fontSize: '0.75rem',
                  fontFamily: 'Work Sans, sans-serif',
                  color: '#6b7280',
                  marginBottom: '16px'
                }}>
                  <span style={{ display: 'inline-flex', alignItems: 'center', gap: '6px', marginRight: '16px' }}>
                    <span style={{ width: '12px', height: '12px', borderRadius: '2px', background: '#D1FAE5', border: '1px solid #1a1a1a' }}></span> Recommended (zero ran dry)
                  </span>
                  <span style={{ display: 'inline-flex', alignItems: 'center', gap: '6px', marginRight: '16px' }}>
                    <span style={{ width: '12px', height: '12px', borderRadius: '2px', background: '#DBEAFE', border: '1px solid #1a1a1a' }}></span> Acceptable (&lt; 8h downtime)
                  </span>
                  <span style={{ display: 'inline-flex', alignItems: 'center', gap: '6px' }}>
                    <span style={{ width: '12px', height: '12px', borderRadius: '2px', background: '#FEE2E2', border: '1px solid #1a1a1a' }}></span> Excessive downtime
                  </span>
                </p>
                <div style={{ overflowX: 'auto' }}>
                  <table style={{
                    width: '100%',
                    fontSize: '0.7rem',
                    borderCollapse: 'collapse',
                    border: '2px solid #1a1a1a'
                  }}>
                    <thead>
                      <tr style={{ background: '#f3f4f6' }}>
                        <th style={{ padding: '10px 6px', textAlign: 'center', fontFamily: 'IBM Plex Mono, monospace', fontWeight: 'bold', textTransform: 'uppercase', borderBottom: '2px solid #1a1a1a' }}>Rank</th>
                        <th style={{ padding: '10px 6px', textAlign: 'center', fontFamily: 'IBM Plex Mono, monospace', fontWeight: 'bold', textTransform: 'uppercase', borderBottom: '2px solid #1a1a1a', borderLeft: '1px solid #d1d5db' }}>Tugs</th>
                        <th style={{ padding: '10px 6px', textAlign: 'center', fontFamily: 'IBM Plex Mono, monospace', fontWeight: 'bold', textTransform: 'uppercase', borderBottom: '2px solid #1a1a1a', borderLeft: '1px solid #d1d5db' }}>ST</th>
                        <th style={{ padding: '10px 6px', textAlign: 'center', fontFamily: 'IBM Plex Mono, monospace', fontWeight: 'bold', textTransform: 'uppercase', borderBottom: '2px solid #1a1a1a', borderLeft: '1px solid #d1d5db' }}>SS</th>
                        <th style={{ padding: '10px 6px', textAlign: 'center', fontFamily: 'IBM Plex Mono, monospace', fontWeight: 'bold', textTransform: 'uppercase', borderBottom: '2px solid #1a1a1a', borderLeft: '1px solid #d1d5db' }}>LT</th>
                        <th style={{ padding: '10px 6px', textAlign: 'center', fontFamily: 'IBM Plex Mono, monospace', fontWeight: 'bold', textTransform: 'uppercase', borderBottom: '2px solid #1a1a1a', borderLeft: '1px solid #d1d5db' }}>LS</th>
                        <th style={{ padding: '10px 6px', textAlign: 'right', fontFamily: 'IBM Plex Mono, monospace', fontWeight: 'bold', textTransform: 'uppercase', borderBottom: '2px solid #1a1a1a', borderLeft: '2px solid #1a1a1a' }}>Tug Daily</th>
                        <th style={{ padding: '10px 6px', textAlign: 'right', fontFamily: 'IBM Plex Mono, monospace', fontWeight: 'bold', textTransform: 'uppercase', borderBottom: '2px solid #1a1a1a', borderLeft: '1px solid #d1d5db' }}>Sm Brg</th>
                        <th style={{ padding: '10px 6px', textAlign: 'right', fontFamily: 'IBM Plex Mono, monospace', fontWeight: 'bold', textTransform: 'uppercase', borderBottom: '2px solid #1a1a1a', borderLeft: '1px solid #d1d5db' }}>Lg Brg</th>
                        <th style={{ padding: '10px 6px', textAlign: 'right', fontFamily: 'IBM Plex Mono, monospace', fontWeight: 'bold', textTransform: 'uppercase', borderBottom: '2px solid #1a1a1a', borderLeft: '2px solid #1a1a1a' }}>Tug M/D</th>
                        <th style={{ padding: '10px 6px', textAlign: 'right', fontFamily: 'IBM Plex Mono, monospace', fontWeight: 'bold', textTransform: 'uppercase', borderBottom: '2px solid #1a1a1a', borderLeft: '1px solid #d1d5db' }}>Sm M/D</th>
                        <th style={{ padding: '10px 6px', textAlign: 'right', fontFamily: 'IBM Plex Mono, monospace', fontWeight: 'bold', textTransform: 'uppercase', borderBottom: '2px solid #1a1a1a', borderLeft: '1px solid #d1d5db' }}>Lg M/D</th>
                        <th style={{ padding: '10px 6px', textAlign: 'right', fontFamily: 'IBM Plex Mono, monospace', fontWeight: 'bold', textTransform: 'uppercase', borderBottom: '2px solid #1a1a1a', borderLeft: '2px solid #1a1a1a' }}>Fuel</th>
                        <th style={{ padding: '10px 6px', textAlign: 'right', fontFamily: 'IBM Plex Mono, monospace', fontWeight: 'bold', textTransform: 'uppercase', borderBottom: '2px solid #1a1a1a', borderLeft: '1px solid #d1d5db' }}>Downtime</th>
                        <th style={{ padding: '10px 6px', textAlign: 'right', fontFamily: 'IBM Plex Mono, monospace', fontWeight: 'bold', textTransform: 'uppercase', borderBottom: '2px solid #1a1a1a', borderLeft: '1px solid #d1d5db' }}>Water</th>
                        <th style={{ padding: '10px 6px', textAlign: 'right', fontFamily: 'IBM Plex Mono, monospace', fontWeight: 'bold', textTransform: 'uppercase', borderBottom: '2px solid #1a1a1a', borderLeft: '2px solid #1a1a1a', background: '#e0f2fe' }}>Total Cost</th>
                      </tr>
                    </thead>
                    <tbody>
                      {optimizationResults.top15.map((r, idx) => {
                        const ACCEPTABLE_DOWNTIME_HOURS = 8;
                        const isAcceptable = r.ranDryCount === 0 || (r.downtimeHours !== undefined && r.downtimeHours < ACCEPTABLE_DOWNTIME_HOURS);
                        const hasExcessiveDowntime = !isAcceptable;
                        const strikeClass = hasExcessiveDowntime ? 'line-through' : '';
                        const isZeroRanDry = r.ranDryCount === 0;
                        const bgColor = idx === 0 ? '#D1FAE5' : hasExcessiveDowntime ? '#FEE2E2' : !isZeroRanDry ? '#DBEAFE' : 'white';

                        return (
                          <tr key={idx} style={{ background: bgColor, borderBottom: '1px solid #e5e7eb' }}>
                            <td style={{ padding: '10px 6px', textAlign: 'center', fontWeight: idx === 0 ? 'bold' : 'normal', textDecoration: strikeClass }}>
                              {idx === 0 ? '🏆 BEST' : idx + 1}
                            </td>
                            <td style={{ padding: '10px 6px', textAlign: 'center', fontFamily: 'IBM Plex Mono, monospace', textDecoration: strikeClass }}>{r.config.numSmallTugs}</td>
                            <td style={{ padding: '10px 6px', textAlign: 'center', fontFamily: 'IBM Plex Mono, monospace', textDecoration: strikeClass }}>{r.config.numSmallTransportBarges}</td>
                            <td style={{ padding: '10px 6px', textAlign: 'center', fontFamily: 'IBM Plex Mono, monospace', textDecoration: strikeClass }}>{r.config.numSmallStorageBarges}</td>
                            <td style={{ padding: '10px 6px', textAlign: 'center', fontFamily: 'IBM Plex Mono, monospace', textDecoration: strikeClass }}>{r.config.numLargeTransport}</td>
                            <td style={{ padding: '10px 6px', textAlign: 'center', fontFamily: 'IBM Plex Mono, monospace', textDecoration: strikeClass }}>{r.config.numLargeStorage}</td>
                            <td style={{ padding: '10px 6px', textAlign: 'right', fontFamily: 'IBM Plex Mono, monospace', textDecoration: strikeClass }}>{formatCurrency(r.costs.tugRental)}</td>
                            <td style={{ padding: '10px 6px', textAlign: 'right', fontFamily: 'IBM Plex Mono, monospace', textDecoration: strikeClass }}>{formatCurrency(r.costs.smallBargeRental)}</td>
                            <td style={{ padding: '10px 6px', textAlign: 'right', fontFamily: 'IBM Plex Mono, monospace', textDecoration: strikeClass }}>{formatCurrency(r.costs.largeBargeRental)}</td>
                            <td style={{ padding: '10px 6px', textAlign: 'right', fontFamily: 'IBM Plex Mono, monospace', textDecoration: strikeClass }}>{formatCurrency(r.costs.mobDemobBreakdown.tugs)}</td>
                            <td style={{ padding: '10px 6px', textAlign: 'right', fontFamily: 'IBM Plex Mono, monospace', textDecoration: strikeClass }}>{formatCurrency(r.costs.mobDemobBreakdown.smallBarges)}</td>
                            <td style={{ padding: '10px 6px', textAlign: 'right', fontFamily: 'IBM Plex Mono, monospace', textDecoration: strikeClass }}>{formatCurrency(r.costs.mobDemobBreakdown.largeBarges)}</td>
                            <td style={{ padding: '10px 6px', textAlign: 'right', fontFamily: 'IBM Plex Mono, monospace', textDecoration: strikeClass }}>{formatCurrency(r.costs.fuelTotal)}</td>
                            <td style={{ padding: '10px 6px', textAlign: 'right', fontFamily: 'IBM Plex Mono, monospace', textDecoration: strikeClass }}>{formatCurrency(r.costs.downtimeTotal)}</td>
                            <td style={{ padding: '10px 6px', textAlign: 'right', fontFamily: 'IBM Plex Mono, monospace', textDecoration: strikeClass }}>{formatCurrency(r.costs.waterTotal || 0)}</td>
                            <td style={{ padding: '10px 6px', textAlign: 'right', fontFamily: 'IBM Plex Mono, monospace', fontWeight: 'bold', background: '#e0f2fe', textDecoration: strikeClass }}>
                              {formatCurrency(r.costs.grandTotal)}
                            </td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
              </div>
            </FinanceCard>
          )}

          {/* 4. SENSITIVITY ANALYSIS - WHC Crimson */}
          <FinanceCard
            id="sensitivity"
            icon="📈"
            title="Sensitivity Analysis"
            subtitle="Explore how parameter changes affect costs"
            accentColor="#d94545"
          >
            <SensitivityTab />
          </FinanceCard>
        </div>
      );
    }

    // ANALYTICS TAB - Single Page Dashboard Layout
    function AnalyticsTab({ result, config }) {
      const [expandedSections, setExpandedSections] = useState({
        overview: true,
        storage: true,
        journeys: false
      });

      const toggleSection = (section) => {
        setExpandedSections(prev => ({ ...prev, [section]: !prev[section] }));
      };

      // Collapsible Section Card - Grungy Industrial Style
      const AnalyticsCard = ({ id, icon, title, subtitle, children, accentColor = '#2d9cdb' }) => (
        <div style={{
          background: 'var(--bg-white)',
          borderRadius: 'var(--btn-radius)',
          overflow: 'hidden',
          boxShadow: '3px 3px 0 var(--border-black)',
          border: '2px solid var(--border-black)',
          transition: 'all 0.3s ease'
        }}>
          <div
            onClick={() => toggleSection(id)}
            style={{
              padding: '20px 24px',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'space-between',
              cursor: 'pointer',
              background: expandedSections[id] ? 'var(--bg-light)' : 'var(--bg-white)',
              borderBottom: expandedSections[id] ? '2px solid var(--border-black)' : 'none',
              transition: 'all 0.3s ease'
            }}
          >
            <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
              <div style={{
                width: '48px',
                height: '48px',
                borderRadius: 'var(--btn-radius)',
                background: accentColor,
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                fontSize: '1.25rem',
                border: '2px solid var(--border-black)',
                boxShadow: '2px 2px 0 rgba(0, 0, 0, 0.2)'
              }}>
                {icon}
              </div>
              <div>
                <h3 style={{
                  fontSize: '1.1rem',
                  fontWeight: '400',
                  fontFamily: 'Bebas Neue, sans-serif',
                  letterSpacing: '0.05em',
                  color: 'var(--text-black)',
                  margin: 0,
                  textTransform: 'uppercase'
                }}>{title}</h3>
                <p style={{
                  fontSize: '0.75rem',
                  color: 'var(--text-medium)',
                  margin: '4px 0 0 0',
                  fontFamily: 'Work Sans, sans-serif'
                }}>{subtitle}</p>
              </div>
            </div>
            <div style={{
              width: '32px',
              height: '32px',
              borderRadius: 'var(--btn-radius)',
              background: 'var(--bg-light)',
              border: '2px solid var(--border-black)',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              transition: 'transform 0.3s ease',
              transform: expandedSections[id] ? 'rotate(180deg)' : 'rotate(0deg)'
            }}>
              <span style={{ fontSize: '0.8rem', color: 'var(--text-black)' }}>▼</span>
            </div>
          </div>
          <div style={{
            maxHeight: expandedSections[id] ? '5000px' : '0',
            overflow: 'hidden',
            transition: 'max-height 0.4s ease-in-out'
          }}>
            <div style={{ padding: '24px' }}>
              {children}
            </div>
          </div>
        </div>
      );

      return (
        <div style={{ display: 'flex', flexDirection: 'column', gap: '20px' }}>
          {/* Page Header - Grungy Style */}
          <div style={{ marginBottom: '8px' }}>
            <div style={{
              fontSize: '0.7rem',
              fontWeight: '700',
              fontFamily: 'IBM Plex Mono, monospace',
              color: 'var(--text-medium)',
              letterSpacing: '0.15em',
              textTransform: 'uppercase',
              marginBottom: '8px'
            }}>DATA ANALYTICS</div>
            <h2 style={{
              fontSize: '1.75rem',
              fontWeight: '400',
              fontFamily: 'Bebas Neue, sans-serif',
              letterSpacing: '0.05em',
              color: 'var(--text-black)',
              margin: '8px 0'
            }}>
              Performance Insights
            </h2>
            <p style={{
              color: 'var(--text-medium)',
              fontSize: '0.9rem',
              fontFamily: 'Work Sans, sans-serif'
            }}>
              Project overview charts, storage utilization, and tug journey analysis
            </p>
          </div>

          {/* Quick Stats Row - Grungy Industrial Style */}
          {result && (
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '16px', marginBottom: '8px' }}>
              <div style={{
                background: 'var(--status-green)',
                borderRadius: 'var(--btn-radius)',
                padding: '20px',
                display: 'flex',
                alignItems: 'center',
                gap: '14px',
                border: '2px solid var(--border-black)',
                boxShadow: '3px 3px 0 var(--border-black)'
              }}>
                <span style={{ fontSize: '1.75rem' }}>💧</span>
                <div>
                  <div style={{
                    fontSize: '1.5rem',
                    fontWeight: '400',
                    fontFamily: 'Bebas Neue, sans-serif',
                    letterSpacing: '0.02em',
                    color: 'white'
                  }}>
                    {((result.totalWaterDelivered || 0) / 1000000).toFixed(1)}M
                  </div>
                  <div style={{
                    fontSize: '0.7rem',
                    fontWeight: '600',
                    fontFamily: 'IBM Plex Mono, monospace',
                    color: 'rgba(255, 255, 255, 0.8)',
                    textTransform: 'uppercase',
                    letterSpacing: '0.05em'
                  }}>Gal Delivered</div>
                </div>
              </div>
              <div style={{
                background: 'var(--primary-accent)',
                borderRadius: 'var(--btn-radius)',
                padding: '20px',
                display: 'flex',
                alignItems: 'center',
                gap: '14px',
                border: '2px solid var(--border-black)',
                boxShadow: '3px 3px 0 var(--border-black)'
              }}>
                <span style={{ fontSize: '1.75rem' }}>🚤</span>
                <div>
                  <div style={{
                    fontSize: '1.5rem',
                    fontWeight: '400',
                    fontFamily: 'Bebas Neue, sans-serif',
                    letterSpacing: '0.02em',
                    color: 'white'
                  }}>
                    {result.costTracking?.totalDeliveries || '--'}
                  </div>
                  <div style={{
                    fontSize: '0.7rem',
                    fontWeight: '600',
                    fontFamily: 'IBM Plex Mono, monospace',
                    color: 'rgba(255, 255, 255, 0.8)',
                    textTransform: 'uppercase',
                    letterSpacing: '0.05em'
                  }}>Deliveries</div>
                </div>
              </div>
              <div style={{
                background: 'var(--bg-white)',
                borderRadius: 'var(--btn-radius)',
                padding: '20px',
                display: 'flex',
                alignItems: 'center',
                gap: '14px',
                border: '2px solid var(--border-black)',
                boxShadow: '3px 3px 0 var(--border-black)'
              }}>
                <span style={{ fontSize: '1.75rem' }}>⛽</span>
                <div>
                  <div style={{
                    fontSize: '1.5rem',
                    fontWeight: '400',
                    fontFamily: 'Bebas Neue, sans-serif',
                    letterSpacing: '0.02em',
                    color: 'var(--text-black)'
                  }}>
                    {Math.round((result.costTracking?.fuelUsed?.totalGallons || 0) / 1000)}K
                  </div>
                  <div style={{
                    fontSize: '0.7rem',
                    fontWeight: '600',
                    fontFamily: 'IBM Plex Mono, monospace',
                    color: 'var(--text-medium)',
                    textTransform: 'uppercase',
                    letterSpacing: '0.05em'
                  }}>Fuel (gal)</div>
                </div>
              </div>
              <div style={{
                background: 'var(--bg-white)',
                borderRadius: 'var(--btn-radius)',
                padding: '20px',
                display: 'flex',
                alignItems: 'center',
                gap: '14px',
                border: '2px solid var(--border-black)',
                boxShadow: '3px 3px 0 var(--border-black)'
              }}>
                <span style={{ fontSize: '1.75rem' }}>📊</span>
                <div>
                  <div style={{
                    fontSize: '1.5rem',
                    fontWeight: '400',
                    fontFamily: 'Bebas Neue, sans-serif',
                    letterSpacing: '0.02em',
                    color: 'var(--text-black)'
                  }}>
                    {result.dailyResults?.length || '--'}
                  </div>
                  <div style={{
                    fontSize: '0.7rem',
                    fontWeight: '600',
                    fontFamily: 'IBM Plex Mono, monospace',
                    color: 'var(--text-medium)',
                    textTransform: 'uppercase',
                    letterSpacing: '0.05em'
                  }}>Project Days</div>
                </div>
              </div>
            </div>
          )}

          {/* Collapsible Sections - Grungy Accent Colors */}
          <AnalyticsCard
            id="overview"
            icon="📊"
            title="Project Overview"
            subtitle="Demand and capacity charts"
            accentColor="#2d9cdb"
          >
            <ChartsTab result={result} config={config} />
          </AnalyticsCard>

          <AnalyticsCard
            id="storage"
            icon="🛢️"
            title="Storage Utilization"
            subtitle="HDD storage levels by crossing"
            accentColor="#22c55e"
          >
            <RigStorageTab result={result} config={config} />
          </AnalyticsCard>

          <AnalyticsCard
            id="journeys"
            icon="🚤"
            title="Tug Journeys"
            subtitle="Individual delivery analysis"
            accentColor="#d94545"
          >
            <TugJourneysTab result={result} />
          </AnalyticsCard>
        </div>
      );
    }

    // ============================================================================
    // MAIN APP COMPONENT
    // ============================================================================
    function App() {
      const [config, setConfig] = useState(defaultConfig);
      const [activeTab, setActiveTab] = useState('executive');
      const [result, setResult] = useState(null);
      const [optimizationResults, setOptimizationResults] = useState(null);
      const [analyticalFleetResult, setAnalyticalFleetResult] = useState(null);
      const [isRunning, setIsRunning] = useState(false);
      const [isAnalyzing, setIsAnalyzing] = useState(false);
      const [progress, setProgress] = useState(null);
      const [isOptimized, setIsOptimized] = useState(false);
      const [isStale, setIsStale] = useState(false);
      const [lastSimulatedConfigHash, setLastSimulatedConfigHash] = useState(null);
      const workerRef = useRef(null);

      // Asset Log filter state (lifted up to persist across tab changes)
      const [assetLogFilters, setAssetLogFilters] = useState({
        filters: { assetType: [], assetId: [], status: [], location: [], usage: [] },
        search: '',
        dateRange: { start: '', end: '' },
        sortConfig: { key: 'timestamp', direction: 'asc' },
        currentPage: 1,
        pageSize: 100
      });

      // Initialize worker
      useEffect(() => {
        workerRef.current = new Worker('simulation-worker.js?v=20260204-whc-palette');
        workerRef.current.onmessage = (e) => {
          const data = e.data;
          if (data.type === 'progress') {
            // Normalize progress data from different sources
            let normalizedProgress = { type: 'progress' };
            if (data.percent !== undefined) {
              // Standard format (from single simulation)
              normalizedProgress.currentConfig = data.currentConfig || 'Running...';
              normalizedProgress.percent = data.percent;
            } else if (data.iteration !== undefined) {
              // Optimizer format - convert to standard format
              const maxIterations = 50;
              const estimatedPercent = Math.min(95, Math.round((data.iteration / maxIterations) * 100));
              normalizedProgress.currentConfig = `Iteration ${data.iteration}: Testing ${data.testLabel || data.testingConfig || 'config'} (${data.tested} configs tested)`;
              normalizedProgress.percent = estimatedPercent;
            } else if (data.tested !== undefined) {
              // Find working fleet format
              normalizedProgress.currentConfig = data.testingConfig || `Tested ${data.tested} configurations...`;
              normalizedProgress.percent = Math.min(90, Math.round(data.tested * 2));
            } else {
              // Fallback
              normalizedProgress.currentConfig = data.currentConfig || 'Processing...';
              normalizedProgress.percent = data.percent || 0;
            }
            setProgress(normalizedProgress);
          } else if (data.type === 'singleResult') {
            setResult(data.result);
            window.lastSimulationResult = data.result; // Expose for debugging
            // Config hash was already stored when simulation started
            setIsStale(false);
            setIsRunning(false);
            setProgress(null);
          } else if (data.type === 'workingFleetFound') {
            if (data.result.success) {
              const newConfig = {
                ...config,
                numSmallTugs: data.result.config.numSmallTugs,
                numSmallTransportBarges: data.result.config.numSmallTransportBarges,
                numSmallStorageBarges: data.result.config.numSmallStorageBarges,
                numLargeTransport: data.result.config.numLargeTransport,
                numLargeStorage: data.result.config.numLargeStorage
              };
              setConfig(newConfig);
              setLastSimulatedConfigHash(JSON.stringify(newConfig));

              console.log('[WORKING FLEET] Found fleet:', {
                tugs: newConfig.numSmallTugs,
                smallTransport: newConfig.numSmallTransportBarges,
                smallStorage: newConfig.numSmallStorageBarges,
                largeTransport: newConfig.numLargeTransport,
                largeStorage: newConfig.numLargeStorage
              });

              // If this is initial load, automatically run a full simulation
              if (!initialLoadComplete) {
                console.log('[AUTO-RUN] Running final simulation with working fleet...');
                setProgress({ type: 'progress', percent: 0, currentConfig: 'Running final simulation...' });

                const userConfig = {
                  ...newConfig,
                  hddSchedule: convertScheduleToDate(newConfig.hddSchedule),
                  COST: {
                    tug: { dayRate: newConfig.TUG_DAY_RATE, fuelIdleGPH: newConfig.TUG_FUEL_IDLE_GPH, fuelRunningGPH: newConfig.TUG_FUEL_RUNNING_GPH },
                    barge: { smallDayRate: newConfig.SMALL_BARGE_DAY_RATE, largeDayRate: newConfig.LARGE_BARGE_DAY_RATE },
                    fuel: { pricePerGal: newConfig.FUEL_PRICE_PER_GAL },
                    downtime: { hourlyRate: newConfig.DOWNTIME_HOURLY_RATE },
                    waterAcquisition: {
                      source1: newConfig.WATER_COST_SOURCE1,
                      source2: newConfig.WATER_COST_SOURCE2,
                      source3: newConfig.WATER_COST_SOURCE3
                    },
                    mobilization: {
                      tugMobCost: newConfig.TUG_MOB_COST,
                      tugDemobCost: newConfig.TUG_DEMOB_COST,
                      smallBargeMobCost: newConfig.SMALL_BARGE_DAY_RATE * newConfig.BARGE_MOB_DEMOB_COST_DAYS,
                      smallBargeDemobCost: newConfig.SMALL_BARGE_DAY_RATE * newConfig.BARGE_MOB_DEMOB_COST_DAYS,
                      largeBargeMobCost: newConfig.LARGE_BARGE_DAY_RATE * newConfig.BARGE_MOB_DEMOB_COST_DAYS,
                      largeBargeDemobCost: newConfig.LARGE_BARGE_DAY_RATE * newConfig.BARGE_MOB_DEMOB_COST_DAYS
                    }
                  }
                };

                const fleetConfig = {
                  numSmallTugs: newConfig.numSmallTugs,
                  numSmallTransportBarges: newConfig.numSmallTransportBarges,
                  numSmallStorageBarges: newConfig.numSmallStorageBarges,
                  numLargeTransport: newConfig.numLargeTransport,
                  numLargeStorage: newConfig.numLargeStorage
                };

                workerRef.current.postMessage({ type: 'runSingle', fleetConfig, userConfig });
                // Note: setIsRunning stays true, will be set to false when simulation completes
              } else {
                // Manual fleet finder run - just show the result
                setResult(data.result.result);
                setIsStale(false);
                setIsRunning(false);
                setProgress(null);
              }
            } else {
              alert(data.result.error || 'Could not find working fleet configuration');
              setIsRunning(false);
              setProgress(null);
            }
          } else if (data.type === 'optimizeResult') {
            setOptimizationResults(data.result);
            if (data.result.error) {
              // Optimization failed - display error to user
              alert('Optimization Error: ' + data.result.error);
              console.error('[OPTIMIZER] Error:', data.result.error);
              setIsRunning(false);
              setProgress(null);
            } else if (data.result.optimal) {
              // Update config with optimized fleet
              const newConfig = {
                ...config,
                numSmallTugs: data.result.optimal.config.numSmallTugs,
                numSmallTransportBarges: data.result.optimal.config.numSmallTransportBarges,
                numSmallStorageBarges: data.result.optimal.config.numSmallStorageBarges,
                numLargeTransport: data.result.optimal.config.numLargeTransport,
                numLargeStorage: data.result.optimal.config.numLargeStorage
              };
              setConfig(newConfig);
              setIsOptimized(true);

              // Automatically run simulation with optimized config
              setProgress({ type: 'progress', percent: 0, currentConfig: 'Running simulation with optimized fleet...' });
              setLastSimulatedConfigHash(JSON.stringify(newConfig));

              const userConfig = {
                ...newConfig,
                hddSchedule: convertScheduleToDate(newConfig.hddSchedule),
                COST: {
                  tug: { dayRate: newConfig.TUG_DAY_RATE, fuelIdleGPH: newConfig.TUG_FUEL_IDLE_GPH, fuelRunningGPH: newConfig.TUG_FUEL_RUNNING_GPH },
                  barge: { smallDayRate: newConfig.SMALL_BARGE_DAY_RATE, largeDayRate: newConfig.LARGE_BARGE_DAY_RATE },
                  fuel: { pricePerGal: newConfig.FUEL_PRICE_PER_GAL },
                  downtime: { hourlyRate: newConfig.DOWNTIME_HOURLY_RATE },
                  waterAcquisition: {
                    source1: newConfig.WATER_COST_SOURCE1,
                    source2: newConfig.WATER_COST_SOURCE2,
                    source3: newConfig.WATER_COST_SOURCE3
                  },
                  mobilization: {
                    tugMobCost: newConfig.TUG_MOB_COST,
                    tugDemobCost: newConfig.TUG_DEMOB_COST,
                    smallBargeMobCost: newConfig.SMALL_BARGE_DAY_RATE * newConfig.BARGE_MOB_DEMOB_COST_DAYS,
                    smallBargeDemobCost: newConfig.SMALL_BARGE_DAY_RATE * newConfig.BARGE_MOB_DEMOB_COST_DAYS,
                    largeBargeMobCost: newConfig.LARGE_BARGE_DAY_RATE * newConfig.BARGE_MOB_DEMOB_COST_DAYS,
                    largeBargeDemobCost: newConfig.LARGE_BARGE_DAY_RATE * newConfig.BARGE_MOB_DEMOB_COST_DAYS
                  }
                }
              };

              const fleetConfig = {
                numSmallTugs: newConfig.numSmallTugs,
                numSmallTransportBarges: newConfig.numSmallTransportBarges,
                numSmallStorageBarges: newConfig.numSmallStorageBarges,
                numLargeTransport: newConfig.numLargeTransport,
                numLargeStorage: newConfig.numLargeStorage
              };

              workerRef.current.postMessage({ type: 'runSingle', fleetConfig, userConfig });
              // Note: setIsRunning stays true, will be set to false when simulation completes
              if (!data.result.error) setActiveTab('executive');
            }
          } else if (data.type === 'analyticalFleetResult') {
            setAnalyticalFleetResult(data.result);
            setIsAnalyzing(false);
          } else if (data.type === 'error') {
            console.error('[UI] Worker error:', data.message);
            setIsRunning(false);
            setIsAnalyzing(false);
            setProgress(null);
            alert('Error: ' + data.message);
          }
        };

        return () => {
          workerRef.current?.terminate();
        };
      }, []);

      // Detect config changes that invalidate results
      // Note: initialLoadComplete is defined later, so we use a ref to track it
      const initialLoadCompleteRef = useRef(false);

      useEffect(() => {
        if (!result || !lastSimulatedConfigHash) {
          return;
        }

        const currentConfigHash = JSON.stringify(config);
        const configChanged = currentConfigHash !== lastSimulatedConfigHash;

        // Show stale warning if config changed, not optimized, and initial load is done
        // Don't show stale during initial load sequence
        setIsStale(configChanged && !isOptimized && initialLoadCompleteRef.current);
      }, [config, result, lastSimulatedConfigHash, isOptimized]);

      // Run single simulation with current fleet configuration
      const runSimulation = useCallback(() => {
        if (!workerRef.current) return;

        console.log('[SIMULATION] Starting with fleet:', {
          tugs: config.numSmallTugs,
          smallTransport: config.numSmallTransportBarges,
          smallStorage: config.numSmallStorageBarges,
          largeTransport: config.numLargeTransport,
          largeStorage: config.numLargeStorage
        });

        setIsRunning(true);
        setIsOptimized(false);
        setIsStale(false);
        setProgress({ type: 'progress', percent: 0, currentConfig: 'Running simulation...' });

        // Store the config hash NOW before sending to worker
        // This captures the exact config being simulated
        setLastSimulatedConfigHash(JSON.stringify(config));

        const userConfig = {
          ...config,
          hddSchedule: convertScheduleToDate(config.hddSchedule),
          COST: {
            tug: { dayRate: config.TUG_DAY_RATE, fuelIdleGPH: config.TUG_FUEL_IDLE_GPH, fuelRunningGPH: config.TUG_FUEL_RUNNING_GPH },
            barge: { smallDayRate: config.SMALL_BARGE_DAY_RATE, largeDayRate: config.LARGE_BARGE_DAY_RATE },
            fuel: { pricePerGal: config.FUEL_PRICE_PER_GAL },
            downtime: { hourlyRate: config.DOWNTIME_HOURLY_RATE },
            waterAcquisition: {
              source1: config.WATER_COST_SOURCE1,
              source2: config.WATER_COST_SOURCE2,
              source3: config.WATER_COST_SOURCE3
            },
            mobilization: {
              tugMobCost: config.TUG_MOB_COST,
              tugDemobCost: config.TUG_DEMOB_COST,
              smallBargeMobCost: config.SMALL_BARGE_DAY_RATE * config.BARGE_MOB_DEMOB_COST_DAYS,
              smallBargeDemobCost: config.SMALL_BARGE_DAY_RATE * config.BARGE_MOB_DEMOB_COST_DAYS,
              largeBargeMobCost: config.LARGE_BARGE_DAY_RATE * config.BARGE_MOB_DEMOB_COST_DAYS,
              largeBargeDemobCost: config.LARGE_BARGE_DAY_RATE * config.BARGE_MOB_DEMOB_COST_DAYS
            }
          }
        };

        const fleetConfig = {
          numSmallTugs: config.numSmallTugs,
          numSmallTransportBarges: config.numSmallTransportBarges,
          numSmallStorageBarges: config.numSmallStorageBarges,
          numLargeTransport: config.numLargeTransport,
          numLargeStorage: config.numLargeStorage
        };

        workerRef.current.postMessage({ type: 'runSingle', fleetConfig, userConfig });
      }, [config]);

      // Run local optimization
      const runOptimization = useCallback(() => {
        if (!workerRef.current) return;

        // Check if we have a result
        if (!result) {
          alert('Please run a simulation first before optimizing.');
          return;
        }

        setIsRunning(true);
        setProgress({ type: 'progress', percent: 0, currentConfig: 'Optimizing fleet configuration...' });

        const baseFleetConfig = {
          numSmallTugs: config.numSmallTugs,
          numSmallTransportBarges: config.numSmallTransportBarges,
          numSmallStorageBarges: config.numSmallStorageBarges,
          numLargeTransport: config.numLargeTransport,
          numLargeStorage: config.numLargeStorage
        };

        const userConfig = {
          ...config,
          hddSchedule: convertScheduleToDate(config.hddSchedule),
          COST: {
            tug: { dayRate: config.TUG_DAY_RATE, fuelIdleGPH: config.TUG_FUEL_IDLE_GPH, fuelRunningGPH: config.TUG_FUEL_RUNNING_GPH },
            barge: { smallDayRate: config.SMALL_BARGE_DAY_RATE, largeDayRate: config.LARGE_BARGE_DAY_RATE },
            fuel: { pricePerGal: config.FUEL_PRICE_PER_GAL },
            downtime: { hourlyRate: config.DOWNTIME_HOURLY_RATE },
            waterAcquisition: {
              source1: config.WATER_COST_SOURCE1,
              source2: config.WATER_COST_SOURCE2,
              source3: config.WATER_COST_SOURCE3
            },
            mobilization: {
              tugMobCost: config.TUG_MOB_COST,
              tugDemobCost: config.TUG_DEMOB_COST,
              smallBargeMobCost: config.SMALL_BARGE_DAY_RATE * config.BARGE_MOB_DEMOB_COST_DAYS,
              smallBargeDemobCost: config.SMALL_BARGE_DAY_RATE * config.BARGE_MOB_DEMOB_COST_DAYS,
              largeBargeMobCost: config.LARGE_BARGE_DAY_RATE * config.BARGE_MOB_DEMOB_COST_DAYS,
              largeBargeDemobCost: config.LARGE_BARGE_DAY_RATE * config.BARGE_MOB_DEMOB_COST_DAYS
            }
          }
        };

        workerRef.current.postMessage({ type: 'runLocalOptimize', fleetConfig: baseFleetConfig, userConfig });
      }, [config, result]);

      // Run analytical fleet sizing (pre-simulation analysis)
      const runAnalyticalFleetSizing = useCallback(() => {
        if (!workerRef.current) return;
        setIsAnalyzing(true);

        const userConfig = {
          ...config,
          hddSchedule: convertScheduleToDate(config.hddSchedule),
          COST: {
            tug: { dayRate: config.TUG_DAY_RATE, fuelIdleGPH: config.TUG_FUEL_IDLE_GPH, fuelRunningGPH: config.TUG_FUEL_RUNNING_GPH },
            barge: { smallDayRate: config.SMALL_BARGE_DAY_RATE, largeDayRate: config.LARGE_BARGE_DAY_RATE },
            fuel: { pricePerGal: config.FUEL_PRICE_PER_GAL },
            downtime: { hourlyRate: config.DOWNTIME_HOURLY_RATE },
            waterAcquisition: {
              source1: config.WATER_COST_SOURCE1,
              source2: config.WATER_COST_SOURCE2,
              source3: config.WATER_COST_SOURCE3
            },
            mobilization: {
              tugMobCost: config.TUG_MOB_COST,
              tugDemobCost: config.TUG_DEMOB_COST,
              smallBargeMobCost: config.SMALL_BARGE_DAY_RATE * config.BARGE_MOB_DEMOB_COST_DAYS,
              smallBargeDemobCost: config.SMALL_BARGE_DAY_RATE * config.BARGE_MOB_DEMOB_COST_DAYS,
              largeBargeMobCost: config.LARGE_BARGE_DAY_RATE * config.BARGE_MOB_DEMOB_COST_DAYS,
              largeBargeDemobCost: config.LARGE_BARGE_DAY_RATE * config.BARGE_MOB_DEMOB_COST_DAYS
            }
          }
        };

        workerRef.current.postMessage({ type: 'analyzeFleet', userConfig });
      }, [config]);

      // Apply recommended fleet configuration from analytical sizing
      const applyRecommendedFleet = useCallback(() => {
        if (!analyticalFleetResult?.recommendedFleetConfig) return;
        const rec = analyticalFleetResult.recommendedFleetConfig;
        setConfig(prev => ({
          ...prev,
          numSmallTugs: rec.numSmallTugs,
          numSmallTransportBarges: rec.numSmallTransportBarges,
          numSmallStorageBarges: rec.numSmallStorageBarges,
          numLargeTransport: rec.numLargeTransport,
          numLargeStorage: rec.numLargeStorage
        }));
      }, [analyticalFleetResult]);

      // Run iterative fleet finder - starts from analytical recommendation and modifies
      // overrideFleetConfig allows passing fleet config directly to avoid stale state issues
      const runIterativeFleetFinder = useCallback((overrideFleetConfig = null) => {
        if (!workerRef.current) return;
        setIsRunning(true);
        setProgress({ type: 'progress', percent: 0, currentConfig: 'Finding working fleet (iterative)...' });

        // Use override fleet config if provided, otherwise use current config state
        const fleetConfig = overrideFleetConfig || config;
        console.log('[ITERATIVE FINDER] Using fleet config:', {
          tugs: fleetConfig.numSmallTugs,
          smallTransport: fleetConfig.numSmallTransportBarges,
          smallStorage: fleetConfig.numSmallStorageBarges,
          largeTransport: fleetConfig.numLargeTransport,
          largeStorage: fleetConfig.numLargeStorage
        });

        const userConfig = {
          ...config,
          ...overrideFleetConfig, // Override fleet sizes if provided
          hddSchedule: convertScheduleToDate(config.hddSchedule),
          COST: {
            tug: { dayRate: config.TUG_DAY_RATE, fuelIdleGPH: config.TUG_FUEL_IDLE_GPH, fuelRunningGPH: config.TUG_FUEL_RUNNING_GPH },
            barge: { smallDayRate: config.SMALL_BARGE_DAY_RATE, largeDayRate: config.LARGE_BARGE_DAY_RATE },
            fuel: { pricePerGal: config.FUEL_PRICE_PER_GAL },
            downtime: { hourlyRate: config.DOWNTIME_HOURLY_RATE },
            waterAcquisition: {
              source1: config.WATER_COST_SOURCE1,
              source2: config.WATER_COST_SOURCE2,
              source3: config.WATER_COST_SOURCE3
            },
            mobilization: {
              tugMobCost: config.TUG_MOB_COST,
              tugDemobCost: config.TUG_DEMOB_COST,
              smallBargeMobCost: config.SMALL_BARGE_DAY_RATE * config.BARGE_MOB_DEMOB_COST_DAYS,
              smallBargeDemobCost: config.SMALL_BARGE_DAY_RATE * config.BARGE_MOB_DEMOB_COST_DAYS,
              largeBargeMobCost: config.LARGE_BARGE_DAY_RATE * config.BARGE_MOB_DEMOB_COST_DAYS,
              largeBargeDemobCost: config.LARGE_BARGE_DAY_RATE * config.BARGE_MOB_DEMOB_COST_DAYS
            }
          }
        };

        // Pass the analytical recommendation as starting point
        const startingFleet = analyticalFleetResult?.recommendedFleetConfig || null;
        workerRef.current.postMessage({ type: 'findWorkingFleet', userConfig, startingFleet });
      }, [config, analyticalFleetResult]);

      // Track if initial load analysis is complete
      const [initialLoadComplete, setInitialLoadComplete] = useState(false);
      const hasTriggeredFleetFinder = useRef(false); // Track if we've already triggered the fleet finder

      // Sync initialLoadComplete state to ref for stale detection
      useEffect(() => {
        if (initialLoadComplete && result) {
          // Only mark as truly complete after first simulation result arrives
          initialLoadCompleteRef.current = true;
        }
      }, [initialLoadComplete, result]);

      // Auto-run analytical fleet sizing on app load, then simulation
      useEffect(() => {
        if (workerRef.current && !analyticalFleetResult && !isAnalyzing && !initialLoadComplete) {
          const timer = setTimeout(() => {
            console.log('[AUTO-RUN] Starting analytical fleet sizing...');
            runAnalyticalFleetSizing();
          }, 300);
          return () => clearTimeout(timer);
        }
      }, [workerRef.current, analyticalFleetResult, isAnalyzing, initialLoadComplete, runAnalyticalFleetSizing]);

      // When analytical result arrives on initial load, apply recommendation and run iterative fleet finder
      useEffect(() => {
        if (analyticalFleetResult?.success && !hasTriggeredFleetFinder.current && !result && !isRunning) {
          hasTriggeredFleetFinder.current = true; // Mark as triggered to prevent double-trigger

          // Apply the analytical recommendation to the config
          const rec = analyticalFleetResult.recommendedFleetConfig;
          console.log('[AUTO-RUN] Analytical fleet result received:', rec);
          console.log('[AUTO-RUN] Fleet config:', {
            tugs: rec.numSmallTugs,
            smallTransport: rec.numSmallTransportBarges,
            smallStorage: rec.numSmallStorageBarges,
            largeTransport: rec.numLargeTransport,
            largeStorage: rec.numLargeStorage
          });

          setConfig(prev => ({
            ...prev,
            numSmallTugs: rec.numSmallTugs,
            numSmallTransportBarges: rec.numSmallTransportBarges,
            numSmallStorageBarges: rec.numSmallStorageBarges,
            numLargeTransport: rec.numLargeTransport,
            numLargeStorage: rec.numLargeStorage
          }));

          setInitialLoadComplete(true);

          // Run iterative finder which will find a working config (0 ran dry)
          // Pass the analytical fleet config directly to avoid stale state issues
          setTimeout(() => {
            console.log('[AUTO-RUN] Starting iterative fleet finder with analytical config...');
            runIterativeFleetFinder(rec);
          }, 100);
        }
      }, [analyticalFleetResult, result, isRunning, runIterativeFleetFinder]);

      return (
        <div className="min-h-screen">
          {/* Fixed Left Sidebar */}
          <LeftSidebar
            config={config}
            setConfig={setConfig}
            runSimulation={runSimulation}
            isRunning={isRunning}
            runAnalyticalFleetSizing={runAnalyticalFleetSizing}
            isAnalyzing={isAnalyzing}
            analyticalFleetResult={analyticalFleetResult}
            applyRecommendedFleet={applyRecommendedFleet}
            runIterativeFleetFinder={runIterativeFleetFinder}
            isStale={isStale}
            result={result}
            progress={progress}
          />

          {/* Fixed Top Metrics Bar */}
          <MetricsBar result={result} config={config} isOptimized={isOptimized} activeTab={activeTab} setActiveTab={setActiveTab} />

          {/* Main Content - W3Admin Style */}
          <div className="main-content" style={{ paddingTop: '220px' }}>
            {/* Tab Content - Consolidated Views */}
            <div className={activeTab === 'operations' ? '' : 'p-6'}>
              {/* EXECUTIVE SUMMARY - Bid-Winning Overview */}
              {activeTab === 'executive' && (
                <div className="w3-card animate-fade-up" style={{ margin: '0 24px' }}>
                  <ExecutiveSummaryTab result={result} config={config} />
                </div>
              )}

              {/* OPERATIONS - Animation Front & Center */}
              {activeTab === 'operations' && <OperationsTab result={result} config={config} />}

              {/* PLANNING - Rig Inputs + Mobilization */}
              {activeTab === 'planning' && (
                <div className="w3-card animate-fade-up" style={{ margin: '0 24px' }}>
                  <PlanningTab result={result} config={config} setConfig={setConfig} />
                </div>
              )}

              {/* FINANCIALS - Cost Model + Sensitivity */}
              {activeTab === 'financials' && (
                <div className="w3-card animate-fade-up" style={{ margin: '0 24px' }}>
                  <FinancialsTab result={result} optimizationResults={optimizationResults} config={config} setConfig={setConfig} runOptimization={runOptimization} isRunning={isRunning} />
                </div>
              )}

              {/* ANALYTICS - Charts + Storage + Journeys */}
              {activeTab === 'analytics' && (
                <div className="w3-card animate-fade-up" style={{ margin: '0 24px' }}>
                  <AnalyticsTab result={result} config={config} />
                </div>
              )}

              {/* LOG - Asset Event Log */}
              {activeTab === 'log' && (
                <div className="w3-card animate-fade-up" style={{ margin: '0 24px' }}>
                  <AssetLogTab result={result} filterState={assetLogFilters} setFilterState={setAssetLogFilters} />
                </div>
              )}
            </div>
          </div>
        </div>
      );
    }

    // Render the app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
